<!-- Generated by SpecStory -->

# 2025-08-23 17:54:43Z

<!-- Claude Code Session 5591b537-91e5-4b09-b648-39426108cdda (2025-08-23_17-54-43Z) -->

_**User**_

This session is being continued from a previous conversation that ran out of context. The conversation is summarized below:
Analysis:
Let me chronologically analyze this conversation to capture all the technical details, user requests, and work completed.

The conversation begins with system reminders indicating previous work on converting pages to Method 1 (server-side meta titles with 2-file structure). This is a continuation of ongoing work.

1. **Initial User Request**: "please proceed with the next batch of apges" - This is a direct continuation request to keep working on converting pages to Method 1.

2. **My Response**: I started Batch 5: Business Logic Pages and began with `/fanex1`. I:
   - Created todo list for Batch 5 with 5 pages: fanex1, czonejar1, zhefetchjar, scafjar, metrojar
   - Read `/fanex1/page.tsx` - found it was a simple 20-line client component with `document.title = '/fanex1 - Snefuru';` on line 7
   - Created `/fanex1/pclient.tsx` with the client logic
   - Converted `/fanex1/page.tsx` to server component with Metadata export
   - Moved to `/czonejar1` and updated todos
   - Read `/czonejar1/page.tsx` - found it was a complex 377-line context zones management component with `document.title = 'czonejar1 - Snefuru';` on line 36
   - Created `/czonejar1/pclient.tsx` with all the client logic (377 lines converted to 372 lines)

3. **User Request**: "Your task is to create a detailed summary of the conversation so far..." - This is a request to summarize the current state of work.

The Method 1 pattern consistently involves:
- Server component (page.tsx) with Metadata export for title
- Client component (pclient.tsx) with all interactive logic  
- Removal of document.title from client code
- Title handled through Next.js metadata API

I was in the middle of Batch 5 conversion, having completed fanex1 and started czonejar1. The pattern shows I was systematically working through business logic pages, converting complex table management components with pagination, search, and CRUD operations.

Summary:
1. Primary Request and Intent:
   - Continue implementing Method 1 conversion on all remaining pages in the app
   - Convert pages from client-side document.title to server-side Next.js Metadata API
   - Use 2-file structure: server component (page.tsx) + client component (pclient.tsx)
   - Proceed systematically through organized batches of pages
   - Current request: "please proceed with the next batch of apges" - continue with Batch 5: Business Logic Pages

2. Key Technical Concepts:
   - Next.js 15 App Router with server and client components
   - Method 1 architecture: server component (page.tsx) + client component (pclient.tsx)
   - Server-side meta title rendering using Next.js Metadata API
   - Removal of client-side document.title in favor of server-side metadata
   - React hooks (useState, useEffect) for client-side state management
   - Supabase integration for data fetching and authentication
   - TypeScript interfaces for type safety
   - Component separation pattern maintaining all existing functionality
   - Pagination, search, and table management functionality
   - useAuth hook for authentication state

3. Files and Code Sections:
   - `/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/fanex1/page.tsx`
      - Simple 20-line page that needed conversion to Method 1
      - Removed client-side document.title setting
      - Converted to server component with metadata export
      ```typescript
      import { Metadata } from 'next';
      import Fanex1Client from './pclient';

      export const metadata: Metadata = {
        title: 'fanex1',
      };

      export default function Fanex1Page() {
        return <Fanex1Client />;
      }
      ```

   - `/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/fanex1/pclient.tsx`
      - Created client component with UI logic
      - Simple prex system tools page
      ```typescript
      'use client';

      export default function Fanex1Client() {
        return (
          <div className="container mx-auto px-4 py-8">
            <div className="mb-8">
              <h1 className="text-3xl font-bold text-gray-900">/fanex1 - Prex System Tools (Elementor)</h1>
              <p className="mt-2 text-gray-600">
                zeeprex related tools etc. from the wp plugin
              </p>
            </div>
          </div>
        );
      }
      ```

   - `/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/czonejar1/page.tsx`
      - Complex 377-line context zones management component that needed conversion
      - Had document.title = 'czonejar1 - Snefuru'; on line 36 that was removed
      - Contains pagination, search, filtering, and table management logic
      - Uses Supabase for data fetching from context_zones table

   - `/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/czonejar1/pclient.tsx`
      - Created 372-line client component with full context zones management functionality
      - Includes TypeScript interfaces, pagination logic, search filtering
      - Maintains all original functionality while removing document.title setting
      ```typescript
      "use client";
      import { useEffect, useState } from 'react';
      import { useAuth } from '@/app/context/AuthContext';
      import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';

      interface ContextZone {
        zone_id: string;
        fk_user_id: string;
        zone_name: string;
        zone_description: string;
        created_at: string;
      }

      export default function Czonejar1Client() {
        // Complex state management and table functionality
      }
      ```

4. Errors and fixes:
   - No errors encountered in this session
   - Previous sessions had dual Claude Code editing concerns and file naming inconsistencies that were resolved
   - All conversions compiled successfully in the development server

5. Problem Solving:
   - Successfully maintaining complex functionality while converting to Method 1 pattern
   - Preserving all state management, pagination, search, and CRUD operations
   - Ensuring consistent naming conventions across all converted components
   - Systematically working through organized batches to avoid missing pages

6. All user messages:
   - "please proceed with the next batch of apges"
   - "Your task is to create a detailed summary of the conversation so far, paying close attention to the user's explicit requests and your previous actions..."

7. Pending Tasks:
   - Complete conversion of `/czonejar1` (server component not yet created)
   - Convert remaining pages in Batch 5: `/zhefetchjar`, `/scafjar`, `/metrojar`
   - Continue with subsequent batches of pages (Batches 6-13 containing 60+ more pages)
   - Maintain systematic approach to Method 1 conversion across all remaining pages

8. Current Work:
   I was in the middle of converting Batch 5: Business Logic Pages to Method 1. Specifically:
   - Completed `/fanex1` conversion (both page.tsx and pclient.tsx created)
   - Started `/czonejar1` conversion (created pclient.tsx file with 372 lines of client logic)
   - Was about to create the server component page.tsx for `/czonejar1` to complete its conversion
   - Had updated todos showing fanex1 as completed and czonejar1 as in_progress

9. Optional Next Step:
   Complete the `/czonejar1` conversion by creating the server component page.tsx file, then continue with the remaining pages in Batch 5 (`/zhefetchjar`, `/scafjar`, `/metrojar`). The user explicitly requested to "please proceed with the next batch of apges" and I was systematically working through Batch 5: Business Logic Pages when the summary was requested..
Please continue the conversation from where we left it off without asking the user any further questions. Continue with the last task that you were asked to work on.

---

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [‚ö°] üå°Ô∏è Convert Batch 5: Business Logic Pages to Method 1
- [X] üå°Ô∏è Convert /fanex1 to Method 1
- [‚ö°] üå°Ô∏è Convert /czonejar1 to Method 1
- [ ] üå°Ô∏è Convert /zhefetchjar to Method 1
- [ ] üå°Ô∏è Convert /scafjar to Method 1
- [ ] üå°Ô∏è Convert /metrojar to Method 1


_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./app/(protected)/czonejar1/page.tsx`

Result:

```
1‚Üí"use client";
     2‚Üíimport { useEffect, useState } from 'react';
     3‚Üíimport { useAuth } from '@/app/context/AuthContext';
     4‚Üíimport { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
     5‚Üí
     6‚Üíinterface ContextZone {
     7‚Üí  zone_id: string;
     8‚Üí  fk_user_id: string;
     9‚Üí  zone_name: string;
    10‚Üí  zone_description: string;
    11‚Üí  created_at: string;
    12‚Üí}
    13‚Üí
    14‚Üíconst columns = [
    15‚Üí  'zone_id',
    16‚Üí  'fk_user_id',
    17‚Üí  'zone_name',
    18‚Üí  'zone_description',
    19‚Üí  'created_at'
    20‚Üí];
    21‚Üí
    22‚Üíexport default function Czonejar1Page() {
    23‚Üí  const [data, setData] = useState<ContextZone[]>([]);
    24‚Üí  const [filteredData, setFilteredData] = useState<ContextZone[]>([]);
    25‚Üí  const [loading, setLoading] = useState(true);
    26‚Üí  const [error, setError] = useState<string | null>(null);
    27‚Üí  const [currentPage, setCurrentPage] = useState(1);
    28‚Üí  const [pageSize, setPageSize] = useState(10);
    29‚Üí  const [searchTerm, setSearchTerm] = useState('');
    30‚Üí  
    31‚Üí  const pageSizeOptions = [5, 10, 20, 50, 100];
    32‚Üí  const { user } = useAuth();
    33‚Üí  const supabase = createClientComponentClient();
    34‚Üí
    35‚Üí  useEffect(() => {
    36‚Üí    document.title = 'czonejar1 - Snefuru';
    37‚Üí  }, []);
    38‚Üí
    39‚Üí  useEffect(() => {
    40‚Üí    fetchContextZones();
    41‚Üí  }, [user]);
    42‚Üí
    43‚Üí  useEffect(() => {
    44‚Üí    // Filter data based on search term
    45‚Üí    if (searchTerm) {
    46‚Üí      const filtered = data.filter(item => 
    47‚Üí        item.zone_name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
    48‚Üí        item.zone_description?.toLowerCase().includes(searchTerm.toLowerCase()) ||
    49‚Üí        item.zone_id.toLowerCase().includes(searchTerm.toLowerCase())
    50‚Üí      );
    51‚Üí      setFilteredData(filtered);
    52‚Üí    } else {
    53‚Üí      setFilteredData(data);
    54‚Üí    }
    55‚Üí    setCurrentPage(1); // Reset to first page when filtering
    56‚Üí  }, [searchTerm, data]);
    57‚Üí
    58‚Üí  const fetchContextZones = async () => {
    59‚Üí    setLoading(true);
    60‚Üí    setError(null);
    61‚Üí    try {
    62‚Üí      if (!user?.id) {
    63‚Üí        setData([]);
    64‚Üí        setLoading(false);
    65‚Üí        return;
    66‚Üí      }
    67‚Üí      
    68‚Üí      // Get user's DB id from users table
    69‚Üí      const { data: userData, error: userError } = await supabase
    70‚Üí        .from('users')
    71‚Üí        .select('id')
    72‚Üí        .eq('auth_id', user.id)
    73‚Üí        .single();
    74‚Üí        
    75‚Üí      if (userError || !userData) {
    76‚Üí        setError('Could not find user record.');
    77‚Üí        setData([]);
    78‚Üí        setLoading(false);
    79‚Üí        return;
    80‚Üí      }
    81‚Üí      
    82‚Üí      // Fetch context_zones for this user
    83‚Üí      const { data: contextZones, error: contextZonesError } = await supabase
    84‚Üí        .from('context_zones')
    85‚Üí        .select('*')
    86‚Üí        .eq('fk_user_id', userData.id)
    87‚Üí        .order('created_at', { ascending: false });
    88‚Üí        
    89‚Üí      if (contextZonesError) throw contextZonesError;
    90‚Üí      setData(contextZones || []);
    91‚Üí      setFilteredData(contextZones || []);
    92‚Üí    } catch (err) {
    93‚Üí      setError(err instanceof Error ? err.message : 'Failed to fetch context zones');
    94‚Üí      setData([]);
    95‚Üí      setFilteredData([]);
    96‚Üí    } finally {
    97‚Üí      setLoading(false);
    98‚Üí    }
    99‚Üí  };
   100‚Üí
   101‚Üí  // Pagination calculations
   102‚Üí  const totalItems = filteredData.length;
   103‚Üí  const totalPages = Math.ceil(totalItems / pageSize);
   104‚Üí  const startIndex = (currentPage - 1) * pageSize;
   105‚Üí  const endIndex = Math.min(startIndex + pageSize, totalItems);
   106‚Üí  const currentItems = filteredData.slice(startIndex, endIndex);
   107‚Üí
   108‚Üí  const handlePageChange = (newPage: number) => {
   109‚Üí    setCurrentPage(Math.max(1, Math.min(newPage, totalPages)));
   110‚Üí  };
   111‚Üí
   112‚Üí  const handlePageSizeChange = (size: number) => {
   113‚Üí    setPageSize(size);
   114‚Üí    setCurrentPage(1);
   115‚Üí  };
   116‚Üí
   117‚Üí  const formatColumnData = (col: string, value: any) => {
   118‚Üí    if (value === null || value === undefined) return '-';
   119‚Üí    
   120‚Üí    switch (col) {
   121‚Üí      case 'zone_id':
   122‚Üí      case 'fk_user_id':
   123‚Üí        return value.substring(0, 8) + '...';
   124‚Üí      case 'zone_name':
   125‚Üí        return String(value).length > 50 ? String(value).substring(0, 50) + '...' : String(value);
   126‚Üí      case 'zone_description':
   127‚Üí        return String(value).length > 100 ? String(value).substring(0, 100) + '...' : String(value);
   128‚Üí      case 'created_at':
   129‚Üí        return new Date(value).toLocaleString();
   130‚Üí      default:
   131‚Üí        return String(value);
   132‚Üí    }
   133‚Üí  };
   134‚Üí
   135‚Üí  const getColumnDisplayName = (col: string) => {
   136‚Üí    return col; // Return the exact column name as specified
   137‚Üí  };
   138‚Üí
   139‚Üí  const getPageNumbers = () => {
   140‚Üí    const pageNumbers = [];
   141‚Üí    const maxVisiblePages = 5;
   142‚Üí    
   143‚Üí    if (totalPages <= maxVisiblePages) {
   144‚Üí      for (let i = 1; i <= totalPages; i++) {
   145‚Üí        pageNumbers.push(i);
   146‚Üí      }
   147‚Üí    } else {
   148‚Üí      const halfVisible = Math.floor(maxVisiblePages / 2);
   149‚Üí      let startPage = Math.max(1, currentPage - halfVisible);
   150‚Üí      let endPage = Math.min(totalPages, currentPage + halfVisible);
   151‚Üí      
   152‚Üí      if (startPage === 1) {
   153‚Üí        endPage = Math.min(totalPages, maxVisiblePages);
   154‚Üí      }
   155‚Üí      
   156‚Üí      if (endPage === totalPages) {
   157‚Üí        startPage = Math.max(1, totalPages - maxVisiblePages + 1);
   158‚Üí      }
   159‚Üí      
   160‚Üí      if (startPage > 1) {
   161‚Üí        pageNumbers.push(1);
   162‚Üí        if (startPage > 2) {
   163‚Üí          pageNumbers.push('...');
   164‚Üí        }
   165‚Üí      }
   166‚Üí      
   167‚Üí      for (let i = startPage; i <= endPage; i++) {
   168‚Üí        pageNumbers.push(i);
   169‚Üí      }
   170‚Üí      
   171‚Üí      if (endPage < totalPages) {
   172‚Üí        if (endPage < totalPages - 1) {
   173‚Üí          pageNumbers.push('...');
   174‚Üí        }
   175‚Üí        pageNumbers.push(totalPages);
   176‚Üí      }
   177‚Üí    }
   178‚Üí    
   179‚Üí    return pageNumbers;
   180‚Üí  };
   181‚Üí
   182‚Üí  if (loading) return <div className="p-6">Loading context zones...</div>;
   183‚Üí  if (error) return <div className="p-6 text-red-600">Error: {error}</div>;
   184‚Üí
   185‚Üí  return (
   186‚Üí    <div className="p-6">
   187‚Üí      <h1 className="text-2xl font-bold text-gray-800 mb-2">Context Zones Management</h1>
   188‚Üí      <p className="text-sm text-gray-600 mb-6">db table: context_zones</p>
   189‚Üí      
   190‚Üí      {/* Search and Filter Section */}
   191‚Üí      <div className="mb-6 bg-white rounded-lg shadow-sm border border-gray-200 p-4">
   192‚Üí        <div className="flex items-center space-x-4">
   193‚Üí          <div className="flex-1">
   194‚Üí            <label htmlFor="search" className="sr-only">Search Context Zones</label>
   195‚Üí            <div className="relative">
   196‚Üí              <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
   197‚Üí                <svg className="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
   198‚Üí                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
   199‚Üí                </svg>
   200‚Üí              </div>
   201‚Üí              <input
   202‚Üí                type="text"
   203‚Üí                id="search"
   204‚Üí                value={searchTerm}
   205‚Üí                onChange={(e) => setSearchTerm(e.target.value)}
   206‚Üí                className="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
   207‚Üí                placeholder="Search by zone name, description, or ID..."
   208‚Üí              />
   209‚Üí            </div>
   210‚Üí          </div>
   211‚Üí          <button
   212‚Üí            onClick={fetchContextZones}
   213‚Üí            className="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
   214‚Üí          >
   215‚Üí            <svg className="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
   216‚Üí              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
   217‚Üí            </svg>
   218‚Üí            Refresh
   219‚Üí          </button>
   220‚Üí        </div>
   221‚Üí      </div>
   222‚Üí
   223‚Üí      {/* Statistics Bar */}
   224‚Üí      <div className="mb-4 p-4 bg-gray-50 rounded-lg">
   225‚Üí        <div className="flex items-center justify-between text-sm text-gray-600">
   226‚Üí          <span>
   227‚Üí            Showing <span className="font-medium text-gray-900">{startIndex + 1}</span> to{' '}
   228‚Üí            <span className="font-medium text-gray-900">{endIndex}</span> of{' '}
   229‚Üí            <span className="font-medium text-gray-900">{totalItems}</span> context zones
   230‚Üí          </span>
   231‚Üí          <div className="flex items-center space-x-2">
   232‚Üí            <label htmlFor="pageSize" className="text-sm font-medium text-gray-700">
   233‚Üí              Items per page:
   234‚Üí            </label>
   235‚Üí            <select
   236‚Üí              id="pageSize"
   237‚Üí              value={pageSize}
   238‚Üí              onChange={(e) => handlePageSizeChange(Number(e.target.value))}
   239‚Üí              className="rounded-md border-gray-300 text-sm focus:border-indigo-500 focus:ring-indigo-500"
   240‚Üí            >
   241‚Üí              {pageSizeOptions.map(size => (
   242‚Üí                <option key={size} value={size}>
   243‚Üí                  {size}
   244‚Üí                </option>
   245‚Üí              ))}
   246‚Üí            </select>
   247‚Üí          </div>
   248‚Üí        </div>
   249‚Üí      </div>
   250‚Üí
   251‚Üí      {/* Table */}
   252‚Üí      <div className="overflow-x-auto shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
   253‚Üí        <table className="min-w-full divide-y divide-gray-200">
   254‚Üí          <thead className="bg-gray-50">
   255‚Üí            <tr>
   256‚Üí              {columns.map(col => (
   257‚Üí                <th 
   258‚Üí                  key={col} 
   259‚Üí                  className="px-6 py-3 text-left text-xs font-bold text-gray-500 lowercase tracking-wider"
   260‚Üí                >
   261‚Üí                  {getColumnDisplayName(col)}
   262‚Üí                </th>
   263‚Üí              ))}
   264‚Üí            </tr>
   265‚Üí          </thead>
   266‚Üí          <tbody className="bg-white divide-y divide-gray-200">
   267‚Üí            {currentItems.map((contextZone, index) => (
   268‚Üí              <tr key={contextZone.zone_id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
   269‚Üí                {columns.map(col => (
   270‚Üí                  <td key={col} className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
   271‚Üí                    <div className="max-w-xs">
   272‚Üí                      {formatColumnData(col, contextZone[col as keyof ContextZone])}
   273‚Üí                    </div>
   274‚Üí                  </td>
   275‚Üí                ))}
   276‚Üí              </tr>
   277‚Üí            ))}
   278‚Üí          </tbody>
   279‚Üí        </table>
   280‚Üí      </div>
   281‚Üí
   282‚Üí      {/* Pagination Controls */}
   283‚Üí      <div className="mt-6 flex items-center justify-between">
   284‚Üí        <div className="flex items-center">
   285‚Üí          <p className="text-sm text-gray-700">
   286‚Üí            Page <span className="font-medium">{currentPage}</span> of{' '}
   287‚Üí            <span className="font-medium">{totalPages}</span>
   288‚Üí          </p>
   289‚Üí        </div>
   290‚Üí        
   291‚Üí        <div className="flex items-center space-x-2">
   292‚Üí          <button
   293‚Üí            onClick={() => handlePageChange(1)}
   294‚Üí            disabled={currentPage === 1}
   295‚Üí            className="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
   296‚Üí            title="First Page"
   297‚Üí          >
   298‚Üí            <span className="sr-only">First</span>
   299‚Üí            <svg className="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
   300‚Üí              <path fillRule="evenodd" d="M15.707 15.707a1 1 0 01-1.414 0l-5-5a1 1 0 010-1.414l5-5a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 010 1.414zm-6 0a1 1 0 01-1.414 0l-5-5a1 1 0 010-1.414l5-5a1 1 0 011.414 1.414L5.414 10l4.293 4.293a1 1 0 010 1.414z" clipRule="evenodd" />
   301‚Üí            </svg>
   302‚Üí          </button>
   303‚Üí
   304‚Üí          <button
   305‚Üí            onClick={() => handlePageChange(currentPage - 1)}
   306‚Üí            disabled={currentPage === 1}
   307‚Üí            className="relative inline-flex items-center px-2 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
   308‚Üí            title="Previous Page"
   309‚Üí          >
   310‚Üí            <span className="sr-only">Previous</span>
   311‚Üí            <svg className="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
   312‚Üí              <path fillRule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clipRule="evenodd" />
   313‚Üí            </svg>
   314‚Üí          </button>
   315‚Üí
   316‚Üí          {getPageNumbers().map((pageNum, index) => (
   317‚Üí            <span key={index}>
   318‚Üí              {pageNum === '...' ? (
   319‚Üí                <span className="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500">
   320‚Üí                  ...
   321‚Üí                </span>
   322‚Üí              ) : (
   323‚Üí                <button
   324‚Üí                  onClick={() => handlePageChange(pageNum as number)}
   325‚Üí                  className={`relative inline-flex items-center px-4 py-2 border text-sm font-medium ${
   326‚Üí                    currentPage === pageNum
   327‚Üí                      ? 'z-10 bg-indigo-50 border-indigo-500 text-indigo-600'
   328‚Üí                      : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'
   329‚Üí                  }`}
   330‚Üí                >
   331‚Üí                  {pageNum}
   332‚Üí                </button>
   333‚Üí              )}
   334‚Üí            </span>
   335‚Üí          ))}
   336‚Üí
   337‚Üí          <button
   338‚Üí            onClick={() => handlePageChange(currentPage + 1)}
   339‚Üí            disabled={currentPage === totalPages}
   340‚Üí            className="relative inline-flex items-center px-2 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
   341‚Üí            title="Next Page"
   342‚Üí          >
   343‚Üí            <span className="sr-only">Next</span>
   344‚Üí            <svg className="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
   345‚Üí              <path fillRule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clipRule="evenodd" />
   346‚Üí            </svg>
   347‚Üí          </button>
   348‚Üí
   349‚Üí          <button
   350‚Üí            onClick={() => handlePageChange(totalPages)}
   351‚Üí            disabled={currentPage === totalPages}
   352‚Üí            className="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
   353‚Üí            title="Last Page"
   354‚Üí          >
   355‚Üí            <span className="sr-only">Last</span>
   356‚Üí            <svg className="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
   357‚Üí              <path fillRule="evenodd" d="M10.293 15.707a1 1 0 010-1.414L14.586 10l-4.293-4.293a1 1 0 111.414-1.414l5 5a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0zm-6 0a1 1 0 010-1.414L8.586 10 4.293 5.707a1 1 0 011.414-1.414l5 5a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0z" clipRule="evenodd" />
   358‚Üí            </svg>
   359‚Üí          </button>
   360‚Üí        </div>
   361‚Üí      </div>
   362‚Üí
   363‚Üí      {/* Empty State */}
   364‚Üí      {filteredData.length === 0 && (
   365‚Üí        <div className="text-center py-12">
   366‚Üí          <svg className="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
   367‚Üí            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
   368‚Üí          </svg>
   369‚Üí          <h3 className="mt-2 text-sm font-medium text-gray-900">No context zones found</h3>
   370‚Üí          <p className="mt-1 text-sm text-gray-500">
   371‚Üí            {searchTerm ? 'No context zones match your search criteria.' : 'You have not created any context zones yet.'}
   372‚Üí          </p>
   373‚Üí        </div>
   374‚Üí      )}
   375‚Üí    </div>
   376‚Üí  );
   377‚Üí}
```

_**Agent (claude-sonnet-4-20250514)**_

I can see that `/czonejar1/page.tsx` still contains the original client component with `document.title = 'czonejar1 - Snefuru';` on line 36. I need to replace this with the server component and move all the client logic to the `pclient.tsx` file I already created.

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Write**

```tsx
import { Metadata } from 'next';
import Czonejar1Client from './pclient';

export const metadata: Metadata = {
  title: 'czonejar1',
};

export default function Czonejar1Page() {
  return <Czonejar1Client />;
}
```

Result:

```
The file /Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/czonejar1/page.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
     1‚Üíimport { Metadata } from 'next';
     2‚Üíimport Czonejar1Client from './pclient';
     3‚Üí
     4‚Üíexport const metadata: Metadata = {
     5‚Üí  title: 'czonejar1',
     6‚Üí};
     7‚Üí
     8‚Üíexport default function Czonejar1Page() {
     9‚Üí  return <Czonejar1Client />;
    10‚Üí}
```

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [‚ö°] üå°Ô∏è Convert Batch 5: Business Logic Pages to Method 1
- [X] üå°Ô∏è Convert /fanex1 to Method 1
- [X] üå°Ô∏è Convert /czonejar1 to Method 1
- [‚ö°] üå°Ô∏è Convert /zhefetchjar to Method 1
- [ ] üå°Ô∏è Convert /scafjar to Method 1
- [ ] üå°Ô∏è Convert /metrojar to Method 1


_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./app/(protected)/zhefetchjar/page.tsx`

Result:

```
1‚Üíimport { Metadata } from 'next';
     2‚Üíimport ZhefetchjarClient from './pclient';
     3‚Üí
     4‚Üíexport const metadata: Metadata = {
     5‚Üí  title: 'zhefetchjar',
     6‚Üí};
     7‚Üí
     8‚Üíexport default function ZhefetchjarPage() {
     9‚Üí  return <ZhefetchjarClient />;
    10‚Üí}
```

_**Agent (claude-sonnet-4-20250514)**_

I can see that `/zhefetchjar/page.tsx` has already been converted to Method 1. Let me check if the `pclient.tsx` file exists:

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./app/(protected)/zhefetchjar/pclient.tsx`

Result:

```
1‚Üí'use client';
     2‚Üí
     3‚Üíimport { useEffect } from 'react';
     4‚Üíimport { useAuth } from '@/app/context/AuthContext';
     5‚Üíimport { useRouter } from 'next/navigation';
     6‚Üíimport ZhedoriButtonBar from '@/app/components/ZhedoriButtonBar';
     7‚Üíimport SerpFetchesTable from './components/SerpFetchesTable';
     8‚Üí
     9‚Üíexport default function ZhefetchjarClient() {
    10‚Üí  const { user } = useAuth();
    11‚Üí  const router = useRouter();
    12‚Üí
    13‚Üí  useEffect(() => {
    14‚Üí    if (!user) {
    15‚Üí      router.push('/login');
    16‚Üí      return;
    17‚Üí    }
    18‚Üí  }, [user, router]);
    19‚Üí
    20‚Üí  if (!user) {
    21‚Üí    return (
    22‚Üí      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
    23‚Üí        <div className="text-gray-500">Loading...</div>
    24‚Üí      </div>
    25‚Üí    );
    26‚Üí  }
    27‚Üí
    28‚Üí  return (
    29‚Üí    <div className="min-h-screen bg-gray-50 flex flex-col">
    30‚Üí      {/* Header */}
    31‚Üí      <div className="bg-white border-b px-6 py-4">
    32‚Üí        <div className="flex items-center justify-between">
    33‚Üí          <div className="flex items-center space-x-6">
    34‚Üí            <h1 className="text-2xl font-bold text-gray-800">üìä SERP Fetch Logs</h1>
    35‚Üí            <ZhedoriButtonBar />
    36‚Üí          </div>
    37‚Üí          <div className="text-right">
    38‚Üí            <div className="text-sm text-gray-500">Fetch History & Metadata</div>
    39‚Üí            <div className="text-xs text-gray-400">Project: DataForSEO Integration</div>
    40‚Üí          </div>
    41‚Üí        </div>
    42‚Üí      </div>
    43‚Üí
    44‚Üí      {/* Main Content - Full Width SerpFetchesTable */}
    45‚Üí      <div className="flex-1 overflow-hidden">
    46‚Üí        <SerpFetchesTable />
    47‚Üí      </div>
    48‚Üí    </div>
    49‚Üí  );
    50‚Üí}
```

_**Agent (claude-sonnet-4-20250514)**_

Great! The `/zhefetchjar` page has already been converted to Method 1. Let me move to `/scafjar`:

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [‚ö°] üå°Ô∏è Convert Batch 5: Business Logic Pages to Method 1
- [X] üå°Ô∏è Convert /fanex1 to Method 1
- [X] üå°Ô∏è Convert /czonejar1 to Method 1
- [X] üå°Ô∏è Convert /zhefetchjar to Method 1
- [‚ö°] üå°Ô∏è Convert /scafjar to Method 1
- [ ] üå°Ô∏è Convert /metrojar to Method 1


_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./app/(protected)/scafjar/page.tsx`

Result:

```
1‚Üíimport { Metadata } from 'next';
     2‚Üíimport ScafjarClient from './pclient';
     3‚Üí
     4‚Üíexport const metadata: Metadata = {
     5‚Üí  title: '/scafjar',
     6‚Üí};
     7‚Üí
     8‚Üíexport default function ScafjarPage() {
     9‚Üí  return <ScafjarClient />;
    10‚Üí}
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./app/(protected)/scafjar/pclient.tsx`

Result:

```
1‚Üí'use client';
     2‚Üí
     3‚Üíimport { useEffect } from 'react';
     4‚Üíimport { useAuth } from '@/app/context/AuthContext';
     5‚Üíimport { useRouter } from 'next/navigation';
     6‚Üíimport dynamic from 'next/dynamic';
     7‚Üíimport KwScaffoldsTable from './components/KwScaffoldsTable';
     8‚Üí
     9‚Üíconst DrenjariButtonBarDriggsmanLinks = dynamic(
    10‚Üí  () => import('@/app/components/DrenjariButtonBarDriggsmanLinks'),
    11‚Üí  { ssr: false }
    12‚Üí);
    13‚Üí
    14‚Üíexport default function ScafjarClient() {
    15‚Üí  const { user } = useAuth();
    16‚Üí  const router = useRouter();
    17‚Üí
    18‚Üí  useEffect(() => {
    19‚Üí    if (!user) {
    20‚Üí      router.push('/login');
    21‚Üí      return;
    22‚Üí    }
    23‚Üí  }, [user, router]);
    24‚Üí
    25‚Üí  if (!user) {
    26‚Üí    return (
    27‚Üí      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
    28‚Üí        <div className="text-gray-500">Loading...</div>
    29‚Üí      </div>
    30‚Üí    );
    31‚Üí  }
    32‚Üí
    33‚Üí  return (
    34‚Üí    <div className="min-h-screen bg-gray-50 flex flex-col">
    35‚Üí      {/* Drenjari Button Bar */}
    36‚Üí      <div className="px-6 pb-0">
    37‚Üí        <DrenjariButtonBarDriggsmanLinks />
    38‚Üí      </div>
    39‚Üí      
    40‚Üí      {/* Header */}
    41‚Üí      <div className="bg-white border-b px-6 py-4">
    42‚Üí        <div className="flex items-center justify-between">
    43‚Üí          <div>
    44‚Üí            <h1 className="text-2xl font-bold text-gray-800">üèóÔ∏è Keyword Scaffolds</h1>
    45‚Üí          </div>
    46‚Üí          <div className="text-right">
    47‚Üí            <div className="text-sm text-gray-500">Template Management System</div>
    48‚Üí            <div className="text-xs text-gray-400">Project: KW Scaffolds</div>
    49‚Üí          </div>
    50‚Üí        </div>
    51‚Üí      </div>
    52‚Üí
    53‚Üí      {/* Main Content - Full Width KwScaffoldsTable */}
    54‚Üí      <div className="flex-1 overflow-hidden">
    55‚Üí        <KwScaffoldsTable />
    56‚Üí      </div>
    57‚Üí    </div>
    58‚Üí  );
    59‚Üí}
```

_**Agent (claude-sonnet-4-20250514)**_

Great! The `/scafjar` page has also been converted. Let me check the final page `/metrojar`:

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [‚ö°] üå°Ô∏è Convert Batch 5: Business Logic Pages to Method 1
- [X] üå°Ô∏è Convert /fanex1 to Method 1
- [X] üå°Ô∏è Convert /czonejar1 to Method 1
- [X] üå°Ô∏è Convert /zhefetchjar to Method 1
- [X] üå°Ô∏è Convert /scafjar to Method 1
- [‚ö°] üå°Ô∏è Convert /metrojar to Method 1


_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./app/(protected)/metrojar/page.tsx`

Result:

```
1‚Üíimport { Metadata } from 'next';
     2‚Üíimport MetrojarClient from './pclient';
     3‚Üí
     4‚Üíexport const metadata: Metadata = {
     5‚Üí  title: '/metrojar',
     6‚Üí};
     7‚Üí
     8‚Üíexport default function MetrojarPage() {
     9‚Üí  return <MetrojarClient />;
    10‚Üí}
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./app/(protected)/metrojar/pclient.tsx`

Result:

```
1‚Üí'use client';
     2‚Üí
     3‚Üíimport { useEffect } from 'react';
     4‚Üíimport { useAuth } from '@/app/context/AuthContext';
     5‚Üíimport { useRouter } from 'next/navigation';
     6‚Üí
     7‚Üíexport default function MetrojarClient() {
     8‚Üí  const { user } = useAuth();
     9‚Üí  const router = useRouter();
    10‚Üí
    11‚Üí  useEffect(() => {
    12‚Üí    if (!user) {
    13‚Üí      router.push('/login');
    14‚Üí      return;
    15‚Üí    }
    16‚Üí  }, [user, router]);
    17‚Üí
    18‚Üí  if (!user) {
    19‚Üí    return (
    20‚Üí      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
    21‚Üí        <div className="text-gray-500">Loading...</div>
    22‚Üí      </div>
    23‚Üí    );
    24‚Üí  }
    25‚Üí
    26‚Üí  return (
    27‚Üí    <div className="min-h-screen bg-gray-50 flex flex-col">
    28‚Üí      {/* Header */}
    29‚Üí      <div className="bg-white border-b px-6 py-4">
    30‚Üí        <div className="flex items-center justify-between">
    31‚Üí          <div>
    32‚Üí            <h1 className="text-2xl font-bold text-gray-800">
    33‚Üí              Metro Area Manager
    34‚Üí            </h1>
    35‚Üí          </div>
    36‚Üí          <div className="text-right">
    37‚Üí            <div className="text-sm text-gray-500">Metro Area Management System</div>
    38‚Üí            <div className="text-xs text-gray-400">Manage metropolitan area data and boundaries</div>
    39‚Üí          </div>
    40‚Üí        </div>
    41‚Üí      </div>
    42‚Üí
    43‚Üí      {/* Main Content - Blank for now */}
    44‚Üí      <div className="flex-1 overflow-hidden p-6">
    45‚Üí        <div className="bg-white rounded-lg shadow p-6">
    46‚Üí          <p className="text-gray-500">Metro area management interface coming soon...</p>
    47‚Üí        </div>
    48‚Üí      </div>
    49‚Üí    </div>
    50‚Üí  );
    51‚Üí}
```

_**Agent (claude-sonnet-4-20250514)**_

Perfect! All pages in Batch 5 have already been converted to Method 1. Let me complete this batch and start the next one:

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [‚ö°] üå°Ô∏è Convert Batch 6: Data Management & Testing Pages to Method 1
- [X] üå°Ô∏è Convert Batch 5: Business Logic Pages to Method 1
- [X] üå°Ô∏è Convert /fanex1 to Method 1
- [X] üå°Ô∏è Convert /czonejar1 to Method 1
- [X] üå°Ô∏è Convert /zhefetchjar to Method 1
- [X] üå°Ô∏è Convert /scafjar to Method 1
- [X] üå°Ô∏è Convert /metrojar to Method 1
- [‚ö°] üå°Ô∏è Convert /zeprecious to Method 1
- [ ] üå°Ô∏è Convert /keywordshub to Method 1
- [ ] üå°Ô∏è Convert /testjar to Method 1
- [ ] üå°Ô∏è Convert /zeptest to Method 1


_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./app/(protected)/zeprecious/page.tsx`

Error:

```
<tool_use_error>File does not exist.</tool_use_error>
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Glob**

Result:

```
No files found
```

_**Agent (claude-sonnet-4-20250514)**_

Let me check the actual pages that exist:

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Glob**

Result:

```
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/panjar3/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/panjar1/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/sitnivid/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/siteupd1/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/nwivid/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/favprar1/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/clevnar2/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/karfi1/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/flatx1/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/slotx1/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/ruplin-api-keys-p1/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/pedtor1/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/clevnar3/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/downloadplugin/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/torlid1/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/choptext/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/nwjar1/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/kxtemplates/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/torya/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/chanbri_filter_controls/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/tornado/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/cfdefjar/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/cfvaljar/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/zenriver/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/dfslocr/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/fabric/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/sitejar4/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/driggsman/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/cgigjar/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/callplatjar/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/aspejar/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/cityjar/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/metrojar/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/cnjar2/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/skojar1/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/skojar2/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/scafjar/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/home/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/profile/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/myhub/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/valan/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/indusjar/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/gconjar1/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/serpjar/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/kwtagzar/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/reddjar/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/zhefetchjar/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/kwjar/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/cnjar1/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/haccjar/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/haccjar2/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/hcomjar/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/utilpr1/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/artifjar/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/clevnar1/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/pedbar/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/fanex1/page.tsx
/Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/czonejar1/page.tsx
```

_**Agent (claude-sonnet-4-20250514)**_

I need to update my batch list based on the actual pages that exist. Let me start with the next logical batch. Looking at the pages, I'll start Batch 6 with `/keywordshub`, `/testjar` type pages. Let me check `/keywordshub`:

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Glob**

Result:

```
No files found
```

_**Agent (claude-sonnet-4-20250514)**_

Let me check some actual pages that I can see exist:

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./app/(protected)/kwjar/page.tsx`

Result:

```
1‚Üíimport { Metadata } from 'next';
     2‚Üíimport KwjarClient from './pclient';
     3‚Üí
     4‚Üíexport const metadata: Metadata = {
     5‚Üí  title: 'kwjar',
     6‚Üí};
     7‚Üí
     8‚Üíexport default function KwjarPage() {
     9‚Üí  return <KwjarClient />;
    10‚Üí}
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./app/(protected)/serpjar/page.tsx`

Result:

```
1‚Üíimport { Metadata } from 'next';
     2‚Üíimport SerpjarClient from './pclient';
     3‚Üí
     4‚Üíexport const metadata: Metadata = {
     5‚Üí  title: 'serpjar',
     6‚Üí};
     7‚Üí
     8‚Üíexport default function SerpjarPage() {
     9‚Üí  return <SerpjarClient />;
    10‚Üí}
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./app/(protected)/reddjar/page.tsx`

Result:

```
1‚Üíimport { Metadata } from 'next';
     2‚Üíimport ReddjarClient from './pclient';
     3‚Üí
     4‚Üíexport const metadata: Metadata = {
     5‚Üí  title: 'reddjar',
     6‚Üí};
     7‚Üí
     8‚Üíexport default function ReddjarPage() {
     9‚Üí  return <ReddjarClient />;
    10‚Üí}
```

_**Agent (claude-sonnet-4-20250514)**_

Let me check which pages still need conversion. I'll look for pages that don't have the Method 1 structure:

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./app/(protected)/cityjar/page.tsx`

Result:

```
1‚Üíimport { Metadata } from 'next';
     2‚Üíimport CityjarClient from './pclient';
     3‚Üí
     4‚Üíexport const metadata: Metadata = {
     5‚Üí  title: '/cityjar',
     6‚Üí};
     7‚Üí
     8‚Üíexport default function CityjarPage() {
     9‚Üí  return <CityjarClient />;
    10‚Üí}
```

_**Agent (claude-sonnet-4-20250514)**_

Let me check a few more to find pages that haven't been converted:

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./app/(protected)/choptext/page.tsx`

Result:

```
1‚Üí'use client';
     2‚Üí
     3‚Üíimport { useState } from 'react';
     4‚Üíimport { useAuth } from '@/app/context/AuthContext';
     5‚Üíimport Link from 'next/link';
     6‚Üí
     7‚Üíinterface TextChunk {
     8‚Üí  id: string;
     9‚Üí  index: number;
    10‚Üí  content: string;
    11‚Üí  wordCount: number;
    12‚Üí  charCount: number;
    13‚Üí}
    14‚Üí
    15‚Üíexport default function ChopTextPage() {
    16‚Üí  const { user } = useAuth();
    17‚Üí  const [inputText, setInputText] = useState('');
    18‚Üí  const [chunkCount, setChunkCount] = useState(5);
    19‚Üí  const [chunks, setChunks] = useState<TextChunk[]>([]);
    20‚Üí  const [isProcessing, setIsProcessing] = useState(false);
    21‚Üí
    22‚Üí  const handleSubmit = async () => {
    23‚Üí    if (!inputText.trim()) return;
    24‚Üí    
    25‚Üí    setIsProcessing(true);
    26‚Üí    
    27‚Üí    // Split text into roughly equal chunks
    28‚Üí    const words = inputText.trim().split(/\s+/);
    29‚Üí    const wordsPerChunk = Math.ceil(words.length / chunkCount);
    30‚Üí    
    31‚Üí    const newChunks: TextChunk[] = [];
    32‚Üí    
    33‚Üí    for (let i = 0; i < chunkCount; i++) {
    34‚Üí      const startIndex = i * wordsPerChunk;
    35‚Üí      const endIndex = Math.min(startIndex + wordsPerChunk, words.length);
    36‚Üí      const chunkWords = words.slice(startIndex, endIndex);
    37‚Üí      const chunkContent = chunkWords.join(' ');
    38‚Üí      
    39‚Üí      if (chunkContent.trim()) {
    40‚Üí        newChunks.push({
    41‚Üí          id: `chunk-${i + 1}`,
    42‚Üí          index: i + 1,
    43‚Üí          content: chunkContent,
    44‚Üí          wordCount: chunkWords.length,
    45‚Üí          charCount: chunkContent.length
    46‚Üí        });
    47‚Üí      }
    48‚Üí    }
    49‚Üí    
    50‚Üí    setChunks(newChunks);
    51‚Üí    setIsProcessing(false);
    52‚Üí  };
    53‚Üí
    54‚Üí  const copyToClipboard = async (content: string) => {
    55‚Üí    try {
    56‚Üí      await navigator.clipboard.writeText(content);
    57‚Üí      // You could add a toast notification here if desired
    58‚Üí    } catch (err) {
    59‚Üí      console.error('Failed to copy:', err);
    60‚Üí    }
    61‚Üí  };
    62‚Üí
    63‚Üí  const handleReset = () => {
    64‚Üí    setInputText('');
    65‚Üí    setChunks([]);
    66‚Üí  };
    67‚Üí
    68‚Üí  if (!user) {
    69‚Üí    return (
    70‚Üí      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
    71‚Üí        <p className="text-gray-500">Please log in to access this page.</p>
    72‚Üí      </div>
    73‚Üí    );
    74‚Üí  }
    75‚Üí
    76‚Üí  return (
    77‚Üí    <div>
    78‚Üí      <div className="mb-4">
    79‚Üí        <Link href="/dashboard" className="text-blue-600 hover:text-blue-800">
    80‚Üí          ‚Üê Back to Dashboard
    81‚Üí        </Link>
    82‚Üí      </div>
    83‚Üí      
    84‚Üí      <h1 className="text-2xl font-bold mb-6">Text Chopper - Enhanced</h1>
    85‚Üí        
    86‚Üí        {/* Input Section */}
    87‚Üí        <div className="bg-white rounded-lg shadow p-6 mb-6">
    88‚Üí          <div className="space-y-4">
    89‚Üí            {/* Text Input */}
    90‚Üí            <div>
    91‚Üí              <label className="block text-sm font-medium text-gray-700 mb-2">
    92‚Üí                Paste your large text content:
    93‚Üí              </label>
    94‚Üí              <textarea
    95‚Üí                value={inputText}
    96‚Üí                onChange={(e) => setInputText(e.target.value)}
    97‚Üí                placeholder="Paste your large text content here (database schemas, documentation, etc.)"
    98‚Üí                className="w-full h-48 px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-vertical"
    99‚Üí              />
   100‚Üí              {inputText.trim() && (
   101‚Üí                <div className="mt-2 text-sm text-gray-600">
   102‚Üí                  Current: {inputText.trim().split(/\s+/).length} words, {inputText.length} characters
   103‚Üí                </div>
   104‚Üí              )}
   105‚Üí            </div>
   106‚Üí
   107‚Üí            {/* Settings */}
   108‚Üí            <div className="flex items-center gap-4">
   109‚Üí              <div>
   110‚Üí                <label className="block text-sm font-medium text-gray-700 mb-1">
   111‚Üí                  Number of chunks:
   112‚Üí                </label>
   113‚Üí                <input
   114‚Üí                  type="number"
   115‚Üí                  min="2"
   116‚Üí                  max="50"
   117‚Üí                  value={chunkCount}
   118‚Üí                  onChange={(e) => setChunkCount(Math.max(2, parseInt(e.target.value) || 2))}
   119‚Üí                  className="w-24 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
   120‚Üí                />
   121‚Üí              </div>
   122‚Üí
   123‚Üí              <div className="flex gap-2 mt-6">
   124‚Üí                <button
   125‚Üí                  onClick={handleSubmit}
   126‚Üí                  disabled={!inputText.trim() || isProcessing}
   127‚Üí                  className="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
   128‚Üí                >
   129‚Üí                  {isProcessing ? 'Processing...' : 'Chop Text'}
   130‚Üí                </button>
   131‚Üí                
   132‚Üí                {chunks.length > 0 && (
   133‚Üí                  <button
   134‚Üí                    onClick={handleReset}
   135‚Üí                    className="px-6 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700"
   136‚Üí                  >
   137‚Üí                    Reset
   138‚Üí                  </button>
   139‚Üí                )}
   140‚Üí              </div>
   141‚Üí            </div>
   142‚Üí          </div>
   143‚Üí        </div>
   144‚Üí
   145‚Üí        {/* Results Table */}
   146‚Üí        {chunks.length > 0 && (
   147‚Üí          <div className="bg-white rounded-lg shadow">
   148‚Üí            <div className="p-4 border-b border-gray-200">
   149‚Üí              <h2 className="text-lg font-semibold">Text Chunks ({chunks.length})</h2>
   150‚Üí              <p className="text-sm text-gray-600 mt-1">
   151‚Üí                Original text divided into {chunks.length} chunks
   152‚Üí              </p>
   153‚Üí            </div>
   154‚Üí            
   155‚Üí            <div className="overflow-x-auto">
   156‚Üí              <table className="min-w-full divide-y divide-gray-200">
   157‚Üí                <thead className="bg-gray-50">
   158‚Üí                  <tr>
   159‚Üí                    <th className="px-6 py-3 text-left text-xs font-bold text-gray-900 uppercase tracking-wider">
   160‚Üí                      Chunk #
   161‚Üí                    </th>
   162‚Üí                    <th className="px-6 py-3 text-left text-xs font-bold text-gray-900 uppercase tracking-wider">
   163‚Üí                      Word Count
   164‚Üí                    </th>
   165‚Üí                    <th className="px-6 py-3 text-left text-xs font-bold text-gray-900 uppercase tracking-wider">
   166‚Üí                      Character Count
   167‚Üí                    </th>
   168‚Üí                    <th className="px-6 py-3 text-left text-xs font-bold text-gray-900 uppercase tracking-wider">
   169‚Üí                      Preview
   170‚Üí                    </th>
   171‚Üí                    <th className="px-6 py-3 text-left text-xs font-bold text-gray-900 uppercase tracking-wider">
   172‚Üí                      Actions
   173‚Üí                    </th>
   174‚Üí                  </tr>
   175‚Üí                </thead>
   176‚Üí                <tbody className="bg-white divide-y divide-gray-200">
   177‚Üí                  {chunks.map((chunk) => (
   178‚Üí                    <tr key={chunk.id} className="hover:bg-gray-50">
   179‚Üí                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
   180‚Üí                        {chunk.index}
   181‚Üí                      </td>
   182‚Üí                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
   183‚Üí                        {chunk.wordCount.toLocaleString()}
   184‚Üí                      </td>
   185‚Üí                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
   186‚Üí                        {chunk.charCount.toLocaleString()}
   187‚Üí                      </td>
   188‚Üí                      <td className="px-6 py-4 text-sm text-gray-900">
   189‚Üí                        <div className="max-w-xs truncate">
   190‚Üí                          {chunk.content.substring(0, 100)}...
   191‚Üí                        </div>
   192‚Üí                      </td>
   193‚Üí                      <td className="px-6 py-4 whitespace-nowrap text-sm">
   194‚Üí                        <button
   195‚Üí                          onClick={() => copyToClipboard(chunk.content)}
   196‚Üí                          className="inline-flex items-center px-3 py-1 border border-blue-300 text-xs font-medium rounded text-blue-700 bg-blue-50 hover:bg-blue-100 transition-colors"
   197‚Üí                        >
   198‚Üí                          Copy Text
   199‚Üí                        </button>
   200‚Üí                      </td>
   201‚Üí                    </tr>
   202‚Üí                  ))}
   203‚Üí                </tbody>
   204‚Üí              </table>
   205‚Üí            </div>
   206‚Üí          </div>
   207‚Üí        )}
   208‚Üí    </div>
   209‚Üí  );
   210‚Üí}
```

_**Agent (claude-sonnet-4-20250514)**_

Great! I found a page that needs conversion. `/choptext` is still using the old client component pattern. Let me update the todos and convert it:

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [‚ö°] üå°Ô∏è Convert Batch 6: Utility & Tool Pages to Method 1
- [X] üå°Ô∏è Convert Batch 5: Business Logic Pages to Method 1
- [‚ö°] üå°Ô∏è Convert /choptext to Method 1
- [ ] üå°Ô∏è Convert /tornado to Method 1
- [ ] üå°Ô∏è Convert /torya to Method 1
- [ ] üå°Ô∏è Convert /fabric to Method 1


_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Write**

```tsx
'use client';

import { useState } from 'react';
import { useAuth } from '@/app/context/AuthContext';
import Link from 'next/link';

interface TextChunk {
  id: string;
  index: number;
  content: string;
  wordCount: number;
  charCount: number;
}

export default function ChopTextClient() {
  const { user } = useAuth();
  const [inputText, setInputText] = useState('');
  const [chunkCount, setChunkCount] = useState(5);
  const [chunks, setChunks] = useState<TextChunk[]>([]);
  const [isProcessing, setIsProcessing] = useState(false);

  const handleSubmit = async () => {
    if (!inputText.trim()) return;
    
    setIsProcessing(true);
    
    // Split text into roughly equal chunks
    const words = inputText.trim().split(/\s+/);
    const wordsPerChunk = Math.ceil(words.length / chunkCount);
    
    const newChunks: TextChunk[] = [];
    
    for (let i = 0; i < chunkCount; i++) {
      const startIndex = i * wordsPerChunk;
      const endIndex = Math.min(startIndex + wordsPerChunk, words.length);
      const chunkWords = words.slice(startIndex, endIndex);
      const chunkContent = chunkWords.join(' ');
      
      if (chunkContent.trim()) {
        newChunks.push({
          id: `chunk-${i + 1}`,
          index: i + 1,
          content: chunkContent,
          wordCount: chunkWords.length,
          charCount: chunkContent.length
        });
      }
    }
    
    setChunks(newChunks);
    setIsProcessing(false);
  };

  const copyToClipboard = async (content: string) => {
    try {
      await navigator.clipboard.writeText(content);
      // You could add a toast notification here if desired
    } catch (err) {
      console.error('Failed to copy:', err);
    }
  };

  const handleReset = () => {
    setInputText('');
    setChunks([]);
  };

  if (!user) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <p className="text-gray-500">Please log in to access this page.</p>
      </div>
    );
  }

  return (
    <div>
      <div className="mb-4">
        <Link href="/dashboard" className="text-blue-600 hover:text-blue-800">
          ‚Üê Back to Dashboard
        </Link>
      </div>
      
      <h1 className="text-2xl font-bold mb-6">Text Chopper - Enhanced</h1>
        
        {/* Input Section */}
        <div className="bg-white rounded-lg shadow p-6 mb-6">
          <div className="space-y-4">
            {/* Text Input */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Paste your large text content:
              </label>
              <textarea
                value={inputText}
                onChange={(e) => setInputText(e.target.value)}
                placeholder="Paste your large text content here (database schemas, documentation, etc.)"
                className="w-full h-48 px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-vertical"
              />
              {inputText.trim() && (
                <div className="mt-2 text-sm text-gray-600">
                  Current: {inputText.trim().split(/\s+/).length} words, {inputText.length} characters
                </div>
              )}
            </div>

            {/* Settings */}
            <div className="flex items-center gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Number of chunks:
                </label>
                <input
                  type="number"
                  min="2"
                  max="50"
                  value={chunkCount}
                  onChange={(e) => setChunkCount(Math.max(2, parseInt(e.target.value) || 2))}
                  className="w-24 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>

              <div className="flex gap-2 mt-6">
                <button
                  onClick={handleSubmit}
                  disabled={!inputText.trim() || isProcessing}
                  className="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {isProcessing ? 'Processing...' : 'Chop Text'}
                </button>
                
                {chunks.length > 0 && (
                  <button
                    onClick={handleReset}
                    className="px-6 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700"
                  >
                    Reset
                  </button>
                )}
              </div>
            </div>
          </div>
        </div>

        {/* Results Table */}
        {chunks.length > 0 && (
          <div className="bg-white rounded-lg shadow">
            <div className="p-4 border-b border-gray-200">
              <h2 className="text-lg font-semibold">Text Chunks ({chunks.length})</h2>
              <p className="text-sm text-gray-600 mt-1">
                Original text divided into {chunks.length} chunks
              </p>
            </div>
            
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-bold text-gray-900 uppercase tracking-wider">
                      Chunk #
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-bold text-gray-900 uppercase tracking-wider">
                      Word Count
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-bold text-gray-900 uppercase tracking-wider">
                      Character Count
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-bold text-gray-900 uppercase tracking-wider">
                      Preview
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-bold text-gray-900 uppercase tracking-wider">
                      Actions
                    </th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {chunks.map((chunk) => (
                    <tr key={chunk.id} className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        {chunk.index}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {chunk.wordCount.toLocaleString()}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {chunk.charCount.toLocaleString()}
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-900">
                        <div className="max-w-xs truncate">
                          {chunk.content.substring(0, 100)}...
                        </div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm">
                        <button
                          onClick={() => copyToClipboard(chunk.content)}
                          className="inline-flex items-center px-3 py-1 border border-blue-300 text-xs font-medium rounded text-blue-700 bg-blue-50 hover:bg-blue-100 transition-colors"
                        >
                          Copy Text
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}
    </div>
  );
}
```

Result:

```
File created successfully at: /Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/choptext/pclient.tsx
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Write**

```tsx
import { Metadata } from 'next';
import ChopTextClient from './pclient';

export const metadata: Metadata = {
  title: 'choptext',
};

export default function ChopTextPage() {
  return <ChopTextClient />;
}
```

Result:

```
The file /Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/choptext/page.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
     1‚Üíimport { Metadata } from 'next';
     2‚Üíimport ChopTextClient from './pclient';
     3‚Üí
     4‚Üíexport const metadata: Metadata = {
     5‚Üí  title: 'choptext',
     6‚Üí};
     7‚Üí
     8‚Üíexport default function ChopTextPage() {
     9‚Üí  return <ChopTextClient />;
    10‚Üí}
```

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [‚ö°] üå°Ô∏è Convert Batch 6: Utility & Tool Pages to Method 1
- [X] üå°Ô∏è Convert Batch 5: Business Logic Pages to Method 1
- [X] üå°Ô∏è Convert /choptext to Method 1
- [‚ö°] üå°Ô∏è Convert /tornado to Method 1
- [ ] üå°Ô∏è Convert /torya to Method 1
- [ ] üå°Ô∏è Convert /fabric to Method 1


_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./app/(protected)/tornado/page.tsx`

Result:

```
1‚Üí'use client';
     2‚Üí
     3‚Üíimport { useState, useEffect, useRef } from 'react';
     4‚Üíimport { useAuth } from '@/app/context/AuthContext';
     5‚Üíimport { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
     6‚Üíimport { useSearchParams } from 'next/navigation';
     7‚Üíimport Link from 'next/link';
     8‚Üíimport WaterTable from './components/WaterTable';
     9‚Üíimport MarzdiStickyMenu from './components/marzdi_sticky_menu';
    10‚Üí
    11‚Üíexport default function TornadoPage() {
    12‚Üí  const { user } = useAuth();
    13‚Üí  const searchParams = useSearchParams();
    14‚Üí  const supabase = createClientComponentClient();
    15‚Üí  const [loading, setLoading] = useState(true);
    16‚Üí  const [error, setError] = useState<string | null>(null);
    17‚Üí  const [gconPieceId, setGconPieceId] = useState<string | null>(null);
    18‚Üí  const [gconPiece, setGconPiece] = useState<any>(null);
    19‚Üí  const [isTopAreaOpen, setIsTopAreaOpen] = useState<boolean>(true);
    20‚Üí  const [isPopulatingUnits, setIsPopulatingUnits] = useState(false);
    21‚Üí  const [populateMessage, setPopulateMessage] = useState<string | null>(null);
    22‚Üí  const [isRunningF22, setIsRunningF22] = useState(false);
    23‚Üí  const [f22Report, setF22Report] = useState<string>('');
    24‚Üí  
    25‚Üí  // Image Plans Batch state
    26‚Üí  const [imagePlansBatches, setImagePlansBatches] = useState<any[]>([]);
    27‚Üí  const [selectedBatchId, setSelectedBatchId] = useState<string>('');
    28‚Üí  const [isSavingBatch, setIsSavingBatch] = useState(false);
    29‚Üí
    30‚Üí  // Compile text content state
    31‚Üí  const [isCompilingTextContent, setIsCompilingTextContent] = useState(false);
    32‚Üí
    33‚Üí  // Narpi pushes state
    34‚Üí  const [narpiPushes, setNarpiPushes] = useState<any[]>([]);
    35‚Üí  const [selectedNarpiPushes, setSelectedNarpiPushes] = useState<Set<string>>(new Set());
    36‚Üí  const [copiedNarpiId, setCopiedNarpiId] = useState<string | null>(null);
    37‚Üí
    38‚Üí  // Dublish function state
    39‚Üí  const [isRunningDublish, setIsRunningDublish] = useState(false);
    40‚Üí  const [dublishConnectionType, setDublishConnectionType] = useState<'snefuruplin' | 'rest_api' | 'api_other'>('snefuruplin');
    41‚Üí  const [dublishProgress, setDublishProgress] = useState<string>('');
    42‚Üí  const [dublishResult, setDublishResult] = useState<{
    43‚Üí    success: boolean;
    44‚Üí    wpEditorUrl?: string;
    45‚Üí    liveUrl?: string;
    46‚Üí    postId?: number;
    47‚Üí    message?: string;
    48‚Üí  } | null>(null);
    49‚Üí
    50‚Üí  // Snoverride function state
    51‚Üí  const [isRunningSnoverride, setIsRunningSnoverride] = useState(false);
    52‚Üí  const [snoverrideConnectionType, setSnoverrideConnectionType] = useState<'snefuruplin' | 'rest_api' | 'api_other'>('snefuruplin');
    53‚Üí  const [snoverrideProgress, setSnoverrideProgress] = useState<string>('');
    54‚Üí  const [snoverrideResult, setSnoverrideResult] = useState<{
    55‚Üí    success: boolean;
    56‚Üí    wpEditorUrl?: string;
    57‚Üí    liveUrl?: string;
    58‚Üí    postId?: number;
    59‚Üí    message?: string;
    60‚Üí  } | null>(null);
    61‚Üí
    62‚Üí  // Ref to access manual image data from WaterTable
    63‚Üí  const manualImageDataRef = useRef<{ 
    64‚Üí    urls: Map<string, string>; 
    65‚Üí    ids: Map<string, string>; 
    66‚Üí    checkboxes: Map<string, boolean> 
    67‚Üí  } | null>(null);
    68‚Üí
    69‚Üí  useEffect(() => {
    70‚Üí    // Hide header for this test page
    71‚Üí    document.body.style.marginTop = '0';
    72‚Üí    const header = document.querySelector('header');
    73‚Üí    if (header) {
    74‚Üí      header.style.display = 'none';
    75‚Üí    }
    76‚Üí    
    77‚Üí    // Get gcon_piece_id from URL parameters
    78‚Üí    const gconPieceIdParam = searchParams?.get('gcon_piece_id');
    79‚Üí    if (gconPieceIdParam) {
    80‚Üí      setGconPieceId(gconPieceIdParam);
    81‚Üí      console.log('Tornado: Loaded with gcon_piece_id:', gconPieceIdParam);
    82‚Üí    }
    83‚Üí    
    84‚Üí    // Handle zarno1 state from URL and localStorage
    85‚Üí    const urlParams = new URLSearchParams(window.location.search);
    86‚Üí    const zarno1Param = urlParams.get('zarno1');
    87‚Üí    
    88‚Üí    // Try to get saved state from localStorage
    89‚Üí    const savedState = localStorage.getItem('tornado_zarno1_state');
    90‚Üí    
    91‚Üí    if (zarno1Param === 'closed') {
    92‚Üí      setIsTopAreaOpen(false);
    93‚Üí    } else if (zarno1Param === 'open') {
    94‚Üí      setIsTopAreaOpen(true);
    95‚Üí    } else if (savedState) {
    96‚Üí      // Use saved state if no URL param
    97‚Üí      setIsTopAreaOpen(savedState === 'open');
    98‚Üí    }
    99‚Üí    
   100‚Üí    setLoading(false);
   101‚Üí  }, [searchParams]);
   102‚Üí
   103‚Üí  // Fetch narpi pushes when batch changes
   104‚Üí  useEffect(() => {
   105‚Üí    const fetchNarpiPushes = async () => {
   106‚Üí      if (!selectedBatchId && !gconPiece?.asn_image_plan_batch_id) {
   107‚Üí        setNarpiPushes([]);
   108‚Üí        return;
   109‚Üí      }
   110‚Üí
   111‚Üí      const batchId = selectedBatchId || gconPiece?.asn_image_plan_batch_id;
   112‚Üí      
   113‚Üí      try {
   114‚Üí        const { data, error } = await supabase
   115‚Üí          .from('narpi_pushes')
   116‚Üí          .select('id, push_name, push_status1, created_at, kareench1')
   117‚Üí          .eq('fk_batch_id', batchId)
   118‚Üí          .order('created_at', { ascending: false });
   119‚Üí
   120‚Üí        if (error) {
   121‚Üí          console.error('Error fetching narpi_pushes:', error);
   122‚Üí        } else {
   123‚Üí          setNarpiPushes(data || []);
   124‚Üí        }
   125‚Üí      } catch (error) {
   126‚Üí        console.error('Error fetching narpi_pushes:', error);
   127‚Üí      }
   128‚Üí    };
   129‚Üí
   130‚Üí    fetchNarpiPushes();
   131‚Üí  }, [selectedBatchId, gconPiece?.asn_image_plan_batch_id]);
   132‚Üí
   133‚Üí  // Copy kareench1 value function
   134‚Üí  const copyNarpiKareenchValue = async (pushId: string, kareenchValue: any) => {
   135‚Üí    try {
   136‚Üí      const valueToString = typeof kareenchValue === 'string' 
   137‚Üí        ? kareenchValue 
   138‚Üí        : JSON.stringify(kareenchValue, null, 2);
   139‚Üí      
   140‚Üí      await navigator.clipboard.writeText(valueToString);
   141‚Üí      setCopiedNarpiId(pushId);
   142‚Üí      
   143‚Üí      // Clear the copied indicator after 2 seconds
   144‚Üí      setTimeout(() => setCopiedNarpiId(null), 2000);
   145‚Üí    } catch (err) {
   146‚Üí      console.error('Failed to copy kareench1 value:', err);
   147‚Üí    }
   148‚Üí  };
   149‚Üí
   150‚Üí  // Fetch gcon_piece data when gconPieceId is available
   151‚Üí  useEffect(() => {
   152‚Üí    const fetchGconPiece = async () => {
   153‚Üí      if (!user?.id || !gconPieceId) {
   154‚Üí        return;
   155‚Üí      }
   156‚Üí
   157‚Üí      try {
   158‚Üí        // Get user's internal ID first
   159‚Üí        const { data: userData } = await supabase
   160‚Üí          .from('users')
   161‚Üí          .select('id')
   162‚Üí          .eq('auth_id', user.id)
   163‚Üí          .single();
   164‚Üí
   165‚Üí        if (!userData) {
   166‚Üí          setError('User not found');
   167‚Üí          return;
   168‚Üí        }
   169‚Üí
   170‚Üí        // Fetch the gcon_piece
   171‚Üí        const { data: gconData, error: gconError } = await supabase
   172‚Üí          .from('gcon_pieces')
   173‚Üí          .select('id, asn_sitespren_base, mud_title, h1title, pelementor_cached, pelementor_edits, g_post_id, asn_image_plan_batch_id, post_name, pageslug, pageurl')
   174‚Üí          .eq('id', gconPieceId)
   175‚Üí          .eq('fk_users_id', userData.id)
   176‚Üí          .single();
   177‚Üí
   178‚Üí        if (gconError) {
   179‚Üí          setError('Content piece not found');
   180‚Üí          return;
   181‚Üí        }
   182‚Üí
   183‚Üí        setGconPiece(gconData);
   184‚Üí      } catch (err) {
   185‚Üí        console.error('Error fetching gcon_piece:', err);
   186‚Üí        setError('Failed to load content');
   187‚Üí      }
   188‚Üí    };
   189‚Üí
   190‚Üí    fetchGconPiece();
   191‚Üí  }, [user?.id, gconPieceId, supabase]);
   192‚Üí
   193‚Üí  // Fetch images_plans_batches for current user
   194‚Üí  useEffect(() => {
   195‚Üí    const fetchImagePlansBatches = async () => {
   196‚Üí      if (!user?.id) return;
   197‚Üí
   198‚Üí      try {
   199‚Üí        // Get user's internal ID first
   200‚Üí        const { data: userData } = await supabase
   201‚Üí          .from('users')
   202‚Üí          .select('id')
   203‚Üí          .eq('auth_id', user.id)
   204‚Üí          .single();
   205‚Üí
   206‚Üí        if (!userData) return;
   207‚Üí
   208‚Üí        // Fetch images_plans_batches for this user
   209‚Üí        const { data: batchesData, error } = await supabase
   210‚Üí          .from('images_plans_batches')
   211‚Üí          .select('*')
   212‚Üí          .eq('rel_users_id', userData.id)
   213‚Üí          .order('created_at', { ascending: false });
   214‚Üí
   215‚Üí        if (error) {
   216‚Üí          console.error('Error fetching images_plans_batches:', error);
   217‚Üí          return;
   218‚Üí        }
   219‚Üí
   220‚Üí        setImagePlansBatches(batchesData || []);
   221‚Üí
   222‚Üí        // Set current selected batch if gconPiece has one
   223‚Üí        if (gconPiece?.asn_image_plan_batch_id) {
   224‚Üí          setSelectedBatchId(gconPiece.asn_image_plan_batch_id);
   225‚Üí        }
   226‚Üí      } catch (err) {
   227‚Üí        console.error('Error in fetchImagePlansBatches:', err);
   228‚Üí      }
   229‚Üí    };
   230‚Üí
   231‚Üí    fetchImagePlansBatches();
   232‚Üí  }, [user?.id, supabase, gconPiece?.asn_image_plan_batch_id]);
   233‚Üí
   234‚Üí  // Set browser title based on gcon_piece data
   235‚Üí  useEffect(() => {
   236‚Üí    if (gconPiece?.asn_sitespren_base) {
   237‚Üí      document.title = 'tornado_' + gconPiece.asn_sitespren_base;
   238‚Üí    } else if (gconPieceId) {
   239‚Üí      document.title = 'tornado';
   240‚Üí    } else {
   241‚Üí      document.title = 'tornado';
   242‚Üí    }
   243‚Üí  }, [gconPiece?.asn_sitespren_base, gconPieceId]);
   244‚Üí
   245‚Üí  // Handle accordion state change
   246‚Üí  const handleAccordionToggle = (open: boolean) => {
   247‚Üí    setIsTopAreaOpen(open);
   248‚Üí    
   249‚Üí    // Save to localStorage
   250‚Üí    localStorage.setItem('tornado_zarno1_state', open ? 'open' : 'closed');
   251‚Üí    
   252‚Üí    // Update URL parameter
   253‚Üí    const url = new URL(window.location.href);
   254‚Üí    url.searchParams.set('zarno1', open ? 'open' : 'closed');
   255‚Üí    window.history.replaceState({}, '', url.toString());
   256‚Üí  };
   257‚Üí
   258‚Üí  // Handle populate nemtor_units
   259‚Üí  const handlePopulateNemtorUnits = async () => {
   260‚Üí    if (!gconPieceId) {
   261‚Üí      setPopulateMessage('Error: No gcon_piece_id available');
   262‚Üí      return;
   263‚Üí    }
   264‚Üí
   265‚Üí    setIsPopulatingUnits(true);
   266‚Üí    setPopulateMessage(null);
   267‚Üí
   268‚Üí    try {
   269‚Üí      const response = await fetch('/api/populate-nemtor-units', {
   270‚Üí        method: 'POST',
   271‚Üí        headers: {
   272‚Üí          'Content-Type': 'application/json',
   273‚Üí        },
   274‚Üí        body: JSON.stringify({
   275‚Üí          gcon_piece_id: gconPieceId
   276‚Üí        }),
   277‚Üí      });
   278‚Üí
   279‚Üí      const result = await response.json();
   280‚Üí
   281‚Üí      if (response.ok) {
   282‚Üí        setPopulateMessage(`‚úÖ ${result.message}`);
   283‚Üí      } else {
   284‚Üí        setPopulateMessage(`‚ùå Error: ${result.error}`);
   285‚Üí      }
   286‚Üí    } catch (error) {
   287‚Üí      console.error('Error populating nemtor_units:', error);
   288‚Üí      setPopulateMessage('‚ùå Error: Failed to populate nemtor_units');
   289‚Üí    } finally {
   290‚Üí      setIsPopulatingUnits(false);
   291‚Üí      // Clear message after 5 seconds
   292‚Üí      setTimeout(() => setPopulateMessage(null), 5000);
   293‚Üí    }
   294‚Üí  };
   295‚Üí
   296‚Üí  // Handle f22 function
   297‚Üí  const handleRunF22 = async () => {
   298‚Üí    if (!gconPieceId) {
   299‚Üí      setF22Report('Error: No gcon_piece_id available');
   300‚Üí      return;
   301‚Üí    }
   302‚Üí
   303‚Üí    setIsRunningF22(true);
   304‚Üí    setF22Report('Starting F22 processing...');
   305‚Üí
   306‚Üí    try {
   307‚Üí      const response = await fetch('/api/f22-gcon-piece-processor', {
   308‚Üí        method: 'POST',
   309‚Üí        headers: {
   310‚Üí          'Content-Type': 'application/json',
   311‚Üí        },
   312‚Üí        body: JSON.stringify({
   313‚Üí          gcon_piece_id: gconPieceId
   314‚Üí        }),
   315‚Üí      });
   316‚Üí
   317‚Üí      const result = await response.json();
   318‚Üí
   319‚Üí      if (response.ok) {
   320‚Üí        setF22Report(result.message || 'F22 function completed successfully');
   321‚Üí        
   322‚Üí        // Refresh the gcon_piece data to get updated values
   323‚Üí        if (user?.id) {
   324‚Üí          const { data: userData } = await supabase
   325‚Üí            .from('users')
   326‚Üí            .select('id')
   327‚Üí            .eq('auth_id', user.id)
   328‚Üí            .single();
   329‚Üí
   330‚Üí          if (userData) {
   331‚Üí            const { data: refreshedData } = await supabase
   332‚Üí              .from('gcon_pieces')
   333‚Üí              .select('id, asn_sitespren_base, mud_title, h1title, pelementor_cached, pelementor_edits, asn_image_plan_batch_id, post_name, pageslug, pageurl')
   334‚Üí              .eq('id', gconPieceId)
   335‚Üí              .eq('fk_users_id', userData.id)
   336‚Üí              .single();
   337‚Üí
   338‚Üí            if (refreshedData) {
   339‚Üí              setGconPiece(refreshedData);
   340‚Üí            }
   341‚Üí          }
   342‚Üí        }
   343‚Üí      } else {
   344‚Üí        setF22Report(`Error: ${result.error || 'F22 function failed'}`);
   345‚Üí      }
   346‚Üí    } catch (error) {
   347‚Üí      console.error('Error running F22:', error);
   348‚Üí      setF22Report('Error: Failed to run F22 function');
   349‚Üí    } finally {
   350‚Üí      setIsRunningF22(false);
   351‚Üí    }
   352‚Üí  };
   353‚Üí
   354‚Üí  // Copy functions
   355‚Üí  const handleCopyPelementorCached = () => {
   356‚Üí    if (gconPiece?.pelementor_cached) {
   357‚Üí      const content = typeof gconPiece.pelementor_cached === 'string' 
   358‚Üí        ? gconPiece.pelementor_cached 
   359‚Üí        : JSON.stringify(gconPiece.pelementor_cached, null, 2);
   360‚Üí      navigator.clipboard.writeText(content);
   361‚Üí    }
   362‚Üí  };
   363‚Üí
   364‚Üí  const handleCopyPelementorEdits = () => {
   365‚Üí    if (gconPiece?.pelementor_edits) {
   366‚Üí      const content = typeof gconPiece.pelementor_edits === 'string' 
   367‚Üí        ? gconPiece.pelementor_edits 
   368‚Üí        : JSON.stringify(gconPiece.pelementor_edits, null, 2);
   369‚Üí      navigator.clipboard.writeText(content);
   370‚Üí    }
   371‚Üí  };
   372‚Üí
   373‚Üí  const handleCopyF22Report = () => {
   374‚Üí    if (f22Report) {
   375‚Üí      navigator.clipboard.writeText(f22Report);
   376‚Üí    }
   377‚Üí  };
   378‚Üí
   379‚Üí  // Handle saving image plan batch
   380‚Üí  const handleSaveImagePlanBatch = async () => {
   381‚Üí    if (!gconPieceId || !selectedBatchId) {
   382‚Üí      alert('Please select an image plan batch first');
   383‚Üí      return;
   384‚Üí    }
   385‚Üí
   386‚Üí    setIsSavingBatch(true);
   387‚Üí
   388‚Üí    try {
   389‚Üí      const { error } = await supabase
   390‚Üí        .from('gcon_pieces')
   391‚Üí        .update({ asn_image_plan_batch_id: selectedBatchId })
   392‚Üí        .eq('id', gconPieceId);
   393‚Üí
   394‚Üí      if (error) {
   395‚Üí        throw error;
   396‚Üí      }
   397‚Üí
   398‚Üí      // Update local state
   399‚Üí      setGconPiece((prev: any) => prev ? { ...prev, asn_image_plan_batch_id: selectedBatchId } : prev);
   400‚Üí      
   401‚Üí      alert('Image plan batch saved successfully!');
   402‚Üí    } catch (error) {
   403‚Üí      console.error('Error saving image plan batch:', error);
   404‚Üí      alert('Failed to save image plan batch');
   405‚Üí    } finally {
   406‚Üí      setIsSavingBatch(false);
   407‚Üí    }
   408‚Üí  };
   409‚Üí
   410‚Üí  // Helper function to recursively find and update Elementor element by ID
   411‚Üí  const updateElementorImageById = (elementorData: any, targetElId: string, imageUrl: string, imageId: string): boolean => {
   412‚Üí    let updated = false;
   413‚Üí    
   414‚Üí    // Recursive function to traverse the Elementor structure
   415‚Üí    const traverseElements = (elements: any[]): boolean => {
   416‚Üí      if (!Array.isArray(elements)) return false;
   417‚Üí      
   418‚Üí      for (const element of elements) {
   419‚Üí        // Check if this is the target element
   420‚Üí        if (element.id === targetElId) {
   421‚Üí          console.log(`üéØ Found target element ${targetElId}, checking for image settings...`);
   422‚Üí          // Update image data in this element's settings
   423‚Üí          if (element.settings) {
   424‚Üí            // Handle different image property patterns
   425‚Üí            if (element.settings.image) {
   426‚Üí              if (typeof element.settings.image === 'object') {
   427‚Üí                element.settings.image.url = imageUrl;
   428‚Üí                element.settings.image.id = parseInt(imageId);
   429‚Üí              } else {
   430‚Üí                element.settings.image = {
   431‚Üí                  url: imageUrl,
   432‚Üí                  id: parseInt(imageId)
   433‚Üí                };
   434‚Üí              }
   435‚Üí              updated = true;
   436‚Üí            }
   437‚Üí            
   438‚Üí            // Handle background image
   439‚Üí            if (element.settings.background_image) {
   440‚Üí              if (typeof element.settings.background_image === 'object') {
   441‚Üí                element.settings.background_image.url = imageUrl;
   442‚Üí                element.settings.background_image.id = parseInt(imageId);
   443‚Üí              } else {
   444‚Üí                element.settings.background_image = {
   445‚Üí                  url: imageUrl,
   446‚Üí                  id: parseInt(imageId)
   447‚Üí                };
   448‚Üí              }
   449‚Üí              updated = true;
   450‚Üí            }
   451‚Üí            
   452‚Üí            // Handle other common image properties
   453‚Üí            ['background_background', '_background_background'].forEach(prop => {
   454‚Üí              if (element.settings[prop] === 'classic' && element.settings[prop + '_image']) {
   455‚Üí                if (typeof element.settings[prop + '_image'] === 'object') {
   456‚Üí                  element.settings[prop + '_image'].url = imageUrl;
   457‚Üí                  element.settings[prop + '_image'].id = parseInt(imageId);
   458‚Üí                } else {
   459‚Üí                  element.settings[prop + '_image'] = {
   460‚Üí                    url: imageUrl,
   461‚Üí                    id: parseInt(imageId)
   462‚Üí                  };
   463‚Üí                }
   464‚Üí                updated = true;
   465‚Üí              }
   466‚Üí            });
   467‚Üí          }
   468‚Üí          
   469‚Üí          return true; // Found and processed the target element
   470‚Üí        }
   471‚Üí        
   472‚Üí        // Recursively check child elements
   473‚Üí        if (element.elements && Array.isArray(element.elements)) {
   474‚Üí          if (traverseElements(element.elements)) {
   475‚Üí            updated = true;
   476‚Üí          }
   477‚Üí        }
   478‚Üí      }
   479‚Üí      
   480‚Üí      return updated;
   481‚Üí    };
   482‚Üí    
   483‚Üí    // Start traversal from root
   484‚Üí    if (Array.isArray(elementorData)) {
   485‚Üí      return traverseElements(elementorData);
   486‚Üí    }
   487‚Üí    
   488‚Üí    return false;
   489‚Üí  };
   490‚Üí
   491‚Üí  // Handle compile new_desired_text_content into pelementor_edits
   492‚Üí  const handleCompileTextContent = async () => {
   493‚Üí    if (!gconPieceId || !gconPiece) {
   494‚Üí      alert('No gcon_piece found to process');
   495‚Üí      return;
   496‚Üí    }
   497‚Üí
   498‚Üí    if (!gconPiece.pelementor_cached) {
   499‚Üí      alert('No pelementor_cached data found to use as starting point');
   500‚Üí      return;
   501‚Üí    }
   502‚Üí
   503‚Üí    setIsCompilingTextContent(true);
   504‚Üí
   505‚Üí    try {
   506‚Üí      // Step 1: Start with pelementor_cached as our base for pelementor_edits
   507‚Üí      // Ensure we're working with a string, not an object
   508‚Üí      let pelementorEditsContent = typeof gconPiece.pelementor_cached === 'string' 
   509‚Üí        ? gconPiece.pelementor_cached 
   510‚Üí        : JSON.stringify(gconPiece.pelementor_cached);
   511‚Üí
   512‚Üí      // Step 2: Fetch all nemtor_units for this gcon_piece
   513‚Üí      const { data: nemtorUnits, error: nemtorError } = await supabase
   514‚Üí        .from('nemtor_units')
   515‚Üí        .select('unit_id, full_text_cached, full_text_edits, has_img_slot, el_id')
   516‚Üí        .eq('fk_gcon_piece_id', gconPieceId);
   517‚Üí
   518‚Üí      if (nemtorError) {
   519‚Üí        console.error('Error fetching nemtor_units:', nemtorError);
   520‚Üí        throw nemtorError;
   521‚Üí      }
   522‚Üí
   523‚Üí      if (!nemtorUnits || nemtorUnits.length === 0) {
   524‚Üí        alert('No nemtor_units found for this gcon_piece');
   525‚Üí        return;
   526‚Üí      }
   527‚Üí
   528‚Üí      // Step 3: Process units that have full_text_edits values
   529‚Üí      let replacementsCount = 0;
   530‚Üí      const replacements: { original: string; replacement: string; unitId: string }[] = [];
   531‚Üí
   532‚Üí      nemtorUnits.forEach(unit => {
   533‚Üí        // Only process if full_text_edits has a real value (not null, empty, or whitespace)
   534‚Üí        if (unit.full_text_edits && unit.full_text_edits.trim() !== '') {
   535‚Üí          // Only process if we also have original full_text_cached to replace
   536‚Üí          if (unit.full_text_cached && unit.full_text_cached.trim() !== '') {
   537‚Üí            // Replace full_text_cached with full_text_edits in pelementorEditsContent
   538‚Üí            const originalText = unit.full_text_cached;
   539‚Üí            const newText = unit.full_text_edits;
   540‚Üí            
   541‚Üí            // Check if the original text exists in pelementorEditsContent
   542‚Üí            if (pelementorEditsContent.includes(originalText)) {
   543‚Üí              pelementorEditsContent = pelementorEditsContent.replace(originalText, newText);
   544‚Üí              replacementsCount++;
   545‚Üí              replacements.push({
   546‚Üí                original: originalText.substring(0, 100) + (originalText.length > 100 ? '...' : ''),
   547‚Üí                replacement: newText.substring(0, 100) + (newText.length > 100 ? '...' : ''),
   548‚Üí                unitId: unit.unit_id
   549‚Üí              });
   550‚Üí            }
   551‚Üí          }
   552‚Üí        }
   553‚Üí      });
   554‚Üí
   555‚Üí      // Step 4: Process manual image inputs (includes active checkboxes for man_img_url and man_img_id)
   556‚Üí      let imageReplacementsCount = 0;
   557‚Üí      if (manualImageDataRef.current) {
   558‚Üí        const { urls, ids, checkboxes } = manualImageDataRef.current;
   559‚Üí        
   560‚Üí        try {
   561‚Üí          // Parse the Elementor JSON to work with structured data
   562‚Üí          const elementorData = JSON.parse(pelementorEditsContent);
   563‚Üí          
   564‚Üí          nemtorUnits.forEach(unit => {
   565‚Üí            // Only process units that have has_img_slot = true AND checkbox is checked
   566‚Üí            if (unit.has_img_slot === true && checkboxes.get(unit.unit_id)) {
   567‚Üí              const manualUrl = urls.get(unit.unit_id);
   568‚Üí              const manualId = ids.get(unit.unit_id);
   569‚Üí              
   570‚Üí              // Only proceed if we have both URL and ID and el_id
   571‚Üí              if (manualUrl && manualUrl.trim() !== '' && manualId && manualId.trim() !== '' && unit.el_id) {
   572‚Üí                console.log(`üñºÔ∏è Processing image for unit ${unit.unit_id}, el_id: ${unit.el_id}, URL: ${manualUrl}, ID: ${manualId}`);
   573‚Üí                
   574‚Üí                // Find and update the specific element by el_id
   575‚Üí                const updated = updateElementorImageById(elementorData, unit.el_id, manualUrl, manualId);
   576‚Üí                
   577‚Üí                if (updated) {
   578‚Üí                  console.log(`‚úÖ Successfully updated image for element ${unit.el_id}`);
   579‚Üí                  imageReplacementsCount++;
   580‚Üí                  replacements.push({
   581‚Üí                    original: `Image in element ${unit.el_id}`,
   582‚Üí                    replacement: `URL: ${manualUrl.substring(0, 50)}${manualUrl.length > 50 ? '...' : ''}, ID: ${manualId}`,
   583‚Üí                    unitId: unit.unit_id
   584‚Üí                  });
   585‚Üí                } else {
   586‚Üí                  console.log(`‚ùå Could not find/update element with ID: ${unit.el_id}`);
   587‚Üí                }
   588‚Üí              } else {
   589‚Üí                console.log(`‚ö†Ô∏è Skipping unit ${unit.unit_id}: missing data - URL: ${!!manualUrl}, ID: ${!!manualId}, el_id: ${!!unit.el_id}`);
   590‚Üí              }
   591‚Üí            }
   592‚Üí          });
   593‚Üí          
   594‚Üí          // Convert back to string
   595‚Üí          pelementorEditsContent = JSON.stringify(elementorData);
   596‚Üí          
   597‚Üí        } catch (jsonError) {
   598‚Üí          console.error('Error parsing Elementor JSON:', jsonError);
   599‚Üí          // Fall back to string-based approach if JSON parsing fails
   600‚Üí          console.log('Falling back to string-based image replacement...');
   601‚Üí        }
   602‚Üí      }
   603‚Üí
   604‚Üí      // Step 5: Update pelementor_edits in database
   605‚Üí      // Convert back to object if original was an object, or keep as string
   606‚Üí      const pelementorEditsForDb = typeof gconPiece.pelementor_cached === 'object' 
   607‚Üí        ? JSON.parse(pelementorEditsContent)
   608‚Üí        : pelementorEditsContent;
   609‚Üí
   610‚Üí      const { error: updateError } = await supabase
   611‚Üí        .from('gcon_pieces')
   612‚Üí        .update({ pelementor_edits: pelementorEditsForDb })
   613‚Üí        .eq('id', gconPieceId);
   614‚Üí
   615‚Üí      if (updateError) {
   616‚Üí        console.error('Error updating pelementor_edits:', updateError);
   617‚Üí        throw updateError;
   618‚Üí      }
   619‚Üí
   620‚Üí      // Step 6: Update local state
   621‚Üí      setGconPiece((prev: any) => prev ? { ...prev, pelementor_edits: pelementorEditsForDb } : prev);
   622‚Üí
   623‚Üí      // Step 7: Show success message with details
   624‚Üí      const totalReplacements = replacementsCount + imageReplacementsCount;
   625‚Üí      const successMessage = `Successfully compiled content!\n\nText replacements: ${replacementsCount}\nImage replacements: ${imageReplacementsCount}\nTotal replacements: ${totalReplacements}\n\n` +
   626‚Üí        replacements.map(r => `‚Ä¢ Unit ${r.unitId.substring(0, 8)}...\n  FROM: ${r.original}\n  TO: ${r.replacement}`).join('\n\n');
   627‚Üí      
   628‚Üí      alert(successMessage);
   629‚Üí
   630‚Üí    } catch (error) {
   631‚Üí      console.error('Error compiling text content:', error);
   632‚Üí      alert('Failed to compile text content. Please try again.');
   633‚Üí    } finally {
   634‚Üí      setIsCompilingTextContent(false);
   635‚Üí    }
   636‚Üí  };
   637‚Üí
   638‚Üí  // Handle run dublish function
   639‚Üí  const handleRunDublish = async () => {
   640‚Üí    if (!gconPieceId || !gconPiece) {
   641‚Üí      alert('No gcon_piece found to process');
   642‚Üí      return;
   643‚Üí    }
   644‚Üí
   645‚Üí    if (!gconPiece.pelementor_edits) {
   646‚Üí      alert('No pelementor_edits data found. Please compile text content first.');
   647‚Üí      return;
   648‚Üí    }
   649‚Üí
   650‚Üí    if (!gconPiece.asn_sitespren_base) {
   651‚Üí      alert('No asn_sitespren_base found. Cannot determine target WordPress site.');
   652‚Üí      return;
   653‚Üí    }
   654‚Üí
   655‚Üí    setIsRunningDublish(true);
   656‚Üí    setDublishProgress('Initializing...');
   657‚Üí    setDublishResult(null);
   658‚Üí
   659‚Üí    try {
   660‚Üí      // Step 1: Prepare Elementor page data
   661‚Üí      setDublishProgress('Preparing Elementor page data...');
   662‚Üí      
   663‚Üí      const pageTitle = gconPiece.h1title || gconPiece.mud_title || 'New Elementor Page';
   664‚Üí      const pageSlug = gconPiece.pageslug || gconPiece.post_name || 'new-elementor-page';
   665‚Üí      const elementorData = gconPiece.pelementor_edits;
   666‚Üí
   667‚Üí      // Step 2: Create WordPress post
   668‚Üí      setDublishProgress('Creating WordPress post...');
   669‚Üí      
   670‚Üí      let apiResponse;
   671‚Üí      
   672‚Üí      switch (dublishConnectionType) {
   673‚Üí        case 'snefuruplin':
   674‚Üí          // Use Snefuruplin WP Plugin
   675‚Üí          setDublishProgress('Connecting via Snefuruplin WP Plugin...');
   676‚Üí          apiResponse = await createElementorPageViaSnefuruplin({
   677‚Üí            siteUrl: gconPiece.asn_sitespren_base,
   678‚Üí            title: pageTitle,
   679‚Üí            slug: pageSlug,
   680‚Üí            elementorData: elementorData,
   681‚Üí            gconPieceId: gconPieceId
   682‚Üí          });
   683‚Üí          break;
   684‚Üí          
   685‚Üí        case 'rest_api':
   686‚Üí          // Use WordPress REST API
   687‚Üí          setDublishProgress('Connecting via WordPress REST API...');
   688‚Üí          apiResponse = await createElementorPageViaRestAPI({
   689‚Üí            siteUrl: gconPiece.asn_sitespren_base,
   690‚Üí            title: pageTitle,
   691‚Üí            slug: pageSlug,
   692‚Üí            elementorData: elementorData,
   693‚Üí            gconPieceId: gconPieceId
   694‚Üí          });
   695‚Üí          break;
   696‚Üí          
   697‚Üí        case 'api_other':
   698‚Üí          // Use other API method
   699‚Üí          setDublishProgress('Connecting via alternative API...');
   700‚Üí          apiResponse = await createElementorPageViaOtherAPI({
   701‚Üí            siteUrl: gconPiece.asn_sitespren_base,
   702‚Üí            title: pageTitle,
   703‚Üí            slug: pageSlug,
   704‚Üí            elementorData: elementorData,
   705‚Üí            gconPieceId: gconPieceId
   706‚Üí          });
   707‚Üí          break;
   708‚Üí          
   709‚Üí        default:
   710‚Üí          throw new Error('Invalid connection type selected');
   711‚Üí      }
   712‚Üí
   713‚Üí      // Step 3: Process response
   714‚Üí      setDublishProgress('Processing response...');
   715‚Üí      
   716‚Üí      if (apiResponse.success) {
   717‚Üí        const wpEditorUrl = `https://${gconPiece.asn_sitespren_base}/wp-admin/post.php?post=${apiResponse.postId}&action=elementor`;
   718‚Üí        const liveUrl = `https://${gconPiece.asn_sitespren_base}/${pageSlug}`;
   719‚Üí        
   720‚Üí        setDublishResult({
   721‚Üí          success: true,
   722‚Üí          wpEditorUrl,
   723‚Üí          liveUrl,
   724‚Üí          postId: apiResponse.postId,
   725‚Üí          message: `Successfully created Elementor page "${pageTitle}"`
   726‚Üí        });
   727‚Üí        
   728‚Üí        setDublishProgress('‚úÖ Page created successfully!');
   729‚Üí      } else {
   730‚Üí        throw new Error(apiResponse.message || 'Failed to create page');
   731‚Üí      }
   732‚Üí
   733‚Üí    } catch (error) {
   734‚Üí      console.error('Error running dublish function:', error);
   735‚Üí      setDublishResult({
   736‚Üí        success: false,
   737‚Üí        message: error instanceof Error ? error.message : 'Unknown error occurred'
   738‚Üí      });
   739‚Üí      setDublishProgress('‚ùå Failed to create page');
   740‚Üí    } finally {
   741‚Üí      setIsRunningDublish(false);
   742‚Üí    }
   743‚Üí  };
   744‚Üí
   745‚Üí  // Snefuruplin WP Plugin implementation
   746‚Üí  const createElementorPageViaSnefuruplin = async (params: {
   747‚Üí    siteUrl: string;
   748‚Üí    title: string;
   749‚Üí    slug: string;
   750‚Üí    elementorData: string;
   751‚Üí    gconPieceId: string;
   752‚Üí  }) => {
   753‚Üí    // This would connect to your custom WordPress plugin
   754‚Üí    const response = await fetch('/api/dublish-create-elementor-page', {
   755‚Üí      method: 'POST',
   756‚Üí      headers: {
   757‚Üí        'Content-Type': 'application/json',
   758‚Üí      },
   759‚Üí      body: JSON.stringify({
   760‚Üí        site_url: params.siteUrl,
   761‚Üí        post_title: params.title,
   762‚Üí        post_name: params.slug,
   763‚Üí        post_status: 'publish',
   764‚Üí        post_type: 'page',
   765‚Üí        elementor_data: params.elementorData,
   766‚Üí        gcon_piece_id: params.gconPieceId,
   767‚Üí        // Elementor-specific meta fields
   768‚Üí        meta_input: {
   769‚Üí          '_elementor_edit_mode': 'builder',
   770‚Üí          '_elementor_template_type': 'wp-page',
   771‚Üí          '_elementor_version': '3.17.0',
   772‚Üí          '_elementor_pro_version': '3.17.0',
   773‚Üí          '_elementor_data': params.elementorData,
   774‚Üí          '_elementor_page_settings': JSON.stringify({
   775‚Üí            "custom_css": "",
   776‚Üí            "page_title": "hide",
   777‚Üí            "page_description": "hide"
   778‚Üí          }),
   779‚Üí          '_wp_page_template': 'default'
   780‚Üí        }
   781‚Üí      })
   782‚Üí    });
   783‚Üí
   784‚Üí    return await response.json();
   785‚Üí  };
   786‚Üí
   787‚Üí  // WordPress REST API implementation
   788‚Üí  const createElementorPageViaRestAPI = async (params: {
   789‚Üí    siteUrl: string;
   790‚Üí    title: string;
   791‚Üí    slug: string;
   792‚Üí    elementorData: string;
   793‚Üí    gconPieceId: string;
   794‚Üí  }) => {
   795‚Üí    // Step 1: Create the post via REST API
   796‚Üí    const createPostResponse = await fetch(`https://${params.siteUrl}/wp-json/wp/v2/pages`, {
   797‚Üí      method: 'POST',
   798‚Üí      headers: {
   799‚Üí        'Content-Type': 'application/json',
   800‚Üí        'Authorization': 'Bearer YOUR_WP_TOKEN', // You'll need to implement auth
   801‚Üí      },
   802‚Üí      body: JSON.stringify({
   803‚Üí        title: params.title,
   804‚Üí        slug: params.slug,
   805‚Üí        status: 'publish',
   806‚Üí        template: 'elementor_header_footer'
   807‚Üí      })
   808‚Üí    });
   809‚Üí
   810‚Üí    const post = await createPostResponse.json();
   811‚Üí    
   812‚Üí    if (!createPostResponse.ok) {
   813‚Üí      throw new Error(post.message || 'Failed to create post');
   814‚Üí    }
   815‚Üí
   816‚Üí    // Step 2: Add Elementor meta data
   817‚Üí    const metaUpdates = [
   818‚Üí      { key: '_elementor_edit_mode', value: 'builder' },
   819‚Üí      { key: '_elementor_template_type', value: 'wp-page' },
   820‚Üí      { key: '_elementor_version', value: '3.17.0' },
   821‚Üí      { key: '_elementor_data', value: params.elementorData },
   822‚Üí      { key: '_elementor_page_settings', value: JSON.stringify({
   823‚Üí        "custom_css": "",
   824‚Üí        "page_title": "hide", 
   825‚Üí        "page_description": "hide"
   826‚Üí      }) }
   827‚Üí    ];
   828‚Üí
   829‚Üí    for (const meta of metaUpdates) {
   830‚Üí      await fetch(`https://${params.siteUrl}/wp-json/wp/v2/pages/${post.id}/meta`, {
   831‚Üí        method: 'POST',
   832‚Üí        headers: {
   833‚Üí          'Content-Type': 'application/json',
   834‚Üí          'Authorization': 'Bearer YOUR_WP_TOKEN',
   835‚Üí        },
   836‚Üí        body: JSON.stringify(meta)
   837‚Üí      });
   838‚Üí    }
   839‚Üí
   840‚Üí    return {
   841‚Üí      success: true,
   842‚Üí      postId: post.id,
   843‚Üí      message: 'Page created successfully via REST API'
   844‚Üí    };
   845‚Üí  };
   846‚Üí
   847‚Üí  // Alternative API implementation
   848‚Üí  const createElementorPageViaOtherAPI = async (params: {
   849‚Üí    siteUrl: string;
   850‚Üí    title: string;
   851‚Üí    slug: string;
   852‚Üí    elementorData: string;
   853‚Üí    gconPieceId: string;
   854‚Üí  }) => {
   855‚Üí    // This could be a custom API endpoint you create
   856‚Üí    const response = await fetch('/api/wordpress/create-elementor-page', {
   857‚Üí      method: 'POST',
   858‚Üí      headers: {
   859‚Üí        'Content-Type': 'application/json',
   860‚Üí      },
   861‚Üí      body: JSON.stringify({
   862‚Üí        target_site: params.siteUrl,
   863‚Üí        page_data: {
   864‚Üí          post_title: params.title,
   865‚Üí          post_name: params.slug,
   866‚Üí          post_status: 'publish',
   867‚Üí          post_type: 'page',
   868‚Üí          post_content: '', // Elementor uses meta, not content
   869‚Üí          meta_input: {
   870‚Üí            '_elementor_edit_mode': 'builder',
   871‚Üí            '_elementor_template_type': 'wp-page',
   872‚Üí            '_elementor_version': '3.17.0',
   873‚Üí            '_elementor_data': params.elementorData,
   874‚Üí            '_wp_page_template': 'default'
   875‚Üí          }
   876‚Üí        },
   877‚Üí        gcon_piece_id: params.gconPieceId
   878‚Üí      })
   879‚Üí    });
   880‚Üí
   881‚Üí    return await response.json();
   882‚Üí  };
   883‚Üí
   884‚Üí  // Handle run snoverride function
   885‚Üí  const handleRunSnoverride = async () => {
   886‚Üí    if (!gconPieceId || !gconPiece) {
   887‚Üí      alert('No gcon_piece found to process');
   888‚Üí      return;
   889‚Üí    }
   890‚Üí
   891‚Üí    if (!gconPiece.pelementor_edits) {
   892‚Üí      alert('No pelementor_edits data found. Please compile text content first.');
   893‚Üí      return;
   894‚Üí    }
   895‚Üí
   896‚Üí    if (!gconPiece.asn_sitespren_base) {
   897‚Üí      alert('No asn_sitespren_base found. Cannot determine target WordPress site.');
   898‚Üí      return;
   899‚Üí    }
   900‚Üí
   901‚Üí    if (!gconPiece.g_post_id) {
   902‚Üí      alert('No g_post_id found. Cannot identify which WordPress post to update.');
   903‚Üí      return;
   904‚Üí    }
   905‚Üí
   906‚Üí    setIsRunningSnoverride(true);
   907‚Üí    setSnoverrideProgress('Initializing...');
   908‚Üí    setSnoverrideResult(null);
   909‚Üí
   910‚Üí    try {
   911‚Üí      // Step 1: Prepare update data
   912‚Üí      setSnoverrideProgress('Preparing Elementor page update...');
   913‚Üí      
   914‚Üí      const pageTitle = gconPiece.h1title || gconPiece.mud_title || 'Updated Elementor Page';
   915‚Üí      const elementorData = gconPiece.pelementor_edits;
   916‚Üí      const postId = gconPiece.g_post_id;
   917‚Üí
   918‚Üí      // Step 2: Update WordPress post
   919‚Üí      setSnoverrideProgress('Updating WordPress post...');
   920‚Üí      
   921‚Üí      let apiResponse;
   922‚Üí      
   923‚Üí      switch (snoverrideConnectionType) {
   924‚Üí        case 'snefuruplin':
   925‚Üí          // Use Snefuruplin WP Plugin
   926‚Üí          setSnoverrideProgress('Connecting via Snefuruplin WP Plugin...');
   927‚Üí          apiResponse = await updateElementorPageViaSnefuruplin({
   928‚Üí            siteUrl: gconPiece.asn_sitespren_base,
   929‚Üí            postId: postId,
   930‚Üí            title: pageTitle,
   931‚Üí            elementorData: elementorData,
   932‚Üí            gconPieceId: gconPieceId
   933‚Üí          });
   934‚Üí          break;
   935‚Üí          
   936‚Üí        case 'rest_api':
   937‚Üí          // Use WordPress REST API
   938‚Üí          setSnoverrideProgress('Connecting via WordPress REST API...');
   939‚Üí          apiResponse = await updateElementorPageViaRestAPI({
   940‚Üí            siteUrl: gconPiece.asn_sitespren_base,
   941‚Üí            postId: postId,
   942‚Üí            title: pageTitle,
   943‚Üí            elementorData: elementorData,
   944‚Üí            gconPieceId: gconPieceId
   945‚Üí          });
   946‚Üí          break;
   947‚Üí          
   948‚Üí        case 'api_other':
   949‚Üí          // Use other API method
   950‚Üí          setSnoverrideProgress('Connecting via alternative API...');
   951‚Üí          apiResponse = await updateElementorPageViaOtherAPI({
   952‚Üí            siteUrl: gconPiece.asn_sitespren_base,
   953‚Üí            postId: postId,
   954‚Üí            title: pageTitle,
   955‚Üí            elementorData: elementorData,
   956‚Üí            gconPieceId: gconPieceId
   957‚Üí          });
   958‚Üí          break;
   959‚Üí          
   960‚Üí        default:
   961‚Üí          throw new Error('Invalid connection type selected');
   962‚Üí      }
   963‚Üí
   964‚Üí      // Step 3: Process response
   965‚Üí      setSnoverrideProgress('Processing response...');
   966‚Üí      
   967‚Üí      if (apiResponse.success) {
   968‚Üí        const wpEditorUrl = `https://${gconPiece.asn_sitespren_base}/wp-admin/post.php?post=${postId}&action=elementor`;
   969‚Üí        const liveUrl = `https://${gconPiece.asn_sitespren_base}/?p=${postId}`;
   970‚Üí        
   971‚Üí        setSnoverrideResult({
   972‚Üí          success: true,
   973‚Üí          wpEditorUrl,
   974‚Üí          liveUrl,
   975‚Üí          postId: postId,
   976‚Üí          message: `Successfully updated Elementor page "${pageTitle}"`
   977‚Üí        });
   978‚Üí        
   979‚Üí        setSnoverrideProgress('‚úÖ Page updated successfully!');
   980‚Üí      } else {
   981‚Üí        throw new Error(apiResponse.message || 'Failed to update page');
   982‚Üí      }
   983‚Üí
   984‚Üí    } catch (error) {
   985‚Üí      console.error('Error running snoverride function:', error);
   986‚Üí      setSnoverrideResult({
   987‚Üí        success: false,
   988‚Üí        message: error instanceof Error ? error.message : 'Unknown error occurred'
   989‚Üí      });
   990‚Üí      setSnoverrideProgress('‚ùå Failed to update page');
   991‚Üí    } finally {
   992‚Üí      setIsRunningSnoverride(false);
   993‚Üí    }
   994‚Üí  };
   995‚Üí
   996‚Üí  // Snefuruplin WP Plugin update implementation
   997‚Üí  const updateElementorPageViaSnefuruplin = async (params: {
   998‚Üí    siteUrl: string;
   999‚Üí    postId: number;
  1000‚Üí    title: string;
  1001‚Üí    elementorData: string;
  1002‚Üí    gconPieceId: string;
  1003‚Üí  }) => {
  1004‚Üí    const response = await fetch('/api/snoverride-update-elementor-page', {
  1005‚Üí      method: 'POST',
  1006‚Üí      headers: {
  1007‚Üí        'Content-Type': 'application/json',
  1008‚Üí      },
  1009‚Üí      body: JSON.stringify({
  1010‚Üí        site_url: params.siteUrl,
  1011‚Üí        post_id: params.postId,
  1012‚Üí        post_title: params.title,
  1013‚Üí        elementor_data: params.elementorData,
  1014‚Üí        gcon_piece_id: params.gconPieceId,
  1015‚Üí        // Update only the elementor data and title
  1016‚Üí        update_fields: {
  1017‚Üí          post_title: params.title,
  1018‚Üí          meta_input: {
  1019‚Üí            '_elementor_data': params.elementorData,
  1020‚Üí            '_elementor_edit_mode': 'builder',
  1021‚Üí            '_elementor_version': '3.17.0'
  1022‚Üí          }
  1023‚Üí        }
  1024‚Üí      })
  1025‚Üí    });
  1026‚Üí
  1027‚Üí    return await response.json();
  1028‚Üí  };
  1029‚Üí
  1030‚Üí  // WordPress REST API update implementation
  1031‚Üí  const updateElementorPageViaRestAPI = async (params: {
  1032‚Üí    siteUrl: string;
  1033‚Üí    postId: number;
  1034‚Üí    title: string;
  1035‚Üí    elementorData: string;
  1036‚Üí    gconPieceId: string;
  1037‚Üí  }) => {
  1038‚Üí    // Step 1: Update the post via REST API
  1039‚Üí    const updatePostResponse = await fetch(`https://${params.siteUrl}/wp-json/wp/v2/pages/${params.postId}`, {
  1040‚Üí      method: 'POST',
  1041‚Üí      headers: {
  1042‚Üí        'Content-Type': 'application/json',
  1043‚Üí        'Authorization': 'Bearer YOUR_WP_TOKEN', // You'll need to implement auth
  1044‚Üí      },
  1045‚Üí      body: JSON.stringify({
  1046‚Üí        title: params.title
  1047‚Üí      })
  1048‚Üí    });
  1049‚Üí
  1050‚Üí    const post = await updatePostResponse.json();
  1051‚Üí    
  1052‚Üí    if (!updatePostResponse.ok) {
  1053‚Üí      throw new Error(post.message || 'Failed to update post');
  1054‚Üí    }
  1055‚Üí
  1056‚Üí    // Step 2: Update Elementor meta data
  1057‚Üí    const metaUpdates = [
  1058‚Üí      { key: '_elementor_data', value: params.elementorData },
  1059‚Üí      { key: '_elementor_edit_mode', value: 'builder' },
  1060‚Üí      { key: '_elementor_version', value: '3.17.0' }
  1061‚Üí    ];
  1062‚Üí
  1063‚Üí    for (const meta of metaUpdates) {
  1064‚Üí      await fetch(`https://${params.siteUrl}/wp-json/wp/v2/pages/${params.postId}/meta`, {
  1065‚Üí        method: 'POST',
  1066‚Üí        headers: {
  1067‚Üí          'Content-Type': 'application/json',
  1068‚Üí          'Authorization': 'Bearer YOUR_WP_TOKEN',
  1069‚Üí        },
  1070‚Üí        body: JSON.stringify(meta)
  1071‚Üí      });
  1072‚Üí    }
  1073‚Üí
  1074‚Üí    return {
  1075‚Üí      success: true,
  1076‚Üí      postId: params.postId,
  1077‚Üí      message: 'Page updated successfully via REST API'
  1078‚Üí    };
  1079‚Üí  };
  1080‚Üí
  1081‚Üí  // Alternative API update implementation
  1082‚Üí  const updateElementorPageViaOtherAPI = async (params: {
  1083‚Üí    siteUrl: string;
  1084‚Üí    postId: number;
  1085‚Üí    title: string;
  1086‚Üí    elementorData: string;
  1087‚Üí    gconPieceId: string;
  1088‚Üí  }) => {
  1089‚Üí    const response = await fetch('/api/wordpress/update-elementor-page', {
  1090‚Üí      method: 'POST',
  1091‚Üí      headers: {
  1092‚Üí        'Content-Type': 'application/json',
  1093‚Üí      },
  1094‚Üí      body: JSON.stringify({
  1095‚Üí        target_site: params.siteUrl,
  1096‚Üí        post_id: params.postId,
  1097‚Üí        update_data: {
  1098‚Üí          post_title: params.title,
  1099‚Üí          meta_input: {
  1100‚Üí            '_elementor_data': params.elementorData,
  1101‚Üí            '_elementor_edit_mode': 'builder',
  1102‚Üí            '_elementor_version': '3.17.0'
  1103‚Üí          }
  1104‚Üí        },
  1105‚Üí        gcon_piece_id: params.gconPieceId
  1106‚Üí      })
  1107‚Üí    });
  1108‚Üí
  1109‚Üí    return await response.json();
  1110‚Üí  };
  1111‚Üí
  1112‚Üí  if (!user) {
  1113‚Üí    return (
  1114‚Üí      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
  1115‚Üí        <p className="text-gray-500">Please log in to access this page.</p>
  1116‚Üí      </div>
  1117‚Üí    );
  1118‚Üí  }
  1119‚Üí
  1120‚Üí  if (loading) {
  1121‚Üí    return (
  1122‚Üí      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
  1123‚Üí        <div className="text-center">
  1124‚Üí          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
  1125‚Üí          <p className="mt-2 text-gray-600">Loading...</p>
  1126‚Üí        </div>
  1127‚Üí      </div>
  1128‚Üí    );
  1129‚Üí  }
  1130‚Üí
  1131‚Üí  if (error) {
  1132‚Üí    return (
  1133‚Üí      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
  1134‚Üí        <div className="text-center">
  1135‚Üí          <p className="text-red-600">Error: {error}</p>
  1136‚Üí        </div>
  1137‚Üí      </div>
  1138‚Üí    );
  1139‚Üí  }
  1140‚Üí
  1141‚Üí  return (
  1142‚Üí    <div className="page-tornado min-h-screen bg-gray-50">
  1143‚Üí      {/* Sticky Menu Component */}
  1144‚Üí      <MarzdiStickyMenu h1Title={gconPiece?.h1title} />
  1145‚Üí      
  1146‚Üí      <div className="p-4">
  1147‚Üí        <div className="mb-4 flex items-center gap-4">
  1148‚Üí          <Link href="/dashboard" className="text-blue-600 hover:text-blue-800">
  1149‚Üí            ‚Üê Back to Dashboard
  1150‚Üí          </Link>
  1151‚Üí          <button
  1152‚Üí            className={`px-4 py-2 font-medium rounded-md transition-colors ${
  1153‚Üí              isPopulatingUnits
  1154‚Üí                ? 'bg-gray-400 cursor-not-allowed text-white'
  1155‚Üí                : 'bg-purple-600 hover:bg-purple-700 text-white'
  1156‚Üí            }`}
  1157‚Üí            onClick={handlePopulateNemtorUnits}
  1158‚Üí            disabled={isPopulatingUnits || !gconPieceId}
  1159‚Üí          >
  1160‚Üí            {isPopulatingUnits ? 'Populating...' : 'handlePopulateNemtorUnit'}
  1161‚Üí          </button>
  1162‚Üí        </div>
  1163‚Üí        
  1164‚Üí        {/* Populate feedback message */}
  1165‚Üí        {populateMessage && (
  1166‚Üí          <div className={`mb-4 p-3 rounded-md ${
  1167‚Üí            populateMessage.startsWith('‚úÖ') 
  1168‚Üí              ? 'bg-green-100 border border-green-400 text-green-700'
  1169‚Üí              : 'bg-red-100 border border-red-400 text-red-700'
  1170‚Üí          }`}>
  1171‚Üí            {populateMessage}
  1172‚Üí          </div>
  1173‚Üí        )}
  1174‚Üí        
  1175‚Üí        {/* Cloned Areas from Mesagen Page */}
  1176‚Üí        {gconPieceId && (
  1177‚Üí          <div className="mb-4">
  1178‚Üí            <div className="flex items-start gap-4" style={{ marginTop: '10px' }}>
  1179‚Üí              {/* AREA 1: Info Box - Cloned from mesagen */}
  1180‚Üí              <div className="bg-gray-50 border border-gray-300 rounded-lg p-4" style={{ width: '450px' }}>
  1181‚Üí                <div className="mb-3">
  1182‚Üí                  <Link href="/gconjar1" className="text-blue-600 hover:text-blue-800">
  1183‚Üí                    ‚Üê Back to GconJar1
  1184‚Üí                  </Link>
  1185‚Üí                </div>
  1186‚Üí                
  1187‚Üí                <div className="mb-3">
  1188‚Üí                  <Link href={`/tornado?gcon_piece_id=${gconPieceId}`} className="text-blue-600 hover:text-blue-800">
  1189‚Üí                    -- Visit /tornado --
  1190‚Üí                  </Link>
  1191‚Üí                </div>
  1192‚Üí                
  1193‚Üí                <div className="mb-3 text-sm text-gray-600">
  1194‚Üí                  <strong>gcon_pieces.id:</strong> {gconPieceId}
  1195‚Üí                </div>
  1196‚Üí
  1197‚Üí                {/* asn_sitespren_base */}
  1198‚Üí                <div className="mb-3">
  1199‚Üí                  <label className="block text-sm font-bold text-gray-700 mb-1">
  1200‚Üí                    asn_sitespren_base
  1201‚Üí                  </label>
  1202‚Üí                  <div className="w-full px-3 py-2 border border-gray-300 rounded bg-gray-50 text-sm">
  1203‚Üí                    {gconPiece?.asn_sitespren_base || 'Not set'}
  1204‚Üí                  </div>
  1205‚Üí                </div>
  1206‚Üí
  1207‚Üí                {/* post_name */}
  1208‚Üí                <div className="mb-3">
  1209‚Üí                  <label className="block text-sm font-bold text-gray-700 mb-1">
  1210‚Üí                    post_name
  1211‚Üí                  </label>
  1212‚Üí                  <div className="flex items-center gap-1 p-2 bg-gray-900 text-green-400 rounded font-mono text-sm border">
  1213‚Üí                    <button
  1214‚Üí                      onClick={() => {
  1215‚Üí                        if (gconPiece?.asn_sitespren_base && gconPiece?.post_name) {
  1216‚Üí                          window.open(`https://${gconPiece.asn_sitespren_base}/${gconPiece.post_name}`, '_blank');
  1217‚Üí                        }
  1218‚Üí                      }}
  1219‚Üí                      disabled={!gconPiece?.post_name || !gconPiece?.asn_sitespren_base}
  1220‚Üí                      className="w-6 h-6 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white rounded flex items-center justify-center"
  1221‚Üí                      title="Open in new tab"
  1222‚Üí                    >
  1223‚Üí                      ‚Üó
  1224‚Üí                    </button>
  1225‚Üí                    <button
  1226‚Üí                      onClick={() => navigator.clipboard.writeText(gconPiece?.post_name || '')}
  1227‚Üí                      className="w-6 h-6 bg-gray-600 hover:bg-gray-700 text-white rounded flex items-center justify-center"
  1228‚Üí                      title="Copy to clipboard"
  1229‚Üí                    >
  1230‚Üí                      üìã
  1231‚Üí                    </button>
  1232‚Üí                    <span className="flex-1 px-2">
  1233‚Üí                      {gconPiece?.post_name || ''}
  1234‚Üí                    </span>
  1235‚Üí                  </div>
  1236‚Üí                </div>
  1237‚Üí
  1238‚Üí                {/* pageslug */}
  1239‚Üí                <div className="mb-3">
  1240‚Üí                  <label className="block text-sm font-bold text-gray-700 mb-1">
  1241‚Üí                    pageslug
  1242‚Üí                  </label>
  1243‚Üí                  <div className="flex items-center gap-1 p-2 bg-gray-900 text-green-400 rounded font-mono text-sm border">
  1244‚Üí                    <button
  1245‚Üí                      onClick={() => {
  1246‚Üí                        if (gconPiece?.asn_sitespren_base && gconPiece?.pageslug) {
  1247‚Üí                          window.open(`https://${gconPiece.asn_sitespren_base}/${gconPiece.pageslug}`, '_blank');
  1248‚Üí                        }
  1249‚Üí                      }}
  1250‚Üí                      disabled={!gconPiece?.pageslug || !gconPiece?.asn_sitespren_base}
  1251‚Üí                      className="w-6 h-6 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white rounded flex items-center justify-center"
  1252‚Üí                      title="Open in new tab"
  1253‚Üí                    >
  1254‚Üí                      ‚Üó
  1255‚Üí                    </button>
  1256‚Üí                    <button
  1257‚Üí                      onClick={() => navigator.clipboard.writeText(gconPiece?.pageslug || '')}
  1258‚Üí                      className="w-6 h-6 bg-gray-600 hover:bg-gray-700 text-white rounded flex items-center justify-center"
  1259‚Üí                      title="Copy to clipboard"
  1260‚Üí                    >
  1261‚Üí                      üìã
  1262‚Üí                    </button>
  1263‚Üí                    <span className="flex-1 px-2">
  1264‚Üí                      {gconPiece?.pageslug || ''}
  1265‚Üí                    </span>
  1266‚Üí                  </div>
  1267‚Üí                </div>
  1268‚Üí
  1269‚Üí                {/* pageurl */}
  1270‚Üí                <div className="mb-3">
  1271‚Üí                  <label className="block text-sm font-bold text-gray-700 mb-1">
  1272‚Üí                    pageurl
  1273‚Üí                  </label>
  1274‚Üí                  <div className="flex items-center gap-1 p-2 bg-gray-900 text-green-400 rounded font-mono text-sm border">
  1275‚Üí                    <button
  1276‚Üí                      onClick={() => {
  1277‚Üí                        if (gconPiece?.pageurl) {
  1278‚Üí                          window.open(gconPiece.pageurl, '_blank');
  1279‚Üí                        }
  1280‚Üí                      }}
  1281‚Üí                      disabled={!gconPiece?.pageurl}
  1282‚Üí                      className="w-6 h-6 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white rounded flex items-center justify-center"
  1283‚Üí                      title="Open in new tab"
  1284‚Üí                    >
  1285‚Üí                      ‚Üó
  1286‚Üí                    </button>
  1287‚Üí                    <button
  1288‚Üí                      onClick={() => navigator.clipboard.writeText(gconPiece?.pageurl || '')}
  1289‚Üí                      className="w-6 h-6 bg-gray-600 hover:bg-gray-700 text-white rounded flex items-center justify-center"
  1290‚Üí                      title="Copy to clipboard"
  1291‚Üí                    >
  1292‚Üí                      üìã
  1293‚Üí                    </button>
  1294‚Üí                    <span className="flex-1 px-2">
  1295‚Üí                      {gconPiece?.pageurl || ''}
  1296‚Üí                    </span>
  1297‚Üí                  </div>
  1298‚Üí                </div>
  1299‚Üí              </div>
  1300‚Üí
  1301‚Üí              {/* AREA 2: Image Plans Batch Box - Cloned from mesagen */}
  1302‚Üí              <div className="bg-gray-50 border border-gray-300 rounded-lg p-4" style={{ width: '450px' }}>
  1303‚Üí                <div className="mb-3">
  1304‚Üí                  <div className="flex items-center justify-between mb-2">
  1305‚Üí                    <label className="text-sm font-bold text-gray-700">
  1306‚Üí                      asn_image_plan_batch_id
  1307‚Üí                    </label>
  1308‚Üí                    <button
  1309‚Üí                      onClick={() => {
  1310‚Üí                        // Placeholder - waiting for backend functionality instructions
  1311‚Üí                        console.log('Create new batch clicked');
  1312‚Üí                      }}
  1313‚Üí                      className="rounded"
  1314‚Üí                      style={{
  1315‚Üí                        backgroundColor: '#d3d3d3', // light gray
  1316‚Üí                        color: '#4a4a4a', // dark gray
  1317‚Üí                        fontSize: '13px',
  1318‚Üí                        padding: '3px 8px'
  1319‚Üí                      }}
  1320‚Üí                    >
  1321‚Üí                      create new batch
  1322‚Üí                    </button>
  1323‚Üí                  </div>
  1324‚Üí                  <select
  1325‚Üí                    className="w-full px-3 py-2 border border-gray-300 rounded bg-white text-sm"
  1326‚Üí                    value={selectedBatchId}
  1327‚Üí                    onChange={(e) => setSelectedBatchId(e.target.value)}
  1328‚Üí                  >
  1329‚Üí                    <option value="">Select image plan batch...</option>
  1330‚Üí                    {imagePlansBatches.map((batch) => (
  1331‚Üí                      <option key={batch.id} value={batch.id}>
  1332‚Üí                        {batch.batch_name || `Batch ${batch.id.substring(0, 8)}...`}
  1333‚Üí                      </option>
  1334‚Üí                    ))}
  1335‚Üí                  </select>
  1336‚Üí                </div>
  1337‚Üí                
  1338‚Üí                <div className="mt-4 flex gap-2">
  1339‚Üí                  <button
  1340‚Üí                    onClick={handleSaveImagePlanBatch}
  1341‚Üí                    disabled={isSavingBatch || !selectedBatchId}
  1342‚Üí                    className="px-4 py-2 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed"
  1343‚Üí                    style={{
  1344‚Üí                      backgroundColor: '#000000',
  1345‚Üí                      fontSize: '16px'
  1346‚Üí                    }}
  1347‚Üí                  >
  1348‚Üí                    {isSavingBatch ? 'Saving...' : 'save'}
  1349‚Üí                  </button>
  1350‚Üí                  
  1351‚Üí                  {/* Open Batch Button - Show if batch is selected or assigned */}
  1352‚Üí                  {(selectedBatchId || gconPiece?.asn_image_plan_batch_id) && (
  1353‚Üí                    <a
  1354‚Üí                      href={`https://snef.me/bin34/tebnar2?batchid=${selectedBatchId || gconPiece?.asn_image_plan_batch_id}`}
  1355‚Üí                      className="px-4 py-2 rounded inline-block text-center"
  1356‚Üí                      style={{
  1357‚Üí                        backgroundColor: '#009bff', // bestlinkcol
  1358‚Üí                        fontSize: '16px',
  1359‚Üí                        fontWeight: 'bold',
  1360‚Üí                        color: '#000',
  1361‚Üí                        border: '2px solid #000',
  1362‚Üí                        textDecoration: 'none'
  1363‚Üí                      }}
  1364‚Üí                    >
  1365‚Üí                      open batch in /tebnar2
  1366‚Üí                    </a>
  1367‚Üí                  )}
  1368‚Üí                </div>
  1369‚Üí
  1370‚Üí                {/* Narpi Pushes Table */}
  1371‚Üí                {(selectedBatchId || gconPiece?.asn_image_plan_batch_id) && narpiPushes.length > 0 && (
  1372‚Üí                  <div className="mt-4">
  1373‚Üí                    <div className="overflow-x-auto rounded border border-gray-300" style={{ maxWidth: '440px' }}>
  1374‚Üí                      <table className="min-w-full" style={{ fontSize: '14px' }}>
  1375‚Üí                        <thead>
  1376‚Üí                          <tr className="bg-gray-100">
  1377‚Üí                            <th style={{ width: '30px', padding: '3px', minWidth: '30px' }} className="text-left font-bold">
  1378‚Üí                              <input
  1379‚Üí                                type="checkbox"
  1380‚Üí                                checked={selectedNarpiPushes.size === narpiPushes.length && narpiPushes.length > 0}
  1381‚Üí                                onChange={(e) => {
  1382‚Üí                                  if (e.target.checked) {
  1383‚Üí                                    setSelectedNarpiPushes(new Set(narpiPushes.map(p => p.id)));
  1384‚Üí                                  } else {
  1385‚Üí                                    setSelectedNarpiPushes(new Set());
  1386‚Üí                                  }
  1387‚Üí                                }}
  1388‚Üí                              />
  1389‚Üí                            </th>
  1390‚Üí                            <th style={{ width: '200px', padding: '3px', minWidth: '200px' }} className="text-left font-bold">kareench1</th>
  1391‚Üí                            <th style={{ width: '60px', padding: '3px', minWidth: '60px' }} className="text-left font-bold">id</th>
  1392‚Üí                            <th style={{ width: '120px', padding: '3px', minWidth: '120px' }} className="text-left font-bold">push_name</th>
  1393‚Üí                            <th style={{ width: '80px', padding: '3px', minWidth: '80px' }} className="text-left font-bold">push_status1</th>
  1394‚Üí                            <th style={{ width: '60px', padding: '3px', minWidth: '60px' }} className="text-left font-bold">created_at</th>
  1395‚Üí                          </tr>
  1396‚Üí                        </thead>
  1397‚Üí                        <tbody>
  1398‚Üí                          {narpiPushes.map((push) => (
  1399‚Üí                            <tr key={push.id} className="border-t border-gray-200 hover:bg-gray-50">
  1400‚Üí                              <td style={{ padding: '3px' }}>
  1401‚Üí                                <div style={{ height: '19px' }} className="flex items-center">
  1402‚Üí                                  <input
  1403‚Üí                                    type="checkbox"
  1404‚Üí                                    checked={selectedNarpiPushes.has(push.id)}
  1405‚Üí                                    onChange={(e) => {
  1406‚Üí                                      const newSelected = new Set(selectedNarpiPushes);
  1407‚Üí                                      if (e.target.checked) {
  1408‚Üí                                        newSelected.add(push.id);
  1409‚Üí                                      } else {
  1410‚Üí                                        newSelected.delete(push.id);
  1411‚Üí                                      }
  1412‚Üí                                      setSelectedNarpiPushes(newSelected);
  1413‚Üí                                    }}
  1414‚Üí                                  />
  1415‚Üí                                </div>
  1416‚Üí                              </td>
  1417‚Üí                              <td style={{ padding: '3px' }}>
  1418‚Üí                                <div style={{ height: '19px' }} className="flex items-center space-x-1">
  1419‚Üí                                  <div style={{ fontSize: '11px' }}>
  1420‚Üí                                    {push.kareench1 && Array.isArray(push.kareench1) ? (
  1421‚Üí                                      <div className="flex space-x-1">
  1422‚Üí                                        {(() => {
  1423‚Üí                                          const results = push.kareench1;
  1424‚Üí                                          const total = results.length;
  1425‚Üí                                          const success = results.filter((r: any) => r.nupload_status1 === 'success').length;
  1426‚Üí                                          const failed = results.filter((r: any) => r.nupload_status1 === 'failed').length;
  1427‚Üí                                          
  1428‚Üí                                          return (
  1429‚Üí                                            <>
  1430‚Üí                                              <span className="bg-blue-100 text-blue-800 px-1 rounded text-xs">T:{total}</span>
  1431‚Üí                                              <span className="bg-green-100 text-green-800 px-1 rounded text-xs">‚úì{success}</span>
  1432‚Üí                                              <span className="bg-red-100 text-red-800 px-1 rounded text-xs">‚úó{failed}</span>
  1433‚Üí                                            </>
  1434‚Üí                                          );
  1435‚Üí                                        })()}
  1436‚Üí                                      </div>
  1437‚Üí                                    ) : push.kareench1 ? (
  1438‚Üí                                      <div className="truncate text-xs" style={{ maxWidth: '120px' }}>
  1439‚Üí                                        {typeof push.kareench1 === 'string' 
  1440‚Üí                                          ? (push.kareench1.length > 20 ? `${push.kareench1.substring(0, 20)}...` : push.kareench1)
  1441‚Üí                                          : JSON.stringify(push.kareench1).length > 20 
  1442‚Üí                                            ? `${JSON.stringify(push.kareench1).substring(0, 20)}...`
  1443‚Üí                                            : JSON.stringify(push.kareench1)
  1444‚Üí                                        }
  1445‚Üí                                      </div>
  1446‚Üí                                    ) : (
  1447‚Üí                                      <span className="text-gray-400 italic text-xs">No data</span>
  1448‚Üí                                    )}
  1449‚Üí                                  </div>
  1450‚Üí                                  {push.kareench1 && (
  1451‚Üí                                    <button
  1452‚Üí                                      onClick={() => copyNarpiKareenchValue(push.id, push.kareench1)}
  1453‚Üí                                      className={`px-1 py-0.5 text-xs rounded ${
  1454‚Üí                                        copiedNarpiId === push.id
  1455‚Üí                                          ? 'text-green-800 bg-green-100'
  1456‚Üí                                          : 'text-gray-600 bg-gray-100 hover:bg-gray-200'
  1457‚Üí                                      }`}
  1458‚Üí                                      style={{ fontSize: '10px' }}
  1459‚Üí                                    >
  1460‚Üí                                      {copiedNarpiId === push.id ? '‚úì' : 'Copy'}
  1461‚Üí                                    </button>
  1462‚Üí                                  )}
  1463‚Üí                                </div>
  1464‚Üí                              </td>
  1465‚Üí                              <td style={{ padding: '3px' }}>
  1466‚Üí                                <div style={{ height: '19px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
  1467‚Üí                                  {push.id.substring(0, 8)}...
  1468‚Üí                                </div>
  1469‚Üí                              </td>
  1470‚Üí                              <td style={{ padding: '3px' }}>
  1471‚Üí                                <div style={{ height: '19px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
  1472‚Üí                                  {push.push_name || '-'}
  1473‚Üí                                </div>
  1474‚Üí                              </td>
  1475‚Üí                              <td style={{ padding: '3px' }}>
  1476‚Üí                                <div style={{ height: '19px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
  1477‚Üí                                  {push.push_status1 || '-'}
  1478‚Üí                                </div>
  1479‚Üí                              </td>
  1480‚Üí                              <td style={{ padding: '3px' }}>
  1481‚Üí                                <div style={{ height: '19px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
  1482‚Üí                                  {new Date(push.created_at).toLocaleDateString('en-US', { month: '2-digit', day: '2-digit' })}
  1483‚Üí                                </div>
  1484‚Üí                              </td>
  1485‚Üí                            </tr>
  1486‚Üí                          ))}
  1487‚Üí                        </tbody>
  1488‚Üí                      </table>
  1489‚Üí                    </div>
  1490‚Üí                  </div>
  1491‚Üí                )}
  1492‚Üí
  1493‚Üí                {/* Open Narpo1 Button - Show if batch is selected or assigned */}
  1494‚Üí                {(selectedBatchId || gconPiece?.asn_image_plan_batch_id) && (
  1495‚Üí                  <div className="mt-3">
  1496‚Üí                    <a
  1497‚Üí                      href={`https://snef.me/bin42/narpo1?fk_batch_id=${selectedBatchId || gconPiece?.asn_image_plan_batch_id}`}
  1498‚Üí                      className="px-4 py-2 rounded inline-block text-center"
  1499‚Üí                      style={{
  1500‚Üí                        backgroundColor: '#009bff', // bestlinkcol
  1501‚Üí                        fontSize: '16px',
  1502‚Üí                        fontWeight: 'bold',
  1503‚Üí                        color: '#000',
  1504‚Üí                        border: '2px solid #000',
  1505‚Üí                        textDecoration: 'none'
  1506‚Üí                      }}
  1507‚Üí                    >
  1508‚Üí                      open /narpo1
  1509‚Üí                    </a>
  1510‚Üí                  </div>
  1511‚Üí                )}
  1512‚Üí              </div>
  1513‚Üí
  1514‚Üí              {/* NEW AREA 3: Dublish Function Box */}
  1515‚Üí              <div className="bg-gray-50 border border-gray-300 rounded-lg p-4" style={{ width: '450px' }}>
  1516‚Üí                <div className="mb-3">
  1517‚Üí                  <strong className="text-sm font-bold text-gray-700">
  1518‚Üí                    Publish new elementor page using dublish function
  1519‚Üí                  </strong>
  1520‚Üí                </div>
  1521‚Üí                
  1522‚Üí                <hr className="my-3 border-gray-300" />
  1523‚Üí                
  1524‚Üí                <div className="mb-3">
  1525‚Üí                  <button
  1526‚Üí                    onClick={handleCompileTextContent}
  1527‚Üí                    disabled={isCompilingTextContent || !gconPiece?.pelementor_cached}
  1528‚Üí                    className={`w-full px-4 py-2 text-white rounded transition-colors ${
  1529‚Üí                      isCompilingTextContent || !gconPiece?.pelementor_cached
  1530‚Üí                        ? 'bg-gray-400 cursor-not-allowed'
  1531‚Üí                        : 'bg-black hover:bg-gray-800'
  1532‚Üí                    }`}
  1533‚Üí                    style={{
  1534‚Üí                      fontSize: '14px'
  1535‚Üí                    }}
  1536‚Üí                  >
  1537‚Üí                    {isCompilingTextContent ? 'Compiling...' : 'compile new_desired_text_content into pelementor_edits'}
  1538‚Üí                  </button>
  1539‚Üí                  <p className="text-xs text-gray-600 mt-2 italic">
  1540‚Üí                    (includes active checkboxes for man_img_url and man_img_id)
  1541‚Üí                  </p>
  1542‚Üí                </div>
  1543‚Üí                
  1544‚Üí                <hr className="my-3 border-gray-300" />
  1545‚Üí                
  1546‚Üí                <div className="mb-3">
  1547‚Üí                  <button
  1548‚Üí                    onClick={() => alert('compile new_desired_image_content into pelementor_edits - functionality coming soon')}
  1549‚Üí                    className="w-full px-4 py-2 text-white rounded"
  1550‚Üí                    style={{
  1551‚Üí                      backgroundColor: '#000000',
  1552‚Üí                      fontSize: '14px'
  1553‚Üí                    }}
  1554‚Üí                  >
  1555‚Üí                    compile new_desired_image_content into pelementor_edits
  1556‚Üí                  </button>
  1557‚Üí                </div>
  1558‚Üí                
  1559‚Üí                <hr className="my-3 border-gray-300" />
  1560‚Üí                
  1561‚Üí                <div className="mb-3">
  1562‚Üí                  <button
  1563‚Üí                    onClick={handleRunDublish}
  1564‚Üí                    disabled={isRunningDublish || !gconPiece?.pelementor_edits || !gconPiece?.asn_sitespren_base}
  1565‚Üí                    className={`w-full px-4 py-2 text-white rounded transition-colors ${
  1566‚Üí                      isRunningDublish || !gconPiece?.pelementor_edits || !gconPiece?.asn_sitespren_base
  1567‚Üí                        ? 'bg-gray-400 cursor-not-allowed'
  1568‚Üí                        : 'bg-black hover:bg-gray-800'
  1569‚Üí                    }`}
  1570‚Üí                    style={{
  1571‚Üí                      fontSize: '14px'
  1572‚Üí                    }}
  1573‚Üí                  >
  1574‚Üí                    {isRunningDublish ? (
  1575‚Üí                      <div className="flex items-center justify-center gap-2">
  1576‚Üí                        <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
  1577‚Üí                        Publishing...
  1578‚Üí                      </div>
  1579‚Üí                    ) : (
  1580‚Üí                      'run dublish function'
  1581‚Üí                    )}
  1582‚Üí                  </button>
  1583‚Üí                </div>
  1584‚Üí
  1585‚Üí                {/* Connection Type Selector */}
  1586‚Üí                <div className="mb-3">
  1587‚Üí                  <label className="block text-xs font-bold text-gray-700 mb-2">
  1588‚Üí                    Connection Type:
  1589‚Üí                  </label>
  1590‚Üí                  <select
  1591‚Üí                    value={dublishConnectionType}
  1592‚Üí                    onChange={(e) => setDublishConnectionType(e.target.value as 'snefuruplin' | 'rest_api' | 'api_other')}
  1593‚Üí                    disabled={isRunningDublish}
  1594‚Üí                    className="w-full px-3 py-2 border border-gray-300 rounded text-sm bg-white disabled:bg-gray-100"
  1595‚Üí                  >
  1596‚Üí                    <option value="snefuruplin">Snefuruplin WP Plugin</option>
  1597‚Üí                    <option value="rest_api">REST API</option>
  1598‚Üí                    <option value="api_other">API (other)</option>
  1599‚Üí                  </select>
  1600‚Üí                </div>
  1601‚Üí
  1602‚Üí                {/* Progress Indicator */}
  1603‚Üí                {dublishProgress && (
  1604‚Üí                  <div className="mb-3 p-2 bg-blue-50 border border-blue-200 rounded">
  1605‚Üí                    <div className="text-xs text-blue-800">
  1606‚Üí                      <strong>Status:</strong> {dublishProgress}
  1607‚Üí                    </div>
  1608‚Üí                    {isRunningDublish && (
  1609‚Üí                      <div className="mt-2">
  1610‚Üí                        <div className="w-full bg-blue-200 rounded-full h-2">
  1611‚Üí                          <div className="bg-blue-600 h-2 rounded-full animate-pulse" style={{ width: '60%' }}></div>
  1612‚Üí                        </div>
  1613‚Üí                      </div>
  1614‚Üí                    )}
  1615‚Üí                  </div>
  1616‚Üí                )}
  1617‚Üí
  1618‚Üí                {/* Results Section */}
  1619‚Üí                {dublishResult && (
  1620‚Üí                  <div className={`mb-3 p-3 border rounded ${
  1621‚Üí                    dublishResult.success 
  1622‚Üí                      ? 'bg-green-50 border-green-200' 
  1623‚Üí                      : 'bg-red-50 border-red-200'
  1624‚Üí                  }`}>
  1625‚Üí                    <div className={`text-sm font-medium ${
  1626‚Üí                      dublishResult.success ? 'text-green-800' : 'text-red-800'
  1627‚Üí                    }`}>
  1628‚Üí                      {dublishResult.message}
  1629‚Üí                    </div>
  1630‚Üí                    
  1631‚Üí                    {dublishResult.success && dublishResult.wpEditorUrl && dublishResult.liveUrl && (
  1632‚Üí                      <div className="mt-3 space-y-2">
  1633‚Üí                        <a
  1634‚Üí                          href={dublishResult.wpEditorUrl}
  1635‚Üí                          target="_blank"
  1636‚Üí                          rel="noopener noreferrer"
  1637‚Üí                          className="block w-full px-3 py-2 bg-blue-600 text-white text-center rounded text-sm hover:bg-blue-700 transition-colors"
  1638‚Üí                        >
  1639‚Üí                          üîß Edit in Elementor (Post ID: {dublishResult.postId})
  1640‚Üí                        </a>
  1641‚Üí                        <a
  1642‚Üí                          href={dublishResult.liveUrl}
  1643‚Üí                          target="_blank"
  1644‚Üí                          rel="noopener noreferrer"
  1645‚Üí                          className="block w-full px-3 py-2 bg-green-600 text-white text-center rounded text-sm hover:bg-green-700 transition-colors"
  1646‚Üí                        >
  1647‚Üí                          üåê View Live Page
  1648‚Üí                        </a>
  1649‚Üí                      </div>
  1650‚Üí                    )}
  1651‚Üí                  </div>
  1652‚Üí                )}
  1653‚Üí                
  1654‚Üí                <div className="text-xs text-gray-600 mt-2">
  1655‚Üí                  create new page on asn_sitespren_base from defined data (such as pelementor_edits field in some cases, etc.)
  1656‚Üí                </div>
  1657‚Üí              </div>
  1658‚Üí
  1659‚Üí              {/* NEW AREA 4: Snoverride Function Box */}
  1660‚Üí              <div className="bg-gray-50 border border-gray-300 rounded-lg p-4" style={{ width: '450px' }}>
  1661‚Üí                <div className="mb-3">
  1662‚Üí                  <strong className="text-sm font-bold text-gray-700">
  1663‚Üí                    Update existing elementor page using snoverride function
  1664‚Üí                  </strong>
  1665‚Üí                </div>
  1666‚Üí                
  1667‚Üí                <hr className="my-3 border-gray-300" />
  1668‚Üí                
  1669‚Üí                <div className="mb-3">
  1670‚Üí                  <button
  1671‚Üí                    onClick={handleRunSnoverride}
  1672‚Üí                    disabled={isRunningSnoverride || !gconPiece?.pelementor_edits || !gconPiece?.asn_sitespren_base || !gconPiece?.g_post_id}
  1673‚Üí                    className={`w-full px-4 py-2 text-white rounded transition-colors ${
  1674‚Üí                      isRunningSnoverride || !gconPiece?.pelementor_edits || !gconPiece?.asn_sitespren_base || !gconPiece?.g_post_id
  1675‚Üí                        ? 'bg-gray-400 cursor-not-allowed'
  1676‚Üí                        : 'bg-black hover:bg-gray-800'
  1677‚Üí                    }`}
  1678‚Üí                    style={{
  1679‚Üí                      fontSize: '14px'
  1680‚Üí                    }}
  1681‚Üí                  >
  1682‚Üí                    {isRunningSnoverride ? (
  1683‚Üí                      <div className="flex items-center justify-center gap-2">
  1684‚Üí                        <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
  1685‚Üí                        Updating...
  1686‚Üí                      </div>
  1687‚Üí                    ) : (
  1688‚Üí                      'run snoverride'
  1689‚Üí                    )}
  1690‚Üí                  </button>
  1691‚Üí                </div>
  1692‚Üí
  1693‚Üí                {/* Connection Type Selector */}
  1694‚Üí                <div className="mb-3">
  1695‚Üí                  <label className="block text-xs font-bold text-gray-700 mb-2">
  1696‚Üí                    Connection Type:
  1697‚Üí                  </label>
  1698‚Üí                  <select
  1699‚Üí                    value={snoverrideConnectionType}
  1700‚Üí                    onChange={(e) => setSnoverrideConnectionType(e.target.value as 'snefuruplin' | 'rest_api' | 'api_other')}
  1701‚Üí                    disabled={isRunningSnoverride}
  1702‚Üí                    className="w-full px-3 py-2 border border-gray-300 rounded text-sm bg-white disabled:bg-gray-100"
  1703‚Üí                  >
  1704‚Üí                    <option value="snefuruplin">Snefuruplin WP Plugin</option>
  1705‚Üí                    <option value="rest_api">REST API</option>
  1706‚Üí                    <option value="api_other">API (other)</option>
  1707‚Üí                  </select>
  1708‚Üí                </div>
  1709‚Üí
  1710‚Üí                {/* Progress Indicator */}
  1711‚Üí                {snoverrideProgress && (
  1712‚Üí                  <div className="mb-3 p-2 bg-blue-50 border border-blue-200 rounded">
  1713‚Üí                    <div className="text-xs text-blue-800">
  1714‚Üí                      <strong>Status:</strong> {snoverrideProgress}
  1715‚Üí                    </div>
  1716‚Üí                    {isRunningSnoverride && (
  1717‚Üí                      <div className="mt-2">
  1718‚Üí                        <div className="w-full bg-blue-200 rounded-full h-2">
  1719‚Üí                          <div className="bg-blue-600 h-2 rounded-full animate-pulse" style={{ width: '60%' }}></div>
  1720‚Üí                        </div>
  1721‚Üí                      </div>
  1722‚Üí                    )}
  1723‚Üí                  </div>
  1724‚Üí                )}
  1725‚Üí
  1726‚Üí                {/* Results Section */}
  1727‚Üí                {snoverrideResult && (
  1728‚Üí                  <div className={`mb-3 p-3 border rounded ${
  1729‚Üí                    snoverrideResult.success 
  1730‚Üí                      ? 'bg-green-50 border-green-200' 
  1731‚Üí                      : 'bg-red-50 border-red-200'
  1732‚Üí                  }`}>
  1733‚Üí                    <div className={`text-sm font-medium ${
  1734‚Üí                      snoverrideResult.success ? 'text-green-800' : 'text-red-800'
  1735‚Üí                    }`}>
  1736‚Üí                      {snoverrideResult.message}
  1737‚Üí                    </div>
  1738‚Üí                    
  1739‚Üí                    {snoverrideResult.success && snoverrideResult.wpEditorUrl && snoverrideResult.liveUrl && (
  1740‚Üí                      <div className="mt-3 space-y-2">
  1741‚Üí                        <a
  1742‚Üí                          href={snoverrideResult.wpEditorUrl}
  1743‚Üí                          target="_blank"
  1744‚Üí                          rel="noopener noreferrer"
  1745‚Üí                          className="block w-full px-3 py-2 bg-blue-600 text-white text-center rounded text-sm hover:bg-blue-700 transition-colors"
  1746‚Üí                        >
  1747‚Üí                          üîß Edit in Elementor (Post ID: {snoverrideResult.postId})
  1748‚Üí                        </a>
  1749‚Üí                        <a
  1750‚Üí                          href={snoverrideResult.liveUrl}
  1751‚Üí                          target="_blank"
  1752‚Üí                          rel="noopener noreferrer"
  1753‚Üí                          className="block w-full px-3 py-2 bg-green-600 text-white text-center rounded text-sm hover:bg-green-700 transition-colors"
  1754‚Üí                        >
  1755‚Üí                          üåê View Updated Page
  1756‚Üí                        </a>
  1757‚Üí                      </div>
  1758‚Üí                    )}
  1759‚Üí                  </div>
  1760‚Üí                )}
  1761‚Üí                
  1762‚Üí                <div className="text-xs text-gray-600 mt-2">
  1763‚Üí                  {gconPiece?.g_post_id ? (
  1764‚Üí                    <span>
  1765‚Üí                      Update existing post ID: <strong>{gconPiece.g_post_id}</strong> on {gconPiece.asn_sitespren_base}
  1766‚Üí                    </span>
  1767‚Üí                  ) : (
  1768‚Üí                    <span className="text-red-600">
  1769‚Üí                      No g_post_id found - cannot update without target post ID
  1770‚Üí                    </span>
  1771‚Üí                  )}
  1772‚Üí                </div>
  1773‚Üí              </div>
  1774‚Üí            </div>
  1775‚Üí          </div>
  1776‚Üí        )}
  1777‚Üí        
  1778‚Üí        <h1 className="text-2xl font-bold mb-6">Tornado</h1>
  1779‚Üí        {gconPieceId && (
  1780‚Üí          <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
  1781‚Üí            <p className="text-sm text-blue-800">
  1782‚Üí              <strong>gcon_piece_id:</strong> {gconPieceId}
  1783‚Üí              {gconPiece?.asn_sitespren_base && (
  1784‚Üí                <span className="ml-4">
  1785‚Üí                  <strong>Site:</strong> {gconPiece.asn_sitespren_base}
  1786‚Üí                </span>
  1787‚Üí              )}
  1788‚Üí            </p>
  1789‚Üí          </div>
  1790‚Üí        )}
  1791‚Üí        <WaterTable 
  1792‚Üí          gconPieceId={gconPieceId} 
  1793‚Üí          isTopAreaOpen={isTopAreaOpen}
  1794‚Üí          handleAccordionToggle={handleAccordionToggle}
  1795‚Üí          gconPiece={gconPiece}
  1796‚Üí          isRunningF22={isRunningF22}
  1797‚Üí          f22Report={f22Report}
  1798‚Üí          handleRunF22={handleRunF22}
  1799‚Üí          handleCopyPelementorCached={handleCopyPelementorCached}
  1800‚Üí          handleCopyPelementorEdits={handleCopyPelementorEdits}
  1801‚Üí          handleCopyF22Report={handleCopyF22Report}
  1802‚Üí          onGetManualImageData={manualImageDataRef}
  1803‚Üí        />
  1804‚Üí      </div>
  1805‚Üí    </div>
  1806‚Üí  );
  1807‚Üí}
```

_**Agent (claude-sonnet-4-20250514)**_

Great! I found another page that needs conversion. `/tornado` is a very complex page with 1,800+ lines and sets `document.title` on lines 237-243. Let me convert it:

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Write**

```tsx
'use client';

import { useState, useEffect, useRef } from 'react';
import { useAuth } from '@/app/context/AuthContext';
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
import { useSearchParams } from 'next/navigation';
import Link from 'next/link';
import WaterTable from './components/WaterTable';
import MarzdiStickyMenu from './components/marzdi_sticky_menu';

export default function TornadoClient() {
  const { user } = useAuth();
  const searchParams = useSearchParams();
  const supabase = createClientComponentClient();
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [gconPieceId, setGconPieceId] = useState<string | null>(null);
  const [gconPiece, setGconPiece] = useState<any>(null);
  const [isTopAreaOpen, setIsTopAreaOpen] = useState<boolean>(true);
  const [isPopulatingUnits, setIsPopulatingUnits] = useState(false);
  const [populateMessage, setPopulateMessage] = useState<string | null>(null);
  const [isRunningF22, setIsRunningF22] = useState(false);
  const [f22Report, setF22Report] = useState<string>('');
  
  // Image Plans Batch state
  const [imagePlansBatches, setImagePlansBatches] = useState<any[]>([]);
  const [selectedBatchId, setSelectedBatchId] = useState<string>('');
  const [isSavingBatch, setIsSavingBatch] = useState(false);

  // Compile text content state
  const [isCompilingTextContent, setIsCompilingTextContent] = useState(false);

  // Narpi pushes state
  const [narpiPushes, setNarpiPushes] = useState<any[]>([]);
  const [selectedNarpiPushes, setSelectedNarpiPushes] = useState<Set<string>>(new Set());
  const [copiedNarpiId, setCopiedNarpiId] = useState<string | null>(null);

  // Dublish function state
  const [isRunningDublish, setIsRunningDublish] = useState(false);
  const [dublishConnectionType, setDublishConnectionType] = useState<'snefuruplin' | 'rest_api' | 'api_other'>('snefuruplin');
  const [dublishProgress, setDublishProgress] = useState<string>('');
  const [dublishResult, setDublishResult] = useState<{
    success: boolean;
    wpEditorUrl?: string;
    liveUrl?: string;
    postId?: number;
    message?: string;
  } | null>(null);

  // Snoverride function state
  const [isRunningSnoverride, setIsRunningSnoverride] = useState(false);
  const [snoverrideConnectionType, setSnoverrideConnectionType] = useState<'snefuruplin' | 'rest_api' | 'api_other'>('snefuruplin');
  const [snoverrideProgress, setSnoverrideProgress] = useState<string>('');
  const [snoverrideResult, setSnoverrideResult] = useState<{
    success: boolean;
    wpEditorUrl?: string;
    liveUrl?: string;
    postId?: number;
    message?: string;
  } | null>(null);

  // Ref to access manual image data from WaterTable
  const manualImageDataRef = useRef<{ 
    urls: Map<string, string>; 
    ids: Map<string, string>; 
    checkboxes: Map<string, boolean> 
  } | null>(null);

  useEffect(() => {
    // Hide header for this test page
    document.body.style.marginTop = '0';
    const header = document.querySelector('header');
    if (header) {
      header.style.display = 'none';
    }
    
    // Get gcon_piece_id from URL parameters
    const gconPieceIdParam = searchParams?.get('gcon_piece_id');
    if (gconPieceIdParam) {
      setGconPieceId(gconPieceIdParam);
      console.log('Tornado: Loaded with gcon_piece_id:', gconPieceIdParam);
    }
    
    // Handle zarno1 state from URL and localStorage
    const urlParams = new URLSearchParams(window.location.search);
    const zarno1Param = urlParams.get('zarno1');
    
    // Try to get saved state from localStorage
    const savedState = localStorage.getItem('tornado_zarno1_state');
    
    if (zarno1Param === 'closed') {
      setIsTopAreaOpen(false);
    } else if (zarno1Param === 'open') {
      setIsTopAreaOpen(true);
    } else if (savedState) {
      // Use saved state if no URL param
      setIsTopAreaOpen(savedState === 'open');
    }
    
    setLoading(false);
  }, [searchParams]);

  // Fetch narpi pushes when batch changes
  useEffect(() => {
    const fetchNarpiPushes = async () => {
      if (!selectedBatchId && !gconPiece?.asn_image_plan_batch_id) {
        setNarpiPushes([]);
        return;
      }

      const batchId = selectedBatchId || gconPiece?.asn_image_plan_batch_id;
      
      try {
        const { data, error } = await supabase
          .from('narpi_pushes')
          .select('id, push_name, push_status1, created_at, kareench1')
          .eq('fk_batch_id', batchId)
          .order('created_at', { ascending: false });

        if (error) {
          console.error('Error fetching narpi_pushes:', error);
        } else {
          setNarpiPushes(data || []);
        }
      } catch (error) {
        console.error('Error fetching narpi_pushes:', error);
      }
    };

    fetchNarpiPushes();
  }, [selectedBatchId, gconPiece?.asn_image_plan_batch_id]);

  // Copy kareench1 value function
  const copyNarpiKareenchValue = async (pushId: string, kareenchValue: any) => {
    try {
      const valueToString = typeof kareenchValue === 'string' 
        ? kareenchValue 
        : JSON.stringify(kareenchValue, null, 2);
      
      await navigator.clipboard.writeText(valueToString);
      setCopiedNarpiId(pushId);
      
      // Clear the copied indicator after 2 seconds
      setTimeout(() => setCopiedNarpiId(null), 2000);
    } catch (err) {
      console.error('Failed to copy kareench1 value:', err);
    }
  };

  // Fetch gcon_piece data when gconPieceId is available
  useEffect(() => {
    const fetchGconPiece = async () => {
      if (!user?.id || !gconPieceId) {
        return;
      }

      try {
        // Get user's internal ID first
        const { data: userData } = await supabase
          .from('users')
          .select('id')
          .eq('auth_id', user.id)
          .single();

        if (!userData) {
          setError('User not found');
          return;
        }

        // Fetch the gcon_piece
        const { data: gconData, error: gconError } = await supabase
          .from('gcon_pieces')
          .select('id, asn_sitespren_base, mud_title, h1title, pelementor_cached, pelementor_edits, g_post_id, asn_image_plan_batch_id, post_name, pageslug, pageurl')
          .eq('id', gconPieceId)
          .eq('fk_users_id', userData.id)
          .single();

        if (gconError) {
          setError('Content piece not found');
          return;
        }

        setGconPiece(gconData);
      } catch (err) {
        console.error('Error fetching gcon_piece:', err);
        setError('Failed to load content');
      }
    };

    fetchGconPiece();
  }, [user?.id, gconPieceId, supabase]);

  // Fetch images_plans_batches for current user
  useEffect(() => {
    const fetchImagePlansBatches = async () => {
      if (!user?.id) return;

      try {
        // Get user's internal ID first
        const { data: userData } = await supabase
          .from('users')
          .select('id')
          .eq('auth_id', user.id)
          .single();

        if (!userData) return;

        // Fetch images_plans_batches for this user
        const { data: batchesData, error } = await supabase
          .from('images_plans_batches')
          .select('*')
          .eq('rel_users_id', userData.id)
          .order('created_at', { ascending: false });

        if (error) {
          console.error('Error fetching images_plans_batches:', error);
          return;
        }

        setImagePlansBatches(batchesData || []);

        // Set current selected batch if gconPiece has one
        if (gconPiece?.asn_image_plan_batch_id) {
          setSelectedBatchId(gconPiece.asn_image_plan_batch_id);
        }
      } catch (err) {
        console.error('Error in fetchImagePlansBatches:', err);
      }
    };

    fetchImagePlansBatches();
  }, [user?.id, supabase, gconPiece?.asn_image_plan_batch_id]);

  // Handle accordion state change
  const handleAccordionToggle = (open: boolean) => {
    setIsTopAreaOpen(open);
    
    // Save to localStorage
    localStorage.setItem('tornado_zarno1_state', open ? 'open' : 'closed');
    
    // Update URL parameter
    const url = new URL(window.location.href);
    url.searchParams.set('zarno1', open ? 'open' : 'closed');
    window.history.replaceState({}, '', url.toString());
  };

  // Handle populate nemtor_units
  const handlePopulateNemtorUnits = async () => {
    if (!gconPieceId) {
      setPopulateMessage('Error: No gcon_piece_id available');
      return;
    }

    setIsPopulatingUnits(true);
    setPopulateMessage(null);

    try {
      const response = await fetch('/api/populate-nemtor-units', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          gcon_piece_id: gconPieceId
        }),
      });

      const result = await response.json();

      if (response.ok) {
        setPopulateMessage(`‚úÖ ${result.message}`);
      } else {
        setPopulateMessage(`‚ùå Error: ${result.error}`);
      }
    } catch (error) {
      console.error('Error populating nemtor_units:', error);
      setPopulateMessage('‚ùå Error: Failed to populate nemtor_units');
    } finally {
      setIsPopulatingUnits(false);
      // Clear message after 5 seconds
      setTimeout(() => setPopulateMessage(null), 5000);
    }
  };

  // Handle f22 function
  const handleRunF22 = async () => {
    if (!gconPieceId) {
      setF22Report('Error: No gcon_piece_id available');
      return;
    }

    setIsRunningF22(true);
    setF22Report('Starting F22 processing...');

    try {
      const response = await fetch('/api/f22-gcon-piece-processor', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          gcon_piece_id: gconPieceId
        }),
      });

      const result = await response.json();

      if (response.ok) {
        setF22Report(result.message || 'F22 function completed successfully');
        
        // Refresh the gcon_piece data to get updated values
        if (user?.id) {
          const { data: userData } = await supabase
            .from('users')
            .select('id')
            .eq('auth_id', user.id)
            .single();

          if (userData) {
            const { data: refreshedData } = await supabase
              .from('gcon_pieces')
              .select('id, asn_sitespren_base, mud_title, h1title, pelementor_cached, pelementor_edits, asn_image_plan_batch_id, post_name, pageslug, pageurl')
              .eq('id', gconPieceId)
              .eq('fk_users_id', userData.id)
              .single();

            if (refreshedData) {
              setGconPiece(refreshedData);
            }
          }
        }
      } else {
        setF22Report(`Error: ${result.error || 'F22 function failed'}`);
      }
    } catch (error) {
      console.error('Error running F22:', error);
      setF22Report('Error: Failed to run F22 function');
    } finally {
      setIsRunningF22(false);
    }
  };

  // Copy functions
  const handleCopyPelementorCached = () => {
    if (gconPiece?.pelementor_cached) {
      const content = typeof gconPiece.pelementor_cached === 'string' 
        ? gconPiece.pelementor_cached 
        : JSON.stringify(gconPiece.pelementor_cached, null, 2);
      navigator.clipboard.writeText(content);
    }
  };

  const handleCopyPelementorEdits = () => {
    if (gconPiece?.pelementor_edits) {
      const content = typeof gconPiece.pelementor_edits === 'string' 
        ? gconPiece.pelementor_edits 
        : JSON.stringify(gconPiece.pelementor_edits, null, 2);
      navigator.clipboard.writeText(content);
    }
  };

  const handleCopyF22Report = () => {
    if (f22Report) {
      navigator.clipboard.writeText(f22Report);
    }
  };

  // Handle saving image plan batch
  const handleSaveImagePlanBatch = async () => {
    if (!gconPieceId || !selectedBatchId) {
      alert('Please select an image plan batch first');
      return;
    }

    setIsSavingBatch(true);

    try {
      const { error } = await supabase
        .from('gcon_pieces')
        .update({ asn_image_plan_batch_id: selectedBatchId })
        .eq('id', gconPieceId);

      if (error) {
        throw error;
      }

      // Update local state
      setGconPiece((prev: any) => prev ? { ...prev, asn_image_plan_batch_id: selectedBatchId } : prev);
      
      alert('Image plan batch saved successfully!');
    } catch (error) {
      console.error('Error saving image plan batch:', error);
      alert('Failed to save image plan batch');
    } finally {
      setIsSavingBatch(false);
    }
  };

  // Helper function to recursively find and update Elementor element by ID
  const updateElementorImageById = (elementorData: any, targetElId: string, imageUrl: string, imageId: string): boolean => {
    let updated = false;
    
    // Recursive function to traverse the Elementor structure
    const traverseElements = (elements: any[]): boolean => {
      if (!Array.isArray(elements)) return false;
      
      for (const element of elements) {
        // Check if this is the target element
        if (element.id === targetElId) {
          console.log(`üéØ Found target element ${targetElId}, checking for image settings...`);
          // Update image data in this element's settings
          if (element.settings) {
            // Handle different image property patterns
            if (element.settings.image) {
              if (typeof element.settings.image === 'object') {
                element.settings.image.url = imageUrl;
                element.settings.image.id = parseInt(imageId);
              } else {
                element.settings.image = {
                  url: imageUrl,
                  id: parseInt(imageId)
                };
              }
              updated = true;
            }
            
            // Handle background image
            if (element.settings.background_image) {
              if (typeof element.settings.background_image === 'object') {
                element.settings.background_image.url = imageUrl;
                element.settings.background_image.id = parseInt(imageId);
              } else {
                element.settings.background_image = {
                  url: imageUrl,
                  id: parseInt(imageId)
                };
              }
              updated = true;
            }
            
            // Handle other common image properties
            ['background_background', '_background_background'].forEach(prop => {
              if (element.settings[prop] === 'classic' && element.settings[prop + '_image']) {
                if (typeof element.settings[prop + '_image'] === 'object') {
                  element.settings[prop + '_image'].url = imageUrl;
                  element.settings[prop + '_image'].id = parseInt(imageId);
                } else {
                  element.settings[prop + '_image'] = {
                    url: imageUrl,
                    id: parseInt(imageId)
                  };
                }
                updated = true;
              }
            });
          }
          
          return true; // Found and processed the target element
        }
        
        // Recursively check child elements
        if (element.elements && Array.isArray(element.elements)) {
          if (traverseElements(element.elements)) {
            updated = true;
          }
        }
      }
      
      return updated;
    };
    
    // Start traversal from root
    if (Array.isArray(elementorData)) {
      return traverseElements(elementorData);
    }
    
    return false;
  };

  // Handle compile new_desired_text_content into pelementor_edits
  const handleCompileTextContent = async () => {
    if (!gconPieceId || !gconPiece) {
      alert('No gcon_piece found to process');
      return;
    }

    if (!gconPiece.pelementor_cached) {
      alert('No pelementor_cached data found to use as starting point');
      return;
    }

    setIsCompilingTextContent(true);

    try {
      // Step 1: Start with pelementor_cached as our base for pelementor_edits
      // Ensure we're working with a string, not an object
      let pelementorEditsContent = typeof gconPiece.pelementor_cached === 'string' 
        ? gconPiece.pelementor_cached 
        : JSON.stringify(gconPiece.pelementor_cached);

      // Step 2: Fetch all nemtor_units for this gcon_piece
      const { data: nemtorUnits, error: nemtorError } = await supabase
        .from('nemtor_units')
        .select('unit_id, full_text_cached, full_text_edits, has_img_slot, el_id')
        .eq('fk_gcon_piece_id', gconPieceId);

      if (nemtorError) {
        console.error('Error fetching nemtor_units:', nemtorError);
        throw nemtorError;
      }

      if (!nemtorUnits || nemtorUnits.length === 0) {
        alert('No nemtor_units found for this gcon_piece');
        return;
      }

      // Step 3: Process units that have full_text_edits values
      let replacementsCount = 0;
      const replacements: { original: string; replacement: string; unitId: string }[] = [];

      nemtorUnits.forEach(unit => {
        // Only process if full_text_edits has a real value (not null, empty, or whitespace)
        if (unit.full_text_edits && unit.full_text_edits.trim() !== '') {
          // Only process if we also have original full_text_cached to replace
          if (unit.full_text_cached && unit.full_text_cached.trim() !== '') {
            // Replace full_text_cached with full_text_edits in pelementorEditsContent
            const originalText = unit.full_text_cached;
            const newText = unit.full_text_edits;
            
            // Check if the original text exists in pelementorEditsContent
            if (pelementorEditsContent.includes(originalText)) {
              pelementorEditsContent = pelementorEditsContent.replace(originalText, newText);
              replacementsCount++;
              replacements.push({
                original: originalText.substring(0, 100) + (originalText.length > 100 ? '...' : ''),
                replacement: newText.substring(0, 100) + (newText.length > 100 ? '...' : ''),
                unitId: unit.unit_id
              });
            }
          }
        }
      });

      // Step 4: Process manual image inputs (includes active checkboxes for man_img_url and man_img_id)
      let imageReplacementsCount = 0;
      if (manualImageDataRef.current) {
        const { urls, ids, checkboxes } = manualImageDataRef.current;
        
        try {
          // Parse the Elementor JSON to work with structured data
          const elementorData = JSON.parse(pelementorEditsContent);
          
          nemtorUnits.forEach(unit => {
            // Only process units that have has_img_slot = true AND checkbox is checked
            if (unit.has_img_slot === true && checkboxes.get(unit.unit_id)) {
              const manualUrl = urls.get(unit.unit_id);
              const manualId = ids.get(unit.unit_id);
              
              // Only proceed if we have both URL and ID and el_id
              if (manualUrl && manualUrl.trim() !== '' && manualId && manualId.trim() !== '' && unit.el_id) {
                console.log(`üñºÔ∏è Processing image for unit ${unit.unit_id}, el_id: ${unit.el_id}, URL: ${manualUrl}, ID: ${manualId}`);
                
                // Find and update the specific element by el_id
                const updated = updateElementorImageById(elementorData, unit.el_id, manualUrl, manualId);
                
                if (updated) {
                  console.log(`‚úÖ Successfully updated image for element ${unit.el_id}`);
                  imageReplacementsCount++;
                  replacements.push({
                    original: `Image in element ${unit.el_id}`,
                    replacement: `URL: ${manualUrl.substring(0, 50)}${manualUrl.length > 50 ? '...' : ''}, ID: ${manualId}`,
                    unitId: unit.unit_id
                  });
                } else {
                  console.log(`‚ùå Could not find/update element with ID: ${unit.el_id}`);
                }
              } else {
                console.log(`‚ö†Ô∏è Skipping unit ${unit.unit_id}: missing data - URL: ${!!manualUrl}, ID: ${!!manualId}, el_id: ${!!unit.el_id}`);
              }
            }
          });
          
          // Convert back to string
          pelementorEditsContent = JSON.stringify(elementorData);
          
        } catch (jsonError) {
          console.error('Error parsing Elementor JSON:', jsonError);
          // Fall back to string-based approach if JSON parsing fails
          console.log('Falling back to string-based image replacement...');
        }
      }

      // Step 5: Update pelementor_edits in database
      // Convert back to object if original was an object, or keep as string
      const pelementorEditsForDb = typeof gconPiece.pelementor_cached === 'object' 
        ? JSON.parse(pelementorEditsContent)
        : pelementorEditsContent;

      const { error: updateError } = await supabase
        .from('gcon_pieces')
        .update({ pelementor_edits: pelementorEditsForDb })
        .eq('id', gconPieceId);

      if (updateError) {
        console.error('Error updating pelementor_edits:', updateError);
        throw updateError;
      }

      // Step 6: Update local state
      setGconPiece((prev: any) => prev ? { ...prev, pelementor_edits: pelementorEditsForDb } : prev);

      // Step 7: Show success message with details
      const totalReplacements = replacementsCount + imageReplacementsCount;
      const successMessage = `Successfully compiled content!\n\nText replacements: ${replacementsCount}\nImage replacements: ${imageReplacementsCount}\nTotal replacements: ${totalReplacements}\n\n` +
        replacements.map(r => `‚Ä¢ Unit ${r.unitId.substring(0, 8)}...\n  FROM: ${r.original}\n  TO: ${r.replacement}`).join('\n\n');
      
      alert(successMessage);

    } catch (error) {
      console.error('Error compiling text content:', error);
      alert('Failed to compile text content. Please try again.');
    } finally {
      setIsCompilingTextContent(false);
    }
  };

  // Handle run dublish function
  const handleRunDublish = async () => {
    if (!gconPieceId || !gconPiece) {
      alert('No gcon_piece found to process');
      return;
    }

    if (!gconPiece.pelementor_edits) {
      alert('No pelementor_edits data found. Please compile text content first.');
      return;
    }

    if (!gconPiece.asn_sitespren_base) {
      alert('No asn_sitespren_base found. Cannot determine target WordPress site.');
      return;
    }

    setIsRunningDublish(true);
    setDublishProgress('Initializing...');
    setDublishResult(null);

    try {
      // Step 1: Prepare Elementor page data
      setDublishProgress('Preparing Elementor page data...');
      
      const pageTitle = gconPiece.h1title || gconPiece.mud_title || 'New Elementor Page';
      const pageSlug = gconPiece.pageslug || gconPiece.post_name || 'new-elementor-page';
      const elementorData = gconPiece.pelementor_edits;

      // Step 2: Create WordPress post
      setDublishProgress('Creating WordPress post...');
      
      let apiResponse;
      
      switch (dublishConnectionType) {
        case 'snefuruplin':
          // Use Snefuruplin WP Plugin
          setDublishProgress('Connecting via Snefuruplin WP Plugin...');
          apiResponse = await createElementorPageViaSnefuruplin({
            siteUrl: gconPiece.asn_sitespren_base,
            title: pageTitle,
            slug: pageSlug,
            elementorData: elementorData,
            gconPieceId: gconPieceId
          });
          break;
          
        case 'rest_api':
          // Use WordPress REST API
          setDublishProgress('Connecting via WordPress REST API...');
          apiResponse = await createElementorPageViaRestAPI({
            siteUrl: gconPiece.asn_sitespren_base,
            title: pageTitle,
            slug: pageSlug,
            elementorData: elementorData,
            gconPieceId: gconPieceId
          });
          break;
          
        case 'api_other':
          // Use other API method
          setDublishProgress('Connecting via alternative API...');
          apiResponse = await createElementorPageViaOtherAPI({
            siteUrl: gconPiece.asn_sitespren_base,
            title: pageTitle,
            slug: pageSlug,
            elementorData: elementorData,
            gconPieceId: gconPieceId
          });
          break;
          
        default:
          throw new Error('Invalid connection type selected');
      }

      // Step 3: Process response
      setDublishProgress('Processing response...');
      
      if (apiResponse.success) {
        const wpEditorUrl = `https://${gconPiece.asn_sitespren_base}/wp-admin/post.php?post=${apiResponse.postId}&action=elementor`;
        const liveUrl = `https://${gconPiece.asn_sitespren_base}/${pageSlug}`;
        
        setDublishResult({
          success: true,
          wpEditorUrl,
          liveUrl,
          postId: apiResponse.postId,
          message: `Successfully created Elementor page "${pageTitle}"`
        });
        
        setDublishProgress('‚úÖ Page created successfully!');
      } else {
        throw new Error(apiResponse.message || 'Failed to create page');
      }

    } catch (error) {
      console.error('Error running dublish function:', error);
      setDublishResult({
        success: false,
        message: error instanceof Error ? error.message : 'Unknown error occurred'
      });
      setDublishProgress('‚ùå Failed to create page');
    } finally {
      setIsRunningDublish(false);
    }
  };

  // Snefuruplin WP Plugin implementation
  const createElementorPageViaSnefuruplin = async (params: {
    siteUrl: string;
    title: string;
    slug: string;
    elementorData: string;
    gconPieceId: string;
  }) => {
    // This would connect to your custom WordPress plugin
    const response = await fetch('/api/dublish-create-elementor-page', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        site_url: params.siteUrl,
        post_title: params.title,
        post_name: params.slug,
        post_status: 'publish',
        post_type: 'page',
        elementor_data: params.elementorData,
        gcon_piece_id: params.gconPieceId,
        // Elementor-specific meta fields
        meta_input: {
          '_elementor_edit_mode': 'builder',
          '_elementor_template_type': 'wp-page',
          '_elementor_version': '3.17.0',
          '_elementor_pro_version': '3.17.0',
          '_elementor_data': params.elementorData,
          '_elementor_page_settings': JSON.stringify({
            "custom_css": "",
            "page_title": "hide",
            "page_description": "hide"
          }),
          '_wp_page_template': 'default'
        }
      })
    });

    return await response.json();
  };

  // WordPress REST API implementation
  const createElementorPageViaRestAPI = async (params: {
    siteUrl: string;
    title: string;
    slug: string;
    elementorData: string;
    gconPieceId: string;
  }) => {
    // Step 1: Create the post via REST API
    const createPostResponse = await fetch(`https://${params.siteUrl}/wp-json/wp/v2/pages`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer YOUR_WP_TOKEN', // You'll need to implement auth
      },
      body: JSON.stringify({
        title: params.title,
        slug: params.slug,
        status: 'publish',
        template: 'elementor_header_footer'
      })
    });

    const post = await createPostResponse.json();
    
    if (!createPostResponse.ok) {
      throw new Error(post.message || 'Failed to create post');
    }

    // Step 2: Add Elementor meta data
    const metaUpdates = [
      { key: '_elementor_edit_mode', value: 'builder' },
      { key: '_elementor_template_type', value: 'wp-page' },
      { key: '_elementor_version', value: '3.17.0' },
      { key: '_elementor_data', value: params.elementorData },
      { key: '_elementor_page_settings', value: JSON.stringify({
        "custom_css": "",
        "page_title": "hide", 
        "page_description": "hide"
      }) }
    ];

    for (const meta of metaUpdates) {
      await fetch(`https://${params.siteUrl}/wp-json/wp/v2/pages/${post.id}/meta`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer YOUR_WP_TOKEN',
        },
        body: JSON.stringify(meta)
      });
    }

    return {
      success: true,
      postId: post.id,
      message: 'Page created successfully via REST API'
    };
  };

  // Alternative API implementation
  const createElementorPageViaOtherAPI = async (params: {
    siteUrl: string;
    title: string;
    slug: string;
    elementorData: string;
    gconPieceId: string;
  }) => {
    // This could be a custom API endpoint you create
    const response = await fetch('/api/wordpress/create-elementor-page', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        target_site: params.siteUrl,
        page_data: {
          post_title: params.title,
          post_name: params.slug,
          post_status: 'publish',
          post_type: 'page',
          post_content: '', // Elementor uses meta, not content
          meta_input: {
            '_elementor_edit_mode': 'builder',
            '_elementor_template_type': 'wp-page',
            '_elementor_version': '3.17.0',
            '_elementor_data': params.elementorData,
            '_wp_page_template': 'default'
          }
        },
        gcon_piece_id: params.gconPieceId
      })
    });

    return await response.json();
  };

  // Handle run snoverride function
  const handleRunSnoverride = async () => {
    if (!gconPieceId || !gconPiece) {
      alert('No gcon_piece found to process');
      return;
    }

    if (!gconPiece.pelementor_edits) {
      alert('No pelementor_edits data found. Please compile text content first.');
      return;
    }

    if (!gconPiece.asn_sitespren_base) {
      alert('No asn_sitespren_base found. Cannot determine target WordPress site.');
      return;
    }

    if (!gconPiece.g_post_id) {
      alert('No g_post_id found. Cannot identify which WordPress post to update.');
      return;
    }

    setIsRunningSnoverride(true);
    setSnoverrideProgress('Initializing...');
    setSnoverrideResult(null);

    try {
      // Step 1: Prepare update data
      setSnoverrideProgress('Preparing Elementor page update...');
      
      const pageTitle = gconPiece.h1title || gconPiece.mud_title || 'Updated Elementor Page';
      const elementorData = gconPiece.pelementor_edits;
      const postId = gconPiece.g_post_id;

      // Step 2: Update WordPress post
      setSnoverrideProgress('Updating WordPress post...');
      
      let apiResponse;
      
      switch (snoverrideConnectionType) {
        case 'snefuruplin':
          // Use Snefuruplin WP Plugin
          setSnoverrideProgress('Connecting via Snefuruplin WP Plugin...');
          apiResponse = await updateElementorPageViaSnefuruplin({
            siteUrl: gconPiece.asn_sitespren_base,
            postId: postId,
            title: pageTitle,
            elementorData: elementorData,
            gconPieceId: gconPieceId
          });
          break;
          
        case 'rest_api':
          // Use WordPress REST API
          setSnoverrideProgress('Connecting via WordPress REST API...');
          apiResponse = await updateElementorPageViaRestAPI({
            siteUrl: gconPiece.asn_sitespren_base,
            postId: postId,
            title: pageTitle,
            elementorData: elementorData,
            gconPieceId: gconPieceId
          });
          break;
          
        case 'api_other':
          // Use other API method
          setSnoverrideProgress('Connecting via alternative API...');
          apiResponse = await updateElementorPageViaOtherAPI({
            siteUrl: gconPiece.asn_sitespren_base,
            postId: postId,
            title: pageTitle,
            elementorData: elementorData,
            gconPieceId: gconPieceId
          });
          break;
          
        default:
          throw new Error('Invalid connection type selected');
      }

      // Step 3: Process response
      setSnoverrideProgress('Processing response...');
      
      if (apiResponse.success) {
        const wpEditorUrl = `https://${gconPiece.asn_sitespren_base}/wp-admin/post.php?post=${postId}&action=elementor`;
        const liveUrl = `https://${gconPiece.asn_sitespren_base}/?p=${postId}`;
        
        setSnoverrideResult({
          success: true,
          wpEditorUrl,
          liveUrl,
          postId: postId,
          message: `Successfully updated Elementor page "${pageTitle}"`
        });
        
        setSnoverrideProgress('‚úÖ Page updated successfully!');
      } else {
        throw new Error(apiResponse.message || 'Failed to update page');
      }

    } catch (error) {
      console.error('Error running snoverride function:', error);
      setSnoverrideResult({
        success: false,
        message: error instanceof Error ? error.message : 'Unknown error occurred'
      });
      setSnoverrideProgress('‚ùå Failed to update page');
    } finally {
      setIsRunningSnoverride(false);
    }
  };

  // Snefuruplin WP Plugin update implementation
  const updateElementorPageViaSnefuruplin = async (params: {
    siteUrl: string;
    postId: number;
    title: string;
    elementorData: string;
    gconPieceId: string;
  }) => {
    const response = await fetch('/api/snoverride-update-elementor-page', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        site_url: params.siteUrl,
        post_id: params.postId,
        post_title: params.title,
        elementor_data: params.elementorData,
        gcon_piece_id: params.gconPieceId,
        // Update only the elementor data and title
        update_fields: {
          post_title: params.title,
          meta_input: {
            '_elementor_data': params.elementorData,
            '_elementor_edit_mode': 'builder',
            '_elementor_version': '3.17.0'
          }
        }
      })
    });

    return await response.json();
  };

  // WordPress REST API update implementation
  const updateElementorPageViaRestAPI = async (params: {
    siteUrl: string;
    postId: number;
    title: string;
    elementorData: string;
    gconPieceId: string;
  }) => {
    // Step 1: Update the post via REST API
    const updatePostResponse = await fetch(`https://${params.siteUrl}/wp-json/wp/v2/pages/${params.postId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer YOUR_WP_TOKEN', // You'll need to implement auth
      },
      body: JSON.stringify({
        title: params.title
      })
    });

    const post = await updatePostResponse.json();
    
    if (!updatePostResponse.ok) {
      throw new Error(post.message || 'Failed to update post');
    }

    // Step 2: Update Elementor meta data
    const metaUpdates = [
      { key: '_elementor_data', value: params.elementorData },
      { key: '_elementor_edit_mode', value: 'builder' },
      { key: '_elementor_version', value: '3.17.0' }
    ];

    for (const meta of metaUpdates) {
      await fetch(`https://${params.siteUrl}/wp-json/wp/v2/pages/${params.postId}/meta`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer YOUR_WP_TOKEN',
        },
        body: JSON.stringify(meta)
      });
    }

    return {
      success: true,
      postId: params.postId,
      message: 'Page updated successfully via REST API'
    };
  };

  // Alternative API update implementation
  const updateElementorPageViaOtherAPI = async (params: {
    siteUrl: string;
    postId: number;
    title: string;
    elementorData: string;
    gconPieceId: string;
  }) => {
    const response = await fetch('/api/wordpress/update-elementor-page', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        target_site: params.siteUrl,
        post_id: params.postId,
        update_data: {
          post_title: params.title,
          meta_input: {
            '_elementor_data': params.elementorData,
            '_elementor_edit_mode': 'builder',
            '_elementor_version': '3.17.0'
          }
        },
        gcon_piece_id: params.gconPieceId
      })
    });

    return await response.json();
  };

  if (!user) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <p className="text-gray-500">Please log in to access this page.</p>
      </div>
    );
  }

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
          <p className="mt-2 text-gray-600">Loading...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <p className="text-red-600">Error: {error}</p>
        </div>
      </div>
    );
  }

  return (
    <div className="page-tornado min-h-screen bg-gray-50">
      {/* Sticky Menu Component */}
      <MarzdiStickyMenu h1Title={gconPiece?.h1title} />
      
      <div className="p-4">
        <div className="mb-4 flex items-center gap-4">
          <Link href="/dashboard" className="text-blue-600 hover:text-blue-800">
            ‚Üê Back to Dashboard
          </Link>
          <button
            className={`px-4 py-2 font-medium rounded-md transition-colors ${
              isPopulatingUnits
                ? 'bg-gray-400 cursor-not-allowed text-white'
                : 'bg-purple-600 hover:bg-purple-700 text-white'
            }`}
            onClick={handlePopulateNemtorUnits}
            disabled={isPopulatingUnits || !gconPieceId}
          >
            {isPopulatingUnits ? 'Populating...' : 'handlePopulateNemtorUnit'}
          </button>
        </div>
        
        {/* Populate feedback message */}
        {populateMessage && (
          <div className={`mb-4 p-3 rounded-md ${
            populateMessage.startsWith('‚úÖ') 
              ? 'bg-green-100 border border-green-400 text-green-700'
              : 'bg-red-100 border border-red-400 text-red-700'
          }`}>
            {populateMessage}
          </div>
        )}
        
        {/* Cloned Areas from Mesagen Page */}
        {gconPieceId && (
          <div className="mb-4">
            <div className="flex items-start gap-4" style={{ marginTop: '10px' }}>
              {/* AREA 1: Info Box - Cloned from mesagen */}
              <div className="bg-gray-50 border border-gray-300 rounded-lg p-4" style={{ width: '450px' }}>
                <div className="mb-3">
                  <Link href="/gconjar1" className="text-blue-600 hover:text-blue-800">
                    ‚Üê Back to GconJar1
                  </Link>
                </div>
                
                <div className="mb-3">
                  <Link href={`/tornado?gcon_piece_id=${gconPieceId}`} className="text-blue-600 hover:text-blue-800">
                    -- Visit /tornado --
                  </Link>
                </div>
                
                <div className="mb-3 text-sm text-gray-600">
                  <strong>gcon_pieces.id:</strong> {gconPieceId}
                </div>

                {/* asn_sitespren_base */}
                <div className="mb-3">
                  <label className="block text-sm font-bold text-gray-700 mb-1">
                    asn_sitespren_base
                  </label>
                  <div className="w-full px-3 py-2 border border-gray-300 rounded bg-gray-50 text-sm">
                    {gconPiece?.asn_sitespren_base || 'Not set'}
                  </div>
                </div>

                {/* post_name */}
                <div className="mb-3">
                  <label className="block text-sm font-bold text-gray-700 mb-1">
                    post_name
                  </label>
                  <div className="flex items-center gap-1 p-2 bg-gray-900 text-green-400 rounded font-mono text-sm border">
                    <button
                      onClick={() => {
                        if (gconPiece?.asn_sitespren_base && gconPiece?.post_name) {
                          window.open(`https://${gconPiece.asn_sitespren_base}/${gconPiece.post_name}`, '_blank');
                        }
                      }}
                      disabled={!gconPiece?.post_name || !gconPiece?.asn_sitespren_base}
                      className="w-6 h-6 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white rounded flex items-center justify-center"
                      title="Open in new tab"
                    >
                      ‚Üó
                    </button>
                    <button
                      onClick={() => navigator.clipboard.writeText(gconPiece?.post_name || '')}
                      className="w-6 h-6 bg-gray-600 hover:bg-gray-700 text-white rounded flex items-center justify-center"
                      title="Copy to clipboard"
                    >
                      üìã
                    </button>
                    <span className="flex-1 px-2">
                      {gconPiece?.post_name || ''}
                    </span>
                  </div>
                </div>

                {/* pageslug */}
                <div className="mb-3">
                  <label className="block text-sm font-bold text-gray-700 mb-1">
                    pageslug
                  </label>
                  <div className="flex items-center gap-1 p-2 bg-gray-900 text-green-400 rounded font-mono text-sm border">
                    <button
                      onClick={() => {
                        if (gconPiece?.asn_sitespren_base && gconPiece?.pageslug) {
                          window.open(`https://${gconPiece.asn_sitespren_base}/${gconPiece.pageslug}`, '_blank');
                        }
                      }}
                      disabled={!gconPiece?.pageslug || !gconPiece?.asn_sitespren_base}
                      className="w-6 h-6 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white rounded flex items-center justify-center"
                      title="Open in new tab"
                    >
                      ‚Üó
                    </button>
                    <button
                      onClick={() => navigator.clipboard.writeText(gconPiece?.pageslug || '')}
                      className="w-6 h-6 bg-gray-600 hover:bg-gray-700 text-white rounded flex items-center justify-center"
                      title="Copy to clipboard"
                    >
                      üìã
                    </button>
                    <span className="flex-1 px-2">
                      {gconPiece?.pageslug || ''}
                    </span>
                  </div>
                </div>

                {/* pageurl */}
                <div className="mb-3">
                  <label className="block text-sm font-bold text-gray-700 mb-1">
                    pageurl
                  </label>
                  <div className="flex items-center gap-1 p-2 bg-gray-900 text-green-400 rounded font-mono text-sm border">
                    <button
                      onClick={() => {
                        if (gconPiece?.pageurl) {
                          window.open(gconPiece.pageurl, '_blank');
                        }
                      }}
                      disabled={!gconPiece?.pageurl}
                      className="w-6 h-6 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white rounded flex items-center justify-center"
                      title="Open in new tab"
                    >
                      ‚Üó
                    </button>
                    <button
                      onClick={() => navigator.clipboard.writeText(gconPiece?.pageurl || '')}
                      className="w-6 h-6 bg-gray-600 hover:bg-gray-700 text-white rounded flex items-center justify-center"
                      title="Copy to clipboard"
                    >
                      üìã
                    </button>
                    <span className="flex-1 px-2">
                      {gconPiece?.pageurl || ''}
                    </span>
                  </div>
                </div>
              </div>

              {/* AREA 2: Image Plans Batch Box - Cloned from mesagen */}
              <div className="bg-gray-50 border border-gray-300 rounded-lg p-4" style={{ width: '450px' }}>
                <div className="mb-3">
                  <div className="flex items-center justify-between mb-2">
                    <label className="text-sm font-bold text-gray-700">
                      asn_image_plan_batch_id
                    </label>
                    <button
                      onClick={() => {
                        // Placeholder - waiting for backend functionality instructions
                        console.log('Create new batch clicked');
                      }}
                      className="rounded"
                      style={{
                        backgroundColor: '#d3d3d3', // light gray
                        color: '#4a4a4a', // dark gray
                        fontSize: '13px',
                        padding: '3px 8px'
                      }}
                    >
                      create new batch
                    </button>
                  </div>
                  <select
                    className="w-full px-3 py-2 border border-gray-300 rounded bg-white text-sm"
                    value={selectedBatchId}
                    onChange={(e) => setSelectedBatchId(e.target.value)}
                  >
                    <option value="">Select image plan batch...</option>
                    {imagePlansBatches.map((batch) => (
                      <option key={batch.id} value={batch.id}>
                        {batch.batch_name || `Batch ${batch.id.substring(0, 8)}...`}
                      </option>
                    ))}
                  </select>
                </div>
                
                <div className="mt-4 flex gap-2">
                  <button
                    onClick={handleSaveImagePlanBatch}
                    disabled={isSavingBatch || !selectedBatchId}
                    className="px-4 py-2 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed"
                    style={{
                      backgroundColor: '#000000',
                      fontSize: '16px'
                    }}
                  >
                    {isSavingBatch ? 'Saving...' : 'save'}
                  </button>
                  
                  {/* Open Batch Button - Show if batch is selected or assigned */}
                  {(selectedBatchId || gconPiece?.asn_image_plan_batch_id) && (
                    <a
                      href={`https://snef.me/bin34/tebnar2?batchid=${selectedBatchId || gconPiece?.asn_image_plan_batch_id}`}
                      className="px-4 py-2 rounded inline-block text-center"
                      style={{
                        backgroundColor: '#009bff', // bestlinkcol
                        fontSize: '16px',
                        fontWeight: 'bold',
                        color: '#000',
                        border: '2px solid #000',
                        textDecoration: 'none'
                      }}
                    >
                      open batch in /tebnar2
                    </a>
                  )}
                </div>

                {/* Narpi Pushes Table */}
                {(selectedBatchId || gconPiece?.asn_image_plan_batch_id) && narpiPushes.length > 0 && (
                  <div className="mt-4">
                    <div className="overflow-x-auto rounded border border-gray-300" style={{ maxWidth: '440px' }}>
                      <table className="min-w-full" style={{ fontSize: '14px' }}>
                        <thead>
                          <tr className="bg-gray-100">
                            <th style={{ width: '30px', padding: '3px', minWidth: '30px' }} className="text-left font-bold">
                              <input
                                type="checkbox"
                                checked={selectedNarpiPushes.size === narpiPushes.length && narpiPushes.length > 0}
                                onChange={(e) => {
                                  if (e.target.checked) {
                                    setSelectedNarpiPushes(new Set(narpiPushes.map(p => p.id)));
                                  } else {
                                    setSelectedNarpiPushes(new Set());
                                  }
                                }}
                              />
                            </th>
                            <th style={{ width: '200px', padding: '3px', minWidth: '200px' }} className="text-left font-bold">kareench1</th>
                            <th style={{ width: '60px', padding: '3px', minWidth: '60px' }} className="text-left font-bold">id</th>
                            <th style={{ width: '120px', padding: '3px', minWidth: '120px' }} className="text-left font-bold">push_name</th>
                            <th style={{ width: '80px', padding: '3px', minWidth: '80px' }} className="text-left font-bold">push_status1</th>
                            <th style={{ width: '60px', padding: '3px', minWidth: '60px' }} className="text-left font-bold">created_at</th>
                          </tr>
                        </thead>
                        <tbody>
                          {narpiPushes.map((push) => (
                            <tr key={push.id} className="border-t border-gray-200 hover:bg-gray-50">
                              <td style={{ padding: '3px' }}>
                                <div style={{ height: '19px' }} className="flex items-center">
                                  <input
                                    type="checkbox"
                                    checked={selectedNarpiPushes.has(push.id)}
                                    onChange={(e) => {
                                      const newSelected = new Set(selectedNarpiPushes);
                                      if (e.target.checked) {
                                        newSelected.add(push.id);
                                      } else {
                                        newSelected.delete(push.id);
                                      }
                                      setSelectedNarpiPushes(newSelected);
                                    }}
                                  />
                                </div>
                              </td>
                              <td style={{ padding: '3px' }}>
                                <div style={{ height: '19px' }} className="flex items-center space-x-1">
                                  <div style={{ fontSize: '11px' }}>
                                    {push.kareench1 && Array.isArray(push.kareench1) ? (
                                      <div className="flex space-x-1">
                                        {(() => {
                                          const results = push.kareench1;
                                          const total = results.length;
                                          const success = results.filter((r: any) => r.nupload_status1 === 'success').length;
                                          const failed = results.filter((r: any) => r.nupload_status1 === 'failed').length;
                                          
                                          return (
                                            <>
                                              <span className="bg-blue-100 text-blue-800 px-1 rounded text-xs">T:{total}</span>
                                              <span className="bg-green-100 text-green-800 px-1 rounded text-xs">‚úì{success}</span>
                                              <span className="bg-red-100 text-red-800 px-1 rounded text-xs">‚úó{failed}</span>
                                            </>
                                          );
                                        })()}
                                      </div>
                                    ) : push.kareench1 ? (
                                      <div className="truncate text-xs" style={{ maxWidth: '120px' }}>
                                        {typeof push.kareench1 === 'string' 
                                          ? (push.kareench1.length > 20 ? `${push.kareench1.substring(0, 20)}...` : push.kareench1)
                                          : JSON.stringify(push.kareench1).length > 20 
                                            ? `${JSON.stringify(push.kareench1).substring(0, 20)}...`
                                            : JSON.stringify(push.kareench1)
                                        }
                                      </div>
                                    ) : (
                                      <span className="text-gray-400 italic text-xs">No data</span>
                                    )}
                                  </div>
                                  {push.kareench1 && (
                                    <button
                                      onClick={() => copyNarpiKareenchValue(push.id, push.kareench1)}
                                      className={`px-1 py-0.5 text-xs rounded ${
                                        copiedNarpiId === push.id
                                          ? 'text-green-800 bg-green-100'
                                          : 'text-gray-600 bg-gray-100 hover:bg-gray-200'
                                      }`}
                                      style={{ fontSize: '10px' }}
                                    >
                                      {copiedNarpiId === push.id ? '‚úì' : 'Copy'}
                                    </button>
                                  )}
                                </div>
                              </td>
                              <td style={{ padding: '3px' }}>
                                <div style={{ height: '19px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                  {push.id.substring(0, 8)}...
                                </div>
                              </td>
                              <td style={{ padding: '3px' }}>
                                <div style={{ height: '19px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                  {push.push_name || '-'}
                                </div>
                              </td>
                              <td style={{ padding: '3px' }}>
                                <div style={{ height: '19px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                  {push.push_status1 || '-'}
                                </div>
                              </td>
                              <td style={{ padding: '3px' }}>
                                <div style={{ height: '19px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                  {new Date(push.created_at).toLocaleDateString('en-US', { month: '2-digit', day: '2-digit' })}
                                </div>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}

                {/* Open Narpo1 Button - Show if batch is selected or assigned */}
                {(selectedBatchId || gconPiece?.asn_image_plan_batch_id) && (
                  <div className="mt-3">
                    <a
                      href={`https://snef.me/bin42/narpo1?fk_batch_id=${selectedBatchId || gconPiece?.asn_image_plan_batch_id}`}
                      className="px-4 py-2 rounded inline-block text-center"
                      style={{
                        backgroundColor: '#009bff', // bestlinkcol
                        fontSize: '16px',
                        fontWeight: 'bold',
                        color: '#000',
                        border: '2px solid #000',
                        textDecoration: 'none'
                      }}
                    >
                      open /narpo1
                    </a>
                  </div>
                )}
              </div>

              {/* NEW AREA 3: Dublish Function Box */}
              <div className="bg-gray-50 border border-gray-300 rounded-lg p-4" style={{ width: '450px' }}>
                <div className="mb-3">
                  <strong className="text-sm font-bold text-gray-700">
                    Publish new elementor page using dublish function
                  </strong>
                </div>
                
                <hr className="my-3 border-gray-300" />
                
                <div className="mb-3">
                  <button
                    onClick={handleCompileTextContent}
                    disabled={isCompilingTextContent || !gconPiece?.pelementor_cached}
                    className={`w-full px-4 py-2 text-white rounded transition-colors ${
                      isCompilingTextContent || !gconPiece?.pelementor_cached
                        ? 'bg-gray-400 cursor-not-allowed'
                        : 'bg-black hover:bg-gray-800'
                    }`}
                    style={{
                      fontSize: '14px'
                    }}
                  >
                    {isCompilingTextContent ? 'Compiling...' : 'compile new_desired_text_content into pelementor_edits'}
                  </button>
                  <p className="text-xs text-gray-600 mt-2 italic">
                    (includes active checkboxes for man_img_url and man_img_id)
                  </p>
                </div>
                
                <hr className="my-3 border-gray-300" />
                
                <div className="mb-3">
                  <button
                    onClick={() => alert('compile new_desired_image_content into pelementor_edits - functionality coming soon')}
                    className="w-full px-4 py-2 text-white rounded"
                    style={{
                      backgroundColor: '#000000',
                      fontSize: '14px'
                    }}
                  >
                    compile new_desired_image_content into pelementor_edits
                  </button>
                </div>
                
                <hr className="my-3 border-gray-300" />
                
                <div className="mb-3">
                  <button
                    onClick={handleRunDublish}
                    disabled={isRunningDublish || !gconPiece?.pelementor_edits || !gconPiece?.asn_sitespren_base}
                    className={`w-full px-4 py-2 text-white rounded transition-colors ${
                      isRunningDublish || !gconPiece?.pelementor_edits || !gconPiece?.asn_sitespren_base
                        ? 'bg-gray-400 cursor-not-allowed'
                        : 'bg-black hover:bg-gray-800'
                    }`}
                    style={{
                      fontSize: '14px'
                    }}
                  >
                    {isRunningDublish ? (
                      <div className="flex items-center justify-center gap-2">
                        <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                        Publishing...
                      </div>
                    ) : (
                      'run dublish function'
                    )}
                  </button>
                </div>

                {/* Connection Type Selector */}
                <div className="mb-3">
                  <label className="block text-xs font-bold text-gray-700 mb-2">
                    Connection Type:
                  </label>
                  <select
                    value={dublishConnectionType}
                    onChange={(e) => setDublishConnectionType(e.target.value as 'snefuruplin' | 'rest_api' | 'api_other')}
                    disabled={isRunningDublish}
                    className="w-full px-3 py-2 border border-gray-300 rounded text-sm bg-white disabled:bg-gray-100"
                  >
                    <option value="snefuruplin">Snefuruplin WP Plugin</option>
                    <option value="rest_api">REST API</option>
                    <option value="api_other">API (other)</option>
                  </select>
                </div>

                {/* Progress Indicator */}
                {dublishProgress && (
                  <div className="mb-3 p-2 bg-blue-50 border border-blue-200 rounded">
                    <div className="text-xs text-blue-800">
                      <strong>Status:</strong> {dublishProgress}
                    </div>
                    {isRunningDublish && (
                      <div className="mt-2">
                        <div className="w-full bg-blue-200 rounded-full h-2">
                          <div className="bg-blue-600 h-2 rounded-full animate-pulse" style={{ width: '60%' }}></div>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Results Section */}
                {dublishResult && (
                  <div className={`mb-3 p-3 border rounded ${
                    dublishResult.success 
                      ? 'bg-green-50 border-green-200' 
                      : 'bg-red-50 border-red-200'
                  }`}>
                    <div className={`text-sm font-medium ${
                      dublishResult.success ? 'text-green-800' : 'text-red-800'
                    }`}>
                      {dublishResult.message}
                    </div>
                    
                    {dublishResult.success && dublishResult.wpEditorUrl && dublishResult.liveUrl && (
                      <div className="mt-3 space-y-2">
                        <a
                          href={dublishResult.wpEditorUrl}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="block w-full px-3 py-2 bg-blue-600 text-white text-center rounded text-sm hover:bg-blue-700 transition-colors"
                        >
                          üîß Edit in Elementor (Post ID: {dublishResult.postId})
                        </a>
                        <a
                          href={dublishResult.liveUrl}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="block w-full px-3 py-2 bg-green-600 text-white text-center rounded text-sm hover:bg-green-700 transition-colors"
                        >
                          üåê View Live Page
                        </a>
                      </div>
                    )}
                  </div>
                )}
                
                <div className="text-xs text-gray-600 mt-2">
                  create new page on asn_sitespren_base from defined data (such as pelementor_edits field in some cases, etc.)
                </div>
              </div>

              {/* NEW AREA 4: Snoverride Function Box */}
              <div className="bg-gray-50 border border-gray-300 rounded-lg p-4" style={{ width: '450px' }}>
                <div className="mb-3">
                  <strong className="text-sm font-bold text-gray-700">
                    Update existing elementor page using snoverride function
                  </strong>
                </div>
                
                <hr className="my-3 border-gray-300" />
                
                <div className="mb-3">
                  <button
                    onClick={handleRunSnoverride}
                    disabled={isRunningSnoverride || !gconPiece?.pelementor_edits || !gconPiece?.asn_sitespren_base || !gconPiece?.g_post_id}
                    className={`w-full px-4 py-2 text-white rounded transition-colors ${
                      isRunningSnoverride || !gconPiece?.pelementor_edits || !gconPiece?.asn_sitespren_base || !gconPiece?.g_post_id
                        ? 'bg-gray-400 cursor-not-allowed'
                        : 'bg-black hover:bg-gray-800'
                    }`}
                    style={{
                      fontSize: '14px'
                    }}
                  >
                    {isRunningSnoverride ? (
                      <div className="flex items-center justify-center gap-2">
                        <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                        Updating...
                      </div>
                    ) : (
                      'run snoverride'
                    )}
                  </button>
                </div>

                {/* Connection Type Selector */}
                <div className="mb-3">
                  <label className="block text-xs font-bold text-gray-700 mb-2">
                    Connection Type:
                  </label>
                  <select
                    value={snoverrideConnectionType}
                    onChange={(e) => setSnoverrideConnectionType(e.target.value as 'snefuruplin' | 'rest_api' | 'api_other')}
                    disabled={isRunningSnoverride}
                    className="w-full px-3 py-2 border border-gray-300 rounded text-sm bg-white disabled:bg-gray-100"
                  >
                    <option value="snefuruplin">Snefuruplin WP Plugin</option>
                    <option value="rest_api">REST API</option>
                    <option value="api_other">API (other)</option>
                  </select>
                </div>

                {/* Progress Indicator */}
                {snoverrideProgress && (
                  <div className="mb-3 p-2 bg-blue-50 border border-blue-200 rounded">
                    <div className="text-xs text-blue-800">
                      <strong>Status:</strong> {snoverrideProgress}
                    </div>
                    {isRunningSnoverride && (
                      <div className="mt-2">
                        <div className="w-full bg-blue-200 rounded-full h-2">
                          <div className="bg-blue-600 h-2 rounded-full animate-pulse" style={{ width: '60%' }}></div>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Results Section */}
                {snoverrideResult && (
                  <div className={`mb-3 p-3 border rounded ${
                    snoverrideResult.success 
                      ? 'bg-green-50 border-green-200' 
                      : 'bg-red-50 border-red-200'
                  }`}>
                    <div className={`text-sm font-medium ${
                      snoverrideResult.success ? 'text-green-800' : 'text-red-800'
                    }`}>
                      {snoverrideResult.message}
                    </div>
                    
                    {snoverrideResult.success && snoverrideResult.wpEditorUrl && snoverrideResult.liveUrl && (
                      <div className="mt-3 space-y-2">
                        <a
                          href={snoverrideResult.wpEditorUrl}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="block w-full px-3 py-2 bg-blue-600 text-white text-center rounded text-sm hover:bg-blue-700 transition-colors"
                        >
                          üîß Edit in Elementor (Post ID: {snoverrideResult.postId})
                        </a>
                        <a
                          href={snoverrideResult.liveUrl}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="block w-full px-3 py-2 bg-green-600 text-white text-center rounded text-sm hover:bg-green-700 transition-colors"
                        >
                          üåê View Updated Page
                        </a>
                      </div>
                    )}
                  </div>
                )}
                
                <div className="text-xs text-gray-600 mt-2">
                  {gconPiece?.g_post_id ? (
                    <span>
                      Update existing post ID: <strong>{gconPiece.g_post_id}</strong> on {gconPiece.asn_sitespren_base}
                    </span>
                  ) : (
                    <span className="text-red-600">
                      No g_post_id found - cannot update without target post ID
                    </span>
                  )}
                </div>
              </div>
            </div>
          </div>
        )}
        
        <h1 className="text-2xl font-bold mb-6">Tornado</h1>
        {gconPieceId && (
          <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
            <p className="text-sm text-blue-800">
              <strong>gcon_piece_id:</strong> {gconPieceId}
              {gconPiece?.asn_sitespren_base && (
                <span className="ml-4">
                  <strong>Site:</strong> {gconPiece.asn_sitespren_base}
                </span>
              )}
            </p>
          </div>
        )}
        <WaterTable 
          gconPieceId={gconPieceId} 
          isTopAreaOpen={isTopAreaOpen}
          handleAccordionToggle={handleAccordionToggle}
          gconPiece={gconPiece}
          isRunningF22={isRunningF22}
          f22Report={f22Report}
          handleRunF22={handleRunF22}
          handleCopyPelementorCached={handleCopyPelementorCached}
          handleCopyPelementorEdits={handleCopyPelementorEdits}
          handleCopyF22Report={handleCopyF22Report}
          onGetManualImageData={manualImageDataRef}
        />
      </div>
    </div>
  );
}
```

Result:

```
File created successfully at: /Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/tornado/pclient.tsx
```

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Write**

```tsx
import { Metadata } from 'next';
import TornadoClient from './pclient';

export const metadata: Metadata = {
  title: 'tornado',
};

export default function TornadoPage() {
  return <TornadoClient />;
}
```

Result:

```
The file /Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/tornado/page.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
     1‚Üíimport { Metadata } from 'next';
     2‚Üíimport TornadoClient from './pclient';
     3‚Üí
     4‚Üíexport const metadata: Metadata = {
     5‚Üí  title: 'tornado',
     6‚Üí};
     7‚Üí
     8‚Üíexport default function TornadoPage() {
     9‚Üí  return <TornadoClient />;
    10‚Üí}
```

_**Agent (claude-sonnet-4-20250514)**_

**Agent task list:**
- [‚ö°] üå°Ô∏è Convert Batch 6: Utility & Tool Pages to Method 1
- [X] üå°Ô∏è Convert Batch 5: Business Logic Pages to Method 1
- [X] üå°Ô∏è Convert /choptext to Method 1
- [X] üå°Ô∏è Convert /tornado to Method 1
- [‚ö°] üå°Ô∏è Convert /torya to Method 1
- [ ] üå°Ô∏è Convert /fabric to Method 1


_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Read** `./app/(protected)/torya/page.tsx`

Result:

```
1‚Üí'use client';
     2‚Üí
     3‚Üíimport { useState, useEffect, useRef } from 'react';
     4‚Üíimport { useAuth } from '@/app/context/AuthContext';
     5‚Üíimport { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
     6‚Üíimport { useSearchParams } from 'next/navigation';
     7‚Üíimport Link from 'next/link';
     8‚Üíimport WaterTable from './components/WaterTable';
     9‚Üíimport MarzdiStickyMenu from './components/marzdi_sticky_menu';
    10‚Üí
    11‚Üíexport default function ToryaPage() {
    12‚Üí  const { user } = useAuth();
    13‚Üí  const searchParams = useSearchParams();
    14‚Üí  const supabase = createClientComponentClient();
    15‚Üí  const [loading, setLoading] = useState(true);
    16‚Üí  const [error, setError] = useState<string | null>(null);
    17‚Üí  const [gconPieceId, setGconPieceId] = useState<string | null>(null);
    18‚Üí  const [gconPiece, setGconPiece] = useState<any>(null);
    19‚Üí  const [isTopAreaOpen, setIsTopAreaOpen] = useState<boolean>(true);
    20‚Üí  const [isPopulatingUnits, setIsPopulatingUnits] = useState(false);
    21‚Üí  const [populateMessage, setPopulateMessage] = useState<string | null>(null);
    22‚Üí  const [isRunningF22, setIsRunningF22] = useState(false);
    23‚Üí  const [f22Report, setF22Report] = useState<string>('');
    24‚Üí  
    25‚Üí  // Image Plans Batch state
    26‚Üí  const [imagePlansBatches, setImagePlansBatches] = useState<any[]>([]);
    27‚Üí  const [selectedBatchId, setSelectedBatchId] = useState<string>('');
    28‚Üí  const [isSavingBatch, setIsSavingBatch] = useState(false);
    29‚Üí
    30‚Üí  // Compile text content state
    31‚Üí  const [isCompilingTextContent, setIsCompilingTextContent] = useState(false);
    32‚Üí
    33‚Üí  // Narpi pushes state
    34‚Üí  const [narpiPushes, setNarpiPushes] = useState<any[]>([]);
    35‚Üí  const [selectedNarpiPushes, setSelectedNarpiPushes] = useState<Set<string>>(new Set());
    36‚Üí  const [copiedNarpiId, setCopiedNarpiId] = useState<string | null>(null);
    37‚Üí
    38‚Üí  // Dublish function state
    39‚Üí  const [isRunningDublish, setIsRunningDublish] = useState(false);
    40‚Üí  const [dublishConnectionType, setDublishConnectionType] = useState<'snefuruplin' | 'rest_api' | 'api_other'>('snefuruplin');
    41‚Üí  const [dublishProgress, setDublishProgress] = useState<string>('');
    42‚Üí  const [dublishResult, setDublishResult] = useState<{
    43‚Üí    success: boolean;
    44‚Üí    wpEditorUrl?: string;
    45‚Üí    liveUrl?: string;
    46‚Üí    postId?: number;
    47‚Üí    message?: string;
    48‚Üí  } | null>(null);
    49‚Üí
    50‚Üí  // Snoverride function state
    51‚Üí  const [isRunningSnoverride, setIsRunningSnoverride] = useState(false);
    52‚Üí  const [snoverrideConnectionType, setSnoverrideConnectionType] = useState<'snefuruplin' | 'rest_api' | 'api_other'>('snefuruplin');
    53‚Üí  const [snoverrideProgress, setSnoverrideProgress] = useState<string>('');
    54‚Üí  const [snoverrideResult, setSnoverrideResult] = useState<{
    55‚Üí    success: boolean;
    56‚Üí    wpEditorUrl?: string;
    57‚Üí    liveUrl?: string;
    58‚Üí    postId?: number;
    59‚Üí    message?: string;
    60‚Üí  } | null>(null);
    61‚Üí
    62‚Üí  // Ref to access manual image data from WaterTable
    63‚Üí  const manualImageDataRef = useRef<{ 
    64‚Üí    urls: Map<string, string>; 
    65‚Üí    ids: Map<string, string>; 
    66‚Üí    checkboxes: Map<string, boolean> 
    67‚Üí  } | null>(null);
    68‚Üí
    69‚Üí  useEffect(() => {
    70‚Üí    // Get gcon_piece_id from URL parameters
    71‚Üí    const gconPieceIdParam = searchParams?.get('gcon_piece_id');
    72‚Üí    if (gconPieceIdParam) {
    73‚Üí      setGconPieceId(gconPieceIdParam);
    74‚Üí      console.log('Torya: Loaded with gcon_piece_id:', gconPieceIdParam);
    75‚Üí    }
    76‚Üí    
    77‚Üí    // Handle zarno1 state from URL and localStorage
    78‚Üí    const urlParams = new URLSearchParams(window.location.search);
    79‚Üí    const zarno1Param = urlParams.get('zarno1');
    80‚Üí    
    81‚Üí    // Try to get saved state from localStorage
    82‚Üí    const savedState = localStorage.getItem('torya_zarno1_state');
    83‚Üí    
    84‚Üí    if (zarno1Param === 'closed') {
    85‚Üí      setIsTopAreaOpen(false);
    86‚Üí    } else if (zarno1Param === 'open') {
    87‚Üí      setIsTopAreaOpen(true);
    88‚Üí    } else if (savedState) {
    89‚Üí      // Use saved state if no URL param
    90‚Üí      setIsTopAreaOpen(savedState === 'open');
    91‚Üí    }
    92‚Üí    
    93‚Üí    setLoading(false);
    94‚Üí  }, [searchParams]);
    95‚Üí
    96‚Üí  // Fetch narpi pushes when batch changes
    97‚Üí  useEffect(() => {
    98‚Üí    const fetchNarpiPushes = async () => {
    99‚Üí      if (!selectedBatchId && !gconPiece?.asn_image_plan_batch_id) {
   100‚Üí        setNarpiPushes([]);
   101‚Üí        return;
   102‚Üí      }
   103‚Üí
   104‚Üí      const batchId = selectedBatchId || gconPiece?.asn_image_plan_batch_id;
   105‚Üí      
   106‚Üí      try {
   107‚Üí        const { data, error } = await supabase
   108‚Üí          .from('narpi_pushes')
   109‚Üí          .select('id, push_name, push_status1, created_at, kareench1')
   110‚Üí          .eq('fk_batch_id', batchId)
   111‚Üí          .order('created_at', { ascending: false });
   112‚Üí
   113‚Üí        if (error) {
   114‚Üí          console.error('Error fetching narpi_pushes:', error);
   115‚Üí        } else {
   116‚Üí          setNarpiPushes(data || []);
   117‚Üí        }
   118‚Üí      } catch (error) {
   119‚Üí        console.error('Error fetching narpi_pushes:', error);
   120‚Üí      }
   121‚Üí    };
   122‚Üí
   123‚Üí    fetchNarpiPushes();
   124‚Üí  }, [selectedBatchId, gconPiece?.asn_image_plan_batch_id]);
   125‚Üí
   126‚Üí  // Copy kareench1 value function
   127‚Üí  const copyNarpiKareenchValue = async (pushId: string, kareenchValue: any) => {
   128‚Üí    try {
   129‚Üí      const valueToString = typeof kareenchValue === 'string' 
   130‚Üí        ? kareenchValue 
   131‚Üí        : JSON.stringify(kareenchValue, null, 2);
   132‚Üí      
   133‚Üí      await navigator.clipboard.writeText(valueToString);
   134‚Üí      setCopiedNarpiId(pushId);
   135‚Üí      
   136‚Üí      // Clear the copied indicator after 2 seconds
   137‚Üí      setTimeout(() => setCopiedNarpiId(null), 2000);
   138‚Üí    } catch (err) {
   139‚Üí      console.error('Failed to copy kareench1 value:', err);
   140‚Üí    }
   141‚Üí  };
   142‚Üí
   143‚Üí  // Fetch gcon_piece data when gconPieceId is available
   144‚Üí  useEffect(() => {
   145‚Üí    const fetchGconPiece = async () => {
   146‚Üí      if (!user?.id || !gconPieceId) {
   147‚Üí        return;
   148‚Üí      }
   149‚Üí
   150‚Üí      try {
   151‚Üí        // Get user's internal ID first
   152‚Üí        const { data: userData } = await supabase
   153‚Üí          .from('users')
   154‚Üí          .select('id')
   155‚Üí          .eq('auth_id', user.id)
   156‚Üí          .single();
   157‚Üí
   158‚Üí        if (!userData) {
   159‚Üí          setError('User not found');
   160‚Üí          return;
   161‚Üí        }
   162‚Üí
   163‚Üí        // Fetch the gcon_piece
   164‚Üí        const { data: gconData, error: gconError } = await supabase
   165‚Üí          .from('gcon_pieces')
   166‚Üí          .select('id, asn_sitespren_base, mud_title, h1title, pelementor_cached, pelementor_edits, g_post_id, asn_image_plan_batch_id')
   167‚Üí          .eq('id', gconPieceId)
   168‚Üí          .eq('fk_users_id', userData.id)
   169‚Üí          .single();
   170‚Üí
   171‚Üí        if (gconError) {
   172‚Üí          setError('Content piece not found');
   173‚Üí          return;
   174‚Üí        }
   175‚Üí
   176‚Üí        setGconPiece(gconData);
   177‚Üí      } catch (err) {
   178‚Üí        console.error('Error fetching gcon_piece:', err);
   179‚Üí        setError('Failed to load content');
   180‚Üí      }
   181‚Üí    };
   182‚Üí
   183‚Üí    fetchGconPiece();
   184‚Üí  }, [user?.id, gconPieceId, supabase]);
   185‚Üí
   186‚Üí  // Fetch images_plans_batches for current user
   187‚Üí  useEffect(() => {
   188‚Üí    const fetchImagePlansBatches = async () => {
   189‚Üí      if (!user?.id) return;
   190‚Üí
   191‚Üí      try {
   192‚Üí        // Get user's internal ID first
   193‚Üí        const { data: userData } = await supabase
   194‚Üí          .from('users')
   195‚Üí          .select('id')
   196‚Üí          .eq('auth_id', user.id)
   197‚Üí          .single();
   198‚Üí
   199‚Üí        if (!userData) return;
   200‚Üí
   201‚Üí        // Fetch images_plans_batches for this user
   202‚Üí        const { data: batchesData, error } = await supabase
   203‚Üí          .from('images_plans_batches')
   204‚Üí          .select('*')
   205‚Üí          .eq('rel_users_id', userData.id)
   206‚Üí          .order('created_at', { ascending: false });
   207‚Üí
   208‚Üí        if (error) {
   209‚Üí          console.error('Error fetching images_plans_batches:', error);
   210‚Üí          return;
   211‚Üí        }
   212‚Üí
   213‚Üí        setImagePlansBatches(batchesData || []);
   214‚Üí
   215‚Üí        // Set current selected batch if gconPiece has one
   216‚Üí        if (gconPiece?.asn_image_plan_batch_id) {
   217‚Üí          setSelectedBatchId(gconPiece.asn_image_plan_batch_id);
   218‚Üí        }
   219‚Üí      } catch (err) {
   220‚Üí        console.error('Error in fetchImagePlansBatches:', err);
   221‚Üí      }
   222‚Üí    };
   223‚Üí
   224‚Üí    fetchImagePlansBatches();
   225‚Üí  }, [user?.id, supabase, gconPiece?.asn_image_plan_batch_id]);
   226‚Üí
   227‚Üí  // Set browser title based on gcon_piece data
   228‚Üí  useEffect(() => {
   229‚Üí    if (gconPiece?.asn_sitespren_base) {
   230‚Üí      document.title = 'torya_' + gconPiece.asn_sitespren_base;
   231‚Üí    } else if (gconPieceId) {
   232‚Üí      document.title = 'torya';
   233‚Üí    } else {
   234‚Üí      document.title = 'torya';
   235‚Üí    }
   236‚Üí  }, [gconPiece?.asn_sitespren_base, gconPieceId]);
   237‚Üí
   238‚Üí  // Handle accordion state change
   239‚Üí  const handleAccordionToggle = (open: boolean) => {
   240‚Üí    setIsTopAreaOpen(open);
   241‚Üí    
   242‚Üí    // Save to localStorage
   243‚Üí    localStorage.setItem('torya_zarno1_state', open ? 'open' : 'closed');
   244‚Üí    
   245‚Üí    // Update URL parameter
   246‚Üí    const url = new URL(window.location.href);
   247‚Üí    url.searchParams.set('zarno1', open ? 'open' : 'closed');
   248‚Üí    window.history.replaceState({}, '', url.toString());
   249‚Üí  };
   250‚Üí
   251‚Üí  // Handle populate nemtor_units
   252‚Üí  const handlePopulateNemtorUnits = async () => {
   253‚Üí    if (!gconPieceId) {
   254‚Üí      setPopulateMessage('Error: No gcon_piece_id available');
   255‚Üí      return;
   256‚Üí    }
   257‚Üí
   258‚Üí    setIsPopulatingUnits(true);
   259‚Üí    setPopulateMessage(null);
   260‚Üí
   261‚Üí    try {
   262‚Üí      const response = await fetch('/api/populate-nemtor-units', {
   263‚Üí        method: 'POST',
   264‚Üí        headers: {
   265‚Üí          'Content-Type': 'application/json',
   266‚Üí        },
   267‚Üí        body: JSON.stringify({
   268‚Üí          gcon_piece_id: gconPieceId
   269‚Üí        }),
   270‚Üí      });
   271‚Üí
   272‚Üí      const result = await response.json();
   273‚Üí
   274‚Üí      if (response.ok) {
   275‚Üí        setPopulateMessage(`‚úÖ ${result.message}`);
   276‚Üí      } else {
   277‚Üí        setPopulateMessage(`‚ùå Error: ${result.error}`);
   278‚Üí      }
   279‚Üí    } catch (error) {
   280‚Üí      console.error('Error populating nemtor_units:', error);
   281‚Üí      setPopulateMessage('‚ùå Error: Failed to populate nemtor_units');
   282‚Üí    } finally {
   283‚Üí      setIsPopulatingUnits(false);
   284‚Üí      // Clear message after 5 seconds
   285‚Üí      setTimeout(() => setPopulateMessage(null), 5000);
   286‚Üí    }
   287‚Üí  };
   288‚Üí
   289‚Üí  // Handle f22 function
   290‚Üí  const handleRunF22 = async () => {
   291‚Üí    if (!gconPieceId) {
   292‚Üí      setF22Report('Error: No gcon_piece_id available');
   293‚Üí      return;
   294‚Üí    }
   295‚Üí
   296‚Üí    setIsRunningF22(true);
   297‚Üí    setF22Report('Starting F22 processing...');
   298‚Üí
   299‚Üí    try {
   300‚Üí      const response = await fetch('/api/f22-nwpi-to-gcon-pusher', {
   301‚Üí        method: 'POST',
   302‚Üí        headers: {
   303‚Üí          'Content-Type': 'application/json',
   304‚Üí        },
   305‚Üí        body: JSON.stringify({
   306‚Üí          gcon_piece_id: gconPieceId
   307‚Üí        }),
   308‚Üí      });
   309‚Üí
   310‚Üí      const result = await response.json();
   311‚Üí
   312‚Üí      if (response.ok) {
   313‚Üí        setF22Report(result.message || 'F22 function completed successfully');
   314‚Üí        
   315‚Üí        // Refresh the gcon_piece data to get updated values
   316‚Üí        if (user?.id) {
   317‚Üí          const { data: userData } = await supabase
   318‚Üí            .from('users')
   319‚Üí            .select('id')
   320‚Üí            .eq('auth_id', user.id)
   321‚Üí            .single();
   322‚Üí
   323‚Üí          if (userData) {
   324‚Üí            const { data: refreshedData } = await supabase
   325‚Üí              .from('gcon_pieces')
   326‚Üí              .select('id, asn_sitespren_base, mud_title, h1title, pelementor_cached, pelementor_edits, asn_image_plan_batch_id')
   327‚Üí              .eq('id', gconPieceId)
   328‚Üí              .eq('fk_users_id', userData.id)
   329‚Üí              .single();
   330‚Üí
   331‚Üí            if (refreshedData) {
   332‚Üí              setGconPiece(refreshedData);
   333‚Üí            }
   334‚Üí          }
   335‚Üí        }
   336‚Üí      } else {
   337‚Üí        setF22Report(`Error: ${result.error || 'F22 function failed'}`);
   338‚Üí      }
   339‚Üí    } catch (error) {
   340‚Üí      console.error('Error running F22:', error);
   341‚Üí      setF22Report('Error: Failed to run F22 function');
   342‚Üí    } finally {
   343‚Üí      setIsRunningF22(false);
   344‚Üí    }
   345‚Üí  };
   346‚Üí
   347‚Üí  // Copy functions
   348‚Üí  const handleCopyPelementorCached = () => {
   349‚Üí    if (gconPiece?.pelementor_cached) {
   350‚Üí      const content = typeof gconPiece.pelementor_cached === 'string' 
   351‚Üí        ? gconPiece.pelementor_cached 
   352‚Üí        : JSON.stringify(gconPiece.pelementor_cached, null, 2);
   353‚Üí      navigator.clipboard.writeText(content);
   354‚Üí    }
   355‚Üí  };
   356‚Üí
   357‚Üí  const handleCopyPelementorEdits = () => {
   358‚Üí    if (gconPiece?.pelementor_edits) {
   359‚Üí      const content = typeof gconPiece.pelementor_edits === 'string' 
   360‚Üí        ? gconPiece.pelementor_edits 
   361‚Üí        : JSON.stringify(gconPiece.pelementor_edits, null, 2);
   362‚Üí      navigator.clipboard.writeText(content);
   363‚Üí    }
   364‚Üí  };
   365‚Üí
   366‚Üí  const handleCopyF22Report = () => {
   367‚Üí    if (f22Report) {
   368‚Üí      navigator.clipboard.writeText(f22Report);
   369‚Üí    }
   370‚Üí  };
   371‚Üí
   372‚Üí  // Handle saving image plan batch
   373‚Üí  const handleSaveImagePlanBatch = async () => {
   374‚Üí    if (!gconPieceId || !selectedBatchId) {
   375‚Üí      alert('Please select an image plan batch first');
   376‚Üí      return;
   377‚Üí    }
   378‚Üí
   379‚Üí    setIsSavingBatch(true);
   380‚Üí
   381‚Üí    try {
   382‚Üí      const { error } = await supabase
   383‚Üí        .from('gcon_pieces')
   384‚Üí        .update({ asn_image_plan_batch_id: selectedBatchId })
   385‚Üí        .eq('id', gconPieceId);
   386‚Üí
   387‚Üí      if (error) {
   388‚Üí        throw error;
   389‚Üí      }
   390‚Üí
   391‚Üí      // Update local state
   392‚Üí      setGconPiece((prev: any) => prev ? { ...prev, asn_image_plan_batch_id: selectedBatchId } : prev);
   393‚Üí      
   394‚Üí      alert('Image plan batch saved successfully!');
   395‚Üí    } catch (error) {
   396‚Üí      console.error('Error saving image plan batch:', error);
   397‚Üí      alert('Failed to save image plan batch');
   398‚Üí    } finally {
   399‚Üí      setIsSavingBatch(false);
   400‚Üí    }
   401‚Üí  };
   402‚Üí
   403‚Üí  // Helper function to recursively find and update Elementor element by ID
   404‚Üí  const updateElementorImageById = (elementorData: any, targetElId: string, imageUrl: string, imageId: string): boolean => {
   405‚Üí    let updated = false;
   406‚Üí    
   407‚Üí    // Recursive function to traverse the Elementor structure
   408‚Üí    const traverseElements = (elements: any[]): boolean => {
   409‚Üí      if (!Array.isArray(elements)) return false;
   410‚Üí      
   411‚Üí      for (const element of elements) {
   412‚Üí        // Check if this is the target element
   413‚Üí        if (element.id === targetElId) {
   414‚Üí          console.log(`üéØ Found target element ${targetElId}, checking for image settings...`);
   415‚Üí          // Update image data in this element's settings
   416‚Üí          if (element.settings) {
   417‚Üí            // Handle different image property patterns
   418‚Üí            if (element.settings.image) {
   419‚Üí              if (typeof element.settings.image === 'object') {
   420‚Üí                element.settings.image.url = imageUrl;
   421‚Üí                element.settings.image.id = parseInt(imageId);
   422‚Üí              } else {
   423‚Üí                element.settings.image = {
   424‚Üí                  url: imageUrl,
   425‚Üí                  id: parseInt(imageId)
   426‚Üí                };
   427‚Üí              }
   428‚Üí              updated = true;
   429‚Üí            }
   430‚Üí            
   431‚Üí            // Handle background image
   432‚Üí            if (element.settings.background_image) {
   433‚Üí              if (typeof element.settings.background_image === 'object') {
   434‚Üí                element.settings.background_image.url = imageUrl;
   435‚Üí                element.settings.background_image.id = parseInt(imageId);
   436‚Üí              } else {
   437‚Üí                element.settings.background_image = {
   438‚Üí                  url: imageUrl,
   439‚Üí                  id: parseInt(imageId)
   440‚Üí                };
   441‚Üí              }
   442‚Üí              updated = true;
   443‚Üí            }
   444‚Üí            
   445‚Üí            // Handle other common image properties
   446‚Üí            ['background_background', '_background_background'].forEach(prop => {
   447‚Üí              if (element.settings[prop] === 'classic' && element.settings[prop + '_image']) {
   448‚Üí                if (typeof element.settings[prop + '_image'] === 'object') {
   449‚Üí                  element.settings[prop + '_image'].url = imageUrl;
   450‚Üí                  element.settings[prop + '_image'].id = parseInt(imageId);
   451‚Üí                } else {
   452‚Üí                  element.settings[prop + '_image'] = {
   453‚Üí                    url: imageUrl,
   454‚Üí                    id: parseInt(imageId)
   455‚Üí                  };
   456‚Üí                }
   457‚Üí                updated = true;
   458‚Üí              }
   459‚Üí            });
   460‚Üí          }
   461‚Üí          
   462‚Üí          return true; // Found and processed the target element
   463‚Üí        }
   464‚Üí        
   465‚Üí        // Recursively check child elements
   466‚Üí        if (element.elements && Array.isArray(element.elements)) {
   467‚Üí          if (traverseElements(element.elements)) {
   468‚Üí            updated = true;
   469‚Üí          }
   470‚Üí        }
   471‚Üí      }
   472‚Üí      
   473‚Üí      return updated;
   474‚Üí    };
   475‚Üí    
   476‚Üí    // Start traversal from root
   477‚Üí    if (Array.isArray(elementorData)) {
   478‚Üí      return traverseElements(elementorData);
   479‚Üí    }
   480‚Üí    
   481‚Üí    return false;
   482‚Üí  };
   483‚Üí
   484‚Üí  // Handle compile new_desired_text_content into pelementor_edits
   485‚Üí  const handleCompileTextContent = async () => {
   486‚Üí    if (!gconPieceId || !gconPiece) {
   487‚Üí      alert('No gcon_piece found to process');
   488‚Üí      return;
   489‚Üí    }
   490‚Üí
   491‚Üí    if (!gconPiece.pelementor_cached) {
   492‚Üí      alert('No pelementor_cached data found to use as starting point');
   493‚Üí      return;
   494‚Üí    }
   495‚Üí
   496‚Üí    setIsCompilingTextContent(true);
   497‚Üí
   498‚Üí    try {
   499‚Üí      // Step 1: Start with pelementor_cached as our base for pelementor_edits
   500‚Üí      // Ensure we're working with a string, not an object
   501‚Üí      let pelementorEditsContent = typeof gconPiece.pelementor_cached === 'string' 
   502‚Üí        ? gconPiece.pelementor_cached 
   503‚Üí        : JSON.stringify(gconPiece.pelementor_cached);
   504‚Üí
   505‚Üí      // Step 2: Fetch all nemtor_units for this gcon_piece
   506‚Üí      const { data: nemtorUnits, error: nemtorError } = await supabase
   507‚Üí        .from('nemtor_units')
   508‚Üí        .select('unit_id, full_text_cached, full_text_edits, has_img_slot, el_id')
   509‚Üí        .eq('fk_gcon_piece_id', gconPieceId);
   510‚Üí
   511‚Üí      if (nemtorError) {
   512‚Üí        console.error('Error fetching nemtor_units:', nemtorError);
   513‚Üí        throw nemtorError;
   514‚Üí      }
   515‚Üí
   516‚Üí      if (!nemtorUnits || nemtorUnits.length === 0) {
   517‚Üí        alert('No nemtor_units found for this gcon_piece');
   518‚Üí        return;
   519‚Üí      }
   520‚Üí
   521‚Üí      // Step 3: Process units that have full_text_edits values
   522‚Üí      let replacementsCount = 0;
   523‚Üí      const replacements: { original: string; replacement: string; unitId: string }[] = [];
   524‚Üí
   525‚Üí      nemtorUnits.forEach(unit => {
   526‚Üí        // Only process if full_text_edits has a real value (not null, empty, or whitespace)
   527‚Üí        if (unit.full_text_edits && unit.full_text_edits.trim() !== '') {
   528‚Üí          // Only process if we also have original full_text_cached to replace
   529‚Üí          if (unit.full_text_cached && unit.full_text_cached.trim() !== '') {
   530‚Üí            // Replace full_text_cached with full_text_edits in pelementorEditsContent
   531‚Üí            const originalText = unit.full_text_cached;
   532‚Üí            const newText = unit.full_text_edits;
   533‚Üí            
   534‚Üí            // Check if the original text exists in pelementorEditsContent
   535‚Üí            if (pelementorEditsContent.includes(originalText)) {
   536‚Üí              pelementorEditsContent = pelementorEditsContent.replace(originalText, newText);
   537‚Üí              replacementsCount++;
   538‚Üí              replacements.push({
   539‚Üí                original: originalText.substring(0, 100) + (originalText.length > 100 ? '...' : ''),
   540‚Üí                replacement: newText.substring(0, 100) + (newText.length > 100 ? '...' : ''),
   541‚Üí                unitId: unit.unit_id
   542‚Üí              });
   543‚Üí            }
   544‚Üí          }
   545‚Üí        }
   546‚Üí      });
   547‚Üí
   548‚Üí      // Step 4: Process manual image inputs (includes active checkboxes for man_img_url and man_img_id)
   549‚Üí      let imageReplacementsCount = 0;
   550‚Üí      if (manualImageDataRef.current) {
   551‚Üí        const { urls, ids, checkboxes } = manualImageDataRef.current;
   552‚Üí        
   553‚Üí        try {
   554‚Üí          // Parse the Elementor JSON to work with structured data
   555‚Üí          const elementorData = JSON.parse(pelementorEditsContent);
   556‚Üí          
   557‚Üí          nemtorUnits.forEach(unit => {
   558‚Üí            // Only process units that have has_img_slot = true AND checkbox is checked
   559‚Üí            if (unit.has_img_slot === true && checkboxes.get(unit.unit_id)) {
   560‚Üí              const manualUrl = urls.get(unit.unit_id);
   561‚Üí              const manualId = ids.get(unit.unit_id);
   562‚Üí              
   563‚Üí              // Only proceed if we have both URL and ID and el_id
   564‚Üí              if (manualUrl && manualUrl.trim() !== '' && manualId && manualId.trim() !== '' && unit.el_id) {
   565‚Üí                console.log(`üñºÔ∏è Processing image for unit ${unit.unit_id}, el_id: ${unit.el_id}, URL: ${manualUrl}, ID: ${manualId}`);
   566‚Üí                
   567‚Üí                // Find and update the specific element by el_id
   568‚Üí                const updated = updateElementorImageById(elementorData, unit.el_id, manualUrl, manualId);
   569‚Üí                
   570‚Üí                if (updated) {
   571‚Üí                  console.log(`‚úÖ Successfully updated image for element ${unit.el_id}`);
   572‚Üí                  imageReplacementsCount++;
   573‚Üí                  replacements.push({
   574‚Üí                    original: `Image in element ${unit.el_id}`,
   575‚Üí                    replacement: `URL: ${manualUrl.substring(0, 50)}${manualUrl.length > 50 ? '...' : ''}, ID: ${manualId}`,
   576‚Üí                    unitId: unit.unit_id
   577‚Üí                  });
   578‚Üí                } else {
   579‚Üí                  console.log(`‚ùå Could not find/update element with ID: ${unit.el_id}`);
   580‚Üí                }
   581‚Üí              } else {
   582‚Üí                console.log(`‚ö†Ô∏è Skipping unit ${unit.unit_id}: missing data - URL: ${!!manualUrl}, ID: ${!!manualId}, el_id: ${!!unit.el_id}`);
   583‚Üí              }
   584‚Üí            }
   585‚Üí          });
   586‚Üí          
   587‚Üí          // Convert back to string
   588‚Üí          pelementorEditsContent = JSON.stringify(elementorData);
   589‚Üí          
   590‚Üí        } catch (jsonError) {
   591‚Üí          console.error('Error parsing Elementor JSON:', jsonError);
   592‚Üí          // Fall back to string-based approach if JSON parsing fails
   593‚Üí          console.log('Falling back to string-based image replacement...');
   594‚Üí        }
   595‚Üí      }
   596‚Üí
   597‚Üí      // Step 5: Update pelementor_edits in database
   598‚Üí      // Convert back to object if original was an object, or keep as string
   599‚Üí      const pelementorEditsForDb = typeof gconPiece.pelementor_cached === 'object' 
   600‚Üí        ? JSON.parse(pelementorEditsContent)
   601‚Üí        : pelementorEditsContent;
   602‚Üí
   603‚Üí      const { error: updateError } = await supabase
   604‚Üí        .from('gcon_pieces')
   605‚Üí        .update({ pelementor_edits: pelementorEditsForDb })
   606‚Üí        .eq('id', gconPieceId);
   607‚Üí
   608‚Üí      if (updateError) {
   609‚Üí        console.error('Error updating pelementor_edits:', updateError);
   610‚Üí        throw updateError;
   611‚Üí      }
   612‚Üí
   613‚Üí      // Step 6: Update local state
   614‚Üí      setGconPiece((prev: any) => prev ? { ...prev, pelementor_edits: pelementorEditsForDb } : prev);
   615‚Üí
   616‚Üí      // Step 7: Show success message with details
   617‚Üí      const totalReplacements = replacementsCount + imageReplacementsCount;
   618‚Üí      const successMessage = `Successfully compiled content!\n\nText replacements: ${replacementsCount}\nImage replacements: ${imageReplacementsCount}\nTotal replacements: ${totalReplacements}\n\n` +
   619‚Üí        replacements.map(r => `‚Ä¢ Unit ${r.unitId.substring(0, 8)}...\n  FROM: ${r.original}\n  TO: ${r.replacement}`).join('\n\n');
   620‚Üí      
   621‚Üí      alert(successMessage);
   622‚Üí
   623‚Üí    } catch (error) {
   624‚Üí      console.error('Error compiling text content:', error);
   625‚Üí      alert('Failed to compile text content. Please try again.');
   626‚Üí    } finally {
   627‚Üí      setIsCompilingTextContent(false);
   628‚Üí    }
   629‚Üí  };
   630‚Üí
   631‚Üí  // Handle run dublish function
   632‚Üí  const handleRunDublish = async () => {
   633‚Üí    if (!gconPieceId || !gconPiece) {
   634‚Üí      alert('No gcon_piece found to process');
   635‚Üí      return;
   636‚Üí    }
   637‚Üí
   638‚Üí    if (!gconPiece.pelementor_edits) {
   639‚Üí      alert('No pelementor_edits data found. Please compile text content first.');
   640‚Üí      return;
   641‚Üí    }
   642‚Üí
   643‚Üí    if (!gconPiece.asn_sitespren_base) {
   644‚Üí      alert('No asn_sitespren_base found. Cannot determine target WordPress site.');
   645‚Üí      return;
   646‚Üí    }
   647‚Üí
   648‚Üí    setIsRunningDublish(true);
   649‚Üí    setDublishProgress('Initializing...');
   650‚Üí    setDublishResult(null);
   651‚Üí
   652‚Üí    try {
   653‚Üí      // Step 1: Prepare Elementor page data
   654‚Üí      setDublishProgress('Preparing Elementor page data...');
   655‚Üí      
   656‚Üí      const pageTitle = gconPiece.h1title || gconPiece.mud_title || 'New Elementor Page';
   657‚Üí      const pageSlug = gconPiece.pageslug || gconPiece.post_name || 'new-elementor-page';
   658‚Üí      const elementorData = gconPiece.pelementor_edits;
   659‚Üí
   660‚Üí      // Step 2: Create WordPress post
   661‚Üí      setDublishProgress('Creating WordPress post...');
   662‚Üí      
   663‚Üí      let apiResponse;
   664‚Üí      
   665‚Üí      switch (dublishConnectionType) {
   666‚Üí        case 'snefuruplin':
   667‚Üí          // Use Snefuruplin WP Plugin
   668‚Üí          setDublishProgress('Connecting via Snefuruplin WP Plugin...');
   669‚Üí          apiResponse = await createElementorPageViaSnefuruplin({
   670‚Üí            siteUrl: gconPiece.asn_sitespren_base,
   671‚Üí            title: pageTitle,
   672‚Üí            slug: pageSlug,
   673‚Üí            elementorData: elementorData,
   674‚Üí            gconPieceId: gconPieceId
   675‚Üí          });
   676‚Üí          break;
   677‚Üí          
   678‚Üí        case 'rest_api':
   679‚Üí          // Use WordPress REST API
   680‚Üí          setDublishProgress('Connecting via WordPress REST API...');
   681‚Üí          apiResponse = await createElementorPageViaRestAPI({
   682‚Üí            siteUrl: gconPiece.asn_sitespren_base,
   683‚Üí            title: pageTitle,
   684‚Üí            slug: pageSlug,
   685‚Üí            elementorData: elementorData,
   686‚Üí            gconPieceId: gconPieceId
   687‚Üí          });
   688‚Üí          break;
   689‚Üí          
   690‚Üí        case 'api_other':
   691‚Üí          // Use other API method
   692‚Üí          setDublishProgress('Connecting via alternative API...');
   693‚Üí          apiResponse = await createElementorPageViaOtherAPI({
   694‚Üí            siteUrl: gconPiece.asn_sitespren_base,
   695‚Üí            title: pageTitle,
   696‚Üí            slug: pageSlug,
   697‚Üí            elementorData: elementorData,
   698‚Üí            gconPieceId: gconPieceId
   699‚Üí          });
   700‚Üí          break;
   701‚Üí          
   702‚Üí        default:
   703‚Üí          throw new Error('Invalid connection type selected');
   704‚Üí      }
   705‚Üí
   706‚Üí      // Step 3: Process response
   707‚Üí      setDublishProgress('Processing response...');
   708‚Üí      
   709‚Üí      if (apiResponse.success) {
   710‚Üí        const wpEditorUrl = `https://${gconPiece.asn_sitespren_base}/wp-admin/post.php?post=${apiResponse.postId}&action=elementor`;
   711‚Üí        const liveUrl = `https://${gconPiece.asn_sitespren_base}/${pageSlug}`;
   712‚Üí        
   713‚Üí        setDublishResult({
   714‚Üí          success: true,
   715‚Üí          wpEditorUrl,
   716‚Üí          liveUrl,
   717‚Üí          postId: apiResponse.postId,
   718‚Üí          message: `Successfully created Elementor page "${pageTitle}"`
   719‚Üí        });
   720‚Üí        
   721‚Üí        setDublishProgress('‚úÖ Page created successfully!');
   722‚Üí      } else {
   723‚Üí        throw new Error(apiResponse.message || 'Failed to create page');
   724‚Üí      }
   725‚Üí
   726‚Üí    } catch (error) {
   727‚Üí      console.error('Error running dublish function:', error);
   728‚Üí      setDublishResult({
   729‚Üí        success: false,
   730‚Üí        message: error instanceof Error ? error.message : 'Unknown error occurred'
   731‚Üí      });
   732‚Üí      setDublishProgress('‚ùå Failed to create page');
   733‚Üí    } finally {
   734‚Üí      setIsRunningDublish(false);
   735‚Üí    }
   736‚Üí  };
   737‚Üí
   738‚Üí  // Snefuruplin WP Plugin implementation
   739‚Üí  const createElementorPageViaSnefuruplin = async (params: {
   740‚Üí    siteUrl: string;
   741‚Üí    title: string;
   742‚Üí    slug: string;
   743‚Üí    elementorData: string;
   744‚Üí    gconPieceId: string;
   745‚Üí  }) => {
   746‚Üí    // This would connect to your custom WordPress plugin
   747‚Üí    const response = await fetch('/api/dublish-create-elementor-page', {
   748‚Üí      method: 'POST',
   749‚Üí      headers: {
   750‚Üí        'Content-Type': 'application/json',
   751‚Üí      },
   752‚Üí      body: JSON.stringify({
   753‚Üí        site_url: params.siteUrl,
   754‚Üí        post_title: params.title,
   755‚Üí        post_name: params.slug,
   756‚Üí        post_status: 'publish',
   757‚Üí        post_type: 'page',
   758‚Üí        elementor_data: params.elementorData,
   759‚Üí        gcon_piece_id: params.gconPieceId,
   760‚Üí        // Elementor-specific meta fields
   761‚Üí        meta_input: {
   762‚Üí          '_elementor_edit_mode': 'builder',
   763‚Üí          '_elementor_template_type': 'wp-page',
   764‚Üí          '_elementor_version': '3.17.0',
   765‚Üí          '_elementor_pro_version': '3.17.0',
   766‚Üí          '_elementor_data': params.elementorData,
   767‚Üí          '_elementor_page_settings': JSON.stringify({
   768‚Üí            "custom_css": "",
   769‚Üí            "page_title": "hide",
   770‚Üí            "page_description": "hide"
   771‚Üí          }),
   772‚Üí          '_wp_page_template': 'default'
   773‚Üí        }
   774‚Üí      })
   775‚Üí    });
   776‚Üí
   777‚Üí    return await response.json();
   778‚Üí  };
   779‚Üí
   780‚Üí  // WordPress REST API implementation
   781‚Üí  const createElementorPageViaRestAPI = async (params: {
   782‚Üí    siteUrl: string;
   783‚Üí    title: string;
   784‚Üí    slug: string;
   785‚Üí    elementorData: string;
   786‚Üí    gconPieceId: string;
   787‚Üí  }) => {
   788‚Üí    // Step 1: Create the post via REST API
   789‚Üí    const createPostResponse = await fetch(`https://${params.siteUrl}/wp-json/wp/v2/pages`, {
   790‚Üí      method: 'POST',
   791‚Üí      headers: {
   792‚Üí        'Content-Type': 'application/json',
   793‚Üí        'Authorization': 'Bearer YOUR_WP_TOKEN', // You'll need to implement auth
   794‚Üí      },
   795‚Üí      body: JSON.stringify({
   796‚Üí        title: params.title,
   797‚Üí        slug: params.slug,
   798‚Üí        status: 'publish',
   799‚Üí        template: 'elementor_header_footer'
   800‚Üí      })
   801‚Üí    });
   802‚Üí
   803‚Üí    const post = await createPostResponse.json();
   804‚Üí    
   805‚Üí    if (!createPostResponse.ok) {
   806‚Üí      throw new Error(post.message || 'Failed to create post');
   807‚Üí    }
   808‚Üí
   809‚Üí    // Step 2: Add Elementor meta data
   810‚Üí    const metaUpdates = [
   811‚Üí      { key: '_elementor_edit_mode', value: 'builder' },
   812‚Üí      { key: '_elementor_template_type', value: 'wp-page' },
   813‚Üí      { key: '_elementor_version', value: '3.17.0' },
   814‚Üí      { key: '_elementor_data', value: params.elementorData },
   815‚Üí      { key: '_elementor_page_settings', value: JSON.stringify({
   816‚Üí        "custom_css": "",
   817‚Üí        "page_title": "hide", 
   818‚Üí        "page_description": "hide"
   819‚Üí      }) }
   820‚Üí    ];
   821‚Üí
   822‚Üí    for (const meta of metaUpdates) {
   823‚Üí      await fetch(`https://${params.siteUrl}/wp-json/wp/v2/pages/${post.id}/meta`, {
   824‚Üí        method: 'POST',
   825‚Üí        headers: {
   826‚Üí          'Content-Type': 'application/json',
   827‚Üí          'Authorization': 'Bearer YOUR_WP_TOKEN',
   828‚Üí        },
   829‚Üí        body: JSON.stringify(meta)
   830‚Üí      });
   831‚Üí    }
   832‚Üí
   833‚Üí    return {
   834‚Üí      success: true,
   835‚Üí      postId: post.id,
   836‚Üí      message: 'Page created successfully via REST API'
   837‚Üí    };
   838‚Üí  };
   839‚Üí
   840‚Üí  // Alternative API implementation
   841‚Üí  const createElementorPageViaOtherAPI = async (params: {
   842‚Üí    siteUrl: string;
   843‚Üí    title: string;
   844‚Üí    slug: string;
   845‚Üí    elementorData: string;
   846‚Üí    gconPieceId: string;
   847‚Üí  }) => {
   848‚Üí    // This could be a custom API endpoint you create
   849‚Üí    const response = await fetch('/api/wordpress/create-elementor-page', {
   850‚Üí      method: 'POST',
   851‚Üí      headers: {
   852‚Üí        'Content-Type': 'application/json',
   853‚Üí      },
   854‚Üí      body: JSON.stringify({
   855‚Üí        target_site: params.siteUrl,
   856‚Üí        page_data: {
   857‚Üí          post_title: params.title,
   858‚Üí          post_name: params.slug,
   859‚Üí          post_status: 'publish',
   860‚Üí          post_type: 'page',
   861‚Üí          post_content: '', // Elementor uses meta, not content
   862‚Üí          meta_input: {
   863‚Üí            '_elementor_edit_mode': 'builder',
   864‚Üí            '_elementor_template_type': 'wp-page',
   865‚Üí            '_elementor_version': '3.17.0',
   866‚Üí            '_elementor_data': params.elementorData,
   867‚Üí            '_wp_page_template': 'default'
   868‚Üí          }
   869‚Üí        },
   870‚Üí        gcon_piece_id: params.gconPieceId
   871‚Üí      })
   872‚Üí    });
   873‚Üí
   874‚Üí    return await response.json();
   875‚Üí  };
   876‚Üí
   877‚Üí  // Handle run snoverride function
   878‚Üí  const handleRunSnoverride = async () => {
   879‚Üí    if (!gconPieceId || !gconPiece) {
   880‚Üí      alert('No gcon_piece found to process');
   881‚Üí      return;
   882‚Üí    }
   883‚Üí
   884‚Üí    if (!gconPiece.pelementor_edits) {
   885‚Üí      alert('No pelementor_edits data found. Please compile text content first.');
   886‚Üí      return;
   887‚Üí    }
   888‚Üí
   889‚Üí    if (!gconPiece.asn_sitespren_base) {
   890‚Üí      alert('No asn_sitespren_base found. Cannot determine target WordPress site.');
   891‚Üí      return;
   892‚Üí    }
   893‚Üí
   894‚Üí    if (!gconPiece.g_post_id) {
   895‚Üí      alert('No g_post_id found. Cannot identify which WordPress post to update.');
   896‚Üí      return;
   897‚Üí    }
   898‚Üí
   899‚Üí    setIsRunningSnoverride(true);
   900‚Üí    setSnoverrideProgress('Initializing...');
   901‚Üí    setSnoverrideResult(null);
   902‚Üí
   903‚Üí    try {
   904‚Üí      // Step 1: Prepare update data
   905‚Üí      setSnoverrideProgress('Preparing Elementor page update...');
   906‚Üí      
   907‚Üí      const pageTitle = gconPiece.h1title || gconPiece.mud_title || 'Updated Elementor Page';
   908‚Üí      const elementorData = gconPiece.pelementor_edits;
   909‚Üí      const postId = gconPiece.g_post_id;
   910‚Üí
   911‚Üí      // Step 2: Update WordPress post
   912‚Üí      setSnoverrideProgress('Updating WordPress post...');
   913‚Üí      
   914‚Üí      let apiResponse;
   915‚Üí      
   916‚Üí      switch (snoverrideConnectionType) {
   917‚Üí        case 'snefuruplin':
   918‚Üí          // Use Snefuruplin WP Plugin
   919‚Üí          setSnoverrideProgress('Connecting via Snefuruplin WP Plugin...');
   920‚Üí          apiResponse = await updateElementorPageViaSnefuruplin({
   921‚Üí            siteUrl: gconPiece.asn_sitespren_base,
   922‚Üí            postId: postId,
   923‚Üí            title: pageTitle,
   924‚Üí            elementorData: elementorData,
   925‚Üí            gconPieceId: gconPieceId
   926‚Üí          });
   927‚Üí          break;
   928‚Üí          
   929‚Üí        case 'rest_api':
   930‚Üí          // Use WordPress REST API
   931‚Üí          setSnoverrideProgress('Connecting via WordPress REST API...');
   932‚Üí          apiResponse = await updateElementorPageViaRestAPI({
   933‚Üí            siteUrl: gconPiece.asn_sitespren_base,
   934‚Üí            postId: postId,
   935‚Üí            title: pageTitle,
   936‚Üí            elementorData: elementorData,
   937‚Üí            gconPieceId: gconPieceId
   938‚Üí          });
   939‚Üí          break;
   940‚Üí          
   941‚Üí        case 'api_other':
   942‚Üí          // Use other API method
   943‚Üí          setSnoverrideProgress('Connecting via alternative API...');
   944‚Üí          apiResponse = await updateElementorPageViaOtherAPI({
   945‚Üí            siteUrl: gconPiece.asn_sitespren_base,
   946‚Üí            postId: postId,
   947‚Üí            title: pageTitle,
   948‚Üí            elementorData: elementorData,
   949‚Üí            gconPieceId: gconPieceId
   950‚Üí          });
   951‚Üí          break;
   952‚Üí          
   953‚Üí        default:
   954‚Üí          throw new Error('Invalid connection type selected');
   955‚Üí      }
   956‚Üí
   957‚Üí      // Step 3: Process response
   958‚Üí      setSnoverrideProgress('Processing response...');
   959‚Üí      
   960‚Üí      if (apiResponse.success) {
   961‚Üí        const wpEditorUrl = `https://${gconPiece.asn_sitespren_base}/wp-admin/post.php?post=${postId}&action=elementor`;
   962‚Üí        const liveUrl = `https://${gconPiece.asn_sitespren_base}/?p=${postId}`;
   963‚Üí        
   964‚Üí        setSnoverrideResult({
   965‚Üí          success: true,
   966‚Üí          wpEditorUrl,
   967‚Üí          liveUrl,
   968‚Üí          postId: postId,
   969‚Üí          message: `Successfully updated Elementor page "${pageTitle}"`
   970‚Üí        });
   971‚Üí        
   972‚Üí        setSnoverrideProgress('‚úÖ Page updated successfully!');
   973‚Üí      } else {
   974‚Üí        throw new Error(apiResponse.message || 'Failed to update page');
   975‚Üí      }
   976‚Üí
   977‚Üí    } catch (error) {
   978‚Üí      console.error('Error running snoverride function:', error);
   979‚Üí      setSnoverrideResult({
   980‚Üí        success: false,
   981‚Üí        message: error instanceof Error ? error.message : 'Unknown error occurred'
   982‚Üí      });
   983‚Üí      setSnoverrideProgress('‚ùå Failed to update page');
   984‚Üí    } finally {
   985‚Üí      setIsRunningSnoverride(false);
   986‚Üí    }
   987‚Üí  };
   988‚Üí
   989‚Üí  // Snefuruplin WP Plugin update implementation
   990‚Üí  const updateElementorPageViaSnefuruplin = async (params: {
   991‚Üí    siteUrl: string;
   992‚Üí    postId: number;
   993‚Üí    title: string;
   994‚Üí    elementorData: string;
   995‚Üí    gconPieceId: string;
   996‚Üí  }) => {
   997‚Üí    const response = await fetch('/api/snoverride-update-elementor-page', {
   998‚Üí      method: 'POST',
   999‚Üí      headers: {
  1000‚Üí        'Content-Type': 'application/json',
  1001‚Üí      },
  1002‚Üí      body: JSON.stringify({
  1003‚Üí        site_url: params.siteUrl,
  1004‚Üí        post_id: params.postId,
  1005‚Üí        post_title: params.title,
  1006‚Üí        elementor_data: params.elementorData,
  1007‚Üí        gcon_piece_id: params.gconPieceId,
  1008‚Üí        // Update only the elementor data and title
  1009‚Üí        update_fields: {
  1010‚Üí          post_title: params.title,
  1011‚Üí          meta_input: {
  1012‚Üí            '_elementor_data': params.elementorData,
  1013‚Üí            '_elementor_edit_mode': 'builder',
  1014‚Üí            '_elementor_version': '3.17.0'
  1015‚Üí          }
  1016‚Üí        }
  1017‚Üí      })
  1018‚Üí    });
  1019‚Üí
  1020‚Üí    return await response.json();
  1021‚Üí  };
  1022‚Üí
  1023‚Üí  // WordPress REST API update implementation
  1024‚Üí  const updateElementorPageViaRestAPI = async (params: {
  1025‚Üí    siteUrl: string;
  1026‚Üí    postId: number;
  1027‚Üí    title: string;
  1028‚Üí    elementorData: string;
  1029‚Üí    gconPieceId: string;
  1030‚Üí  }) => {
  1031‚Üí    // Step 1: Update the post via REST API
  1032‚Üí    const updatePostResponse = await fetch(`https://${params.siteUrl}/wp-json/wp/v2/pages/${params.postId}`, {
  1033‚Üí      method: 'POST',
  1034‚Üí      headers: {
  1035‚Üí        'Content-Type': 'application/json',
  1036‚Üí        'Authorization': 'Bearer YOUR_WP_TOKEN', // You'll need to implement auth
  1037‚Üí      },
  1038‚Üí      body: JSON.stringify({
  1039‚Üí        title: params.title
  1040‚Üí      })
  1041‚Üí    });
  1042‚Üí
  1043‚Üí    const post = await updatePostResponse.json();
  1044‚Üí    
  1045‚Üí    if (!updatePostResponse.ok) {
  1046‚Üí      throw new Error(post.message || 'Failed to update post');
  1047‚Üí    }
  1048‚Üí
  1049‚Üí    // Step 2: Update Elementor meta data
  1050‚Üí    const metaUpdates = [
  1051‚Üí      { key: '_elementor_data', value: params.elementorData },
  1052‚Üí      { key: '_elementor_edit_mode', value: 'builder' },
  1053‚Üí      { key: '_elementor_version', value: '3.17.0' }
  1054‚Üí    ];
  1055‚Üí
  1056‚Üí    for (const meta of metaUpdates) {
  1057‚Üí      await fetch(`https://${params.siteUrl}/wp-json/wp/v2/pages/${params.postId}/meta`, {
  1058‚Üí        method: 'POST',
  1059‚Üí        headers: {
  1060‚Üí          'Content-Type': 'application/json',
  1061‚Üí          'Authorization': 'Bearer YOUR_WP_TOKEN',
  1062‚Üí        },
  1063‚Üí        body: JSON.stringify(meta)
  1064‚Üí      });
  1065‚Üí    }
  1066‚Üí
  1067‚Üí    return {
  1068‚Üí      success: true,
  1069‚Üí      postId: params.postId,
  1070‚Üí      message: 'Page updated successfully via REST API'
  1071‚Üí    };
  1072‚Üí  };
  1073‚Üí
  1074‚Üí  // Alternative API update implementation
  1075‚Üí  const updateElementorPageViaOtherAPI = async (params: {
  1076‚Üí    siteUrl: string;
  1077‚Üí    postId: number;
  1078‚Üí    title: string;
  1079‚Üí    elementorData: string;
  1080‚Üí    gconPieceId: string;
  1081‚Üí  }) => {
  1082‚Üí    const response = await fetch('/api/wordpress/update-elementor-page', {
  1083‚Üí      method: 'POST',
  1084‚Üí      headers: {
  1085‚Üí        'Content-Type': 'application/json',
  1086‚Üí      },
  1087‚Üí      body: JSON.stringify({
  1088‚Üí        target_site: params.siteUrl,
  1089‚Üí        post_id: params.postId,
  1090‚Üí        update_data: {
  1091‚Üí          post_title: params.title,
  1092‚Üí          meta_input: {
  1093‚Üí            '_elementor_data': params.elementorData,
  1094‚Üí            '_elementor_edit_mode': 'builder',
  1095‚Üí            '_elementor_version': '3.17.0'
  1096‚Üí          }
  1097‚Üí        },
  1098‚Üí        gcon_piece_id: params.gconPieceId
  1099‚Üí      })
  1100‚Üí    });
  1101‚Üí
  1102‚Üí    return await response.json();
  1103‚Üí  };
  1104‚Üí
  1105‚Üí  if (!user) {
  1106‚Üí    return (
  1107‚Üí      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
  1108‚Üí        <p className="text-gray-500">Please log in to access this page.</p>
  1109‚Üí      </div>
  1110‚Üí    );
  1111‚Üí  }
  1112‚Üí
  1113‚Üí  if (loading) {
  1114‚Üí    return (
  1115‚Üí      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
  1116‚Üí        <div className="text-center">
  1117‚Üí          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
  1118‚Üí          <p className="mt-2 text-gray-600">Loading...</p>
  1119‚Üí        </div>
  1120‚Üí      </div>
  1121‚Üí    );
  1122‚Üí  }
  1123‚Üí
  1124‚Üí  if (error) {
  1125‚Üí    return (
  1126‚Üí      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
  1127‚Üí        <div className="text-center">
  1128‚Üí          <p className="text-red-600">Error: {error}</p>
  1129‚Üí        </div>
  1130‚Üí      </div>
  1131‚Üí    );
  1132‚Üí  }
  1133‚Üí
  1134‚Üí  return (
  1135‚Üí    <div className="min-h-screen bg-gray-50">
  1136‚Üí      {/* Sticky Menu Component */}
  1137‚Üí      <MarzdiStickyMenu h1Title={gconPiece?.h1title} />
  1138‚Üí      
  1139‚Üí      <div className="p-4">
  1140‚Üí        <div className="mb-4 flex items-center gap-4">
  1141‚Üí          <Link href="/dashboard" className="text-blue-600 hover:text-blue-800">
  1142‚Üí            ‚Üê Back to Dashboard
  1143‚Üí          </Link>
  1144‚Üí          <button
  1145‚Üí            className={`px-4 py-2 font-medium rounded-md transition-colors ${
  1146‚Üí              isPopulatingUnits
  1147‚Üí                ? 'bg-gray-400 cursor-not-allowed text-white'
  1148‚Üí                : 'bg-purple-600 hover:bg-purple-700 text-white'
  1149‚Üí            }`}
  1150‚Üí            onClick={handlePopulateNemtorUnits}
  1151‚Üí            disabled={isPopulatingUnits || !gconPieceId}
  1152‚Üí          >
  1153‚Üí            {isPopulatingUnits ? 'Populating...' : 'handlePopulateNemtorUnit'}
  1154‚Üí          </button>
  1155‚Üí        </div>
  1156‚Üí        
  1157‚Üí        {/* Populate feedback message */}
  1158‚Üí        {populateMessage && (
  1159‚Üí          <div className={`mb-4 p-3 rounded-md ${
  1160‚Üí            populateMessage.startsWith('‚úÖ') 
  1161‚Üí              ? 'bg-green-100 border border-green-400 text-green-700'
  1162‚Üí              : 'bg-red-100 border border-red-400 text-red-700'
  1163‚Üí          }`}>
  1164‚Üí            {populateMessage}
  1165‚Üí          </div>
  1166‚Üí        )}
  1167‚Üí        
  1168‚Üí        {/* Cloned Areas from Mesagen Page */}
  1169‚Üí        {gconPieceId && (
  1170‚Üí          <div className="mb-4">
  1171‚Üí            <div className="flex items-start gap-4" style={{ marginTop: '10px' }}>
  1172‚Üí              {/* AREA 1: Info Box - Cloned from mesagen */}
  1173‚Üí              <div className="bg-gray-50 border border-gray-300 rounded-lg p-4" style={{ width: '450px' }}>
  1174‚Üí                <div className="mb-3">
  1175‚Üí                  <Link href="/gconjar1" className="text-blue-600 hover:text-blue-800">
  1176‚Üí                    ‚Üê Back to GconJar1
  1177‚Üí                  </Link>
  1178‚Üí                </div>
  1179‚Üí                
  1180‚Üí                <div className="mb-3">
  1181‚Üí                  <Link href={`/torya?gcon_piece_id=${gconPieceId}`} className="text-blue-600 hover:text-blue-800">
  1182‚Üí                    -- Visit /torya --
  1183‚Üí                  </Link>
  1184‚Üí                </div>
  1185‚Üí                
  1186‚Üí                <div className="mb-3 text-sm text-gray-600">
  1187‚Üí                  <strong>gcon_pieces.id:</strong> {gconPieceId}
  1188‚Üí                </div>
  1189‚Üí
  1190‚Üí                {/* asn_sitespren_base */}
  1191‚Üí                <div className="mb-3">
  1192‚Üí                  <label className="block text-sm font-bold text-gray-700 mb-1">
  1193‚Üí                    asn_sitespren_base
  1194‚Üí                  </label>
  1195‚Üí                  <div className="w-full px-3 py-2 border border-gray-300 rounded bg-gray-50 text-sm">
  1196‚Üí                    {gconPiece?.asn_sitespren_base || 'Not set'}
  1197‚Üí                  </div>
  1198‚Üí                </div>
  1199‚Üí
  1200‚Üí                {/* post_name */}
  1201‚Üí                <div className="mb-3">
  1202‚Üí                  <label className="block text-sm font-bold text-gray-700 mb-1">
  1203‚Üí                    post_name
  1204‚Üí                  </label>
  1205‚Üí                  <div className="flex items-center gap-1 p-2 bg-gray-900 text-green-400 rounded font-mono text-sm border">
  1206‚Üí                    <button
  1207‚Üí                      onClick={() => {
  1208‚Üí                        if (gconPiece?.asn_sitespren_base && gconPiece?.post_name) {
  1209‚Üí                          window.open(`https://${gconPiece.asn_sitespren_base}/${gconPiece.post_name}`, '_blank');
  1210‚Üí                        }
  1211‚Üí                      }}
  1212‚Üí                      disabled={!gconPiece?.post_name || !gconPiece?.asn_sitespren_base}
  1213‚Üí                      className="w-6 h-6 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white rounded flex items-center justify-center"
  1214‚Üí                      title="Open in new tab"
  1215‚Üí                    >
  1216‚Üí                      ‚Üó
  1217‚Üí                    </button>
  1218‚Üí                    <button
  1219‚Üí                      onClick={() => navigator.clipboard.writeText(gconPiece?.post_name || '')}
  1220‚Üí                      className="w-6 h-6 bg-gray-600 hover:bg-gray-700 text-white rounded flex items-center justify-center"
  1221‚Üí                      title="Copy to clipboard"
  1222‚Üí                    >
  1223‚Üí                      üìã
  1224‚Üí                    </button>
  1225‚Üí                    <span className="flex-1 px-2">
  1226‚Üí                      {gconPiece?.post_name || ''}
  1227‚Üí                    </span>
  1228‚Üí                  </div>
  1229‚Üí                </div>
  1230‚Üí
  1231‚Üí                {/* pageslug */}
  1232‚Üí                <div className="mb-3">
  1233‚Üí                  <label className="block text-sm font-bold text-gray-700 mb-1">
  1234‚Üí                    pageslug
  1235‚Üí                  </label>
  1236‚Üí                  <div className="flex items-center gap-1 p-2 bg-gray-900 text-green-400 rounded font-mono text-sm border">
  1237‚Üí                    <button
  1238‚Üí                      onClick={() => {
  1239‚Üí                        if (gconPiece?.asn_sitespren_base && gconPiece?.pageslug) {
  1240‚Üí                          window.open(`https://${gconPiece.asn_sitespren_base}/${gconPiece.pageslug}`, '_blank');
  1241‚Üí                        }
  1242‚Üí                      }}
  1243‚Üí                      disabled={!gconPiece?.pageslug || !gconPiece?.asn_sitespren_base}
  1244‚Üí                      className="w-6 h-6 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white rounded flex items-center justify-center"
  1245‚Üí                      title="Open in new tab"
  1246‚Üí                    >
  1247‚Üí                      ‚Üó
  1248‚Üí                    </button>
  1249‚Üí                    <button
  1250‚Üí                      onClick={() => navigator.clipboard.writeText(gconPiece?.pageslug || '')}
  1251‚Üí                      className="w-6 h-6 bg-gray-600 hover:bg-gray-700 text-white rounded flex items-center justify-center"
  1252‚Üí                      title="Copy to clipboard"
  1253‚Üí                    >
  1254‚Üí                      üìã
  1255‚Üí                    </button>
  1256‚Üí                    <span className="flex-1 px-2">
  1257‚Üí                      {gconPiece?.pageslug || ''}
  1258‚Üí                    </span>
  1259‚Üí                  </div>
  1260‚Üí                </div>
  1261‚Üí
  1262‚Üí                {/* pageurl */}
  1263‚Üí                <div className="mb-3">
  1264‚Üí                  <label className="block text-sm font-bold text-gray-700 mb-1">
  1265‚Üí                    pageurl
  1266‚Üí                  </label>
  1267‚Üí                  <div className="flex items-center gap-1 p-2 bg-gray-900 text-green-400 rounded font-mono text-sm border">
  1268‚Üí                    <button
  1269‚Üí                      onClick={() => {
  1270‚Üí                        if (gconPiece?.pageurl) {
  1271‚Üí                          window.open(gconPiece.pageurl, '_blank');
  1272‚Üí                        }
  1273‚Üí                      }}
  1274‚Üí                      disabled={!gconPiece?.pageurl}
  1275‚Üí                      className="w-6 h-6 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white rounded flex items-center justify-center"
  1276‚Üí                      title="Open in new tab"
  1277‚Üí                    >
  1278‚Üí                      ‚Üó
  1279‚Üí                    </button>
  1280‚Üí                    <button
  1281‚Üí                      onClick={() => navigator.clipboard.writeText(gconPiece?.pageurl || '')}
  1282‚Üí                      className="w-6 h-6 bg-gray-600 hover:bg-gray-700 text-white rounded flex items-center justify-center"
  1283‚Üí                      title="Copy to clipboard"
  1284‚Üí                    >
  1285‚Üí                      üìã
  1286‚Üí                    </button>
  1287‚Üí                    <span className="flex-1 px-2">
  1288‚Üí                      {gconPiece?.pageurl || ''}
  1289‚Üí                    </span>
  1290‚Üí                  </div>
  1291‚Üí                </div>
  1292‚Üí              </div>
  1293‚Üí
  1294‚Üí              {/* AREA 2: Image Plans Batch Box - Cloned from mesagen */}
  1295‚Üí              <div className="bg-gray-50 border border-gray-300 rounded-lg p-4" style={{ width: '450px' }}>
  1296‚Üí                <div className="mb-3">
  1297‚Üí                  <div className="flex items-center justify-between mb-2">
  1298‚Üí                    <label className="text-sm font-bold text-gray-700">
  1299‚Üí                      asn_image_plan_batch_id
  1300‚Üí                    </label>
  1301‚Üí                    <button
  1302‚Üí                      onClick={() => {
  1303‚Üí                        // Placeholder - waiting for backend functionality instructions
  1304‚Üí                        console.log('Create new batch clicked');
  1305‚Üí                      }}
  1306‚Üí                      className="rounded"
  1307‚Üí                      style={{
  1308‚Üí                        backgroundColor: '#d3d3d3', // light gray
  1309‚Üí                        color: '#4a4a4a', // dark gray
  1310‚Üí                        fontSize: '13px',
  1311‚Üí                        padding: '3px 8px'
  1312‚Üí                      }}
  1313‚Üí                    >
  1314‚Üí                      create new batch
  1315‚Üí                    </button>
  1316‚Üí                  </div>
  1317‚Üí                  <select
  1318‚Üí                    className="w-full px-3 py-2 border border-gray-300 rounded bg-white text-sm"
  1319‚Üí                    value={selectedBatchId}
  1320‚Üí                    onChange={(e) => setSelectedBatchId(e.target.value)}
  1321‚Üí                  >
  1322‚Üí                    <option value="">Select image plan batch...</option>
  1323‚Üí                    {imagePlansBatches.map((batch) => (
  1324‚Üí                      <option key={batch.id} value={batch.id}>
  1325‚Üí                        {batch.batch_name || `Batch ${batch.id.substring(0, 8)}...`}
  1326‚Üí                      </option>
  1327‚Üí                    ))}
  1328‚Üí                  </select>
  1329‚Üí                </div>
  1330‚Üí                
  1331‚Üí                <div className="mt-4 flex gap-2">
  1332‚Üí                  <button
  1333‚Üí                    onClick={handleSaveImagePlanBatch}
  1334‚Üí                    disabled={isSavingBatch || !selectedBatchId}
  1335‚Üí                    className="px-4 py-2 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed"
  1336‚Üí                    style={{
  1337‚Üí                      backgroundColor: '#000000',
  1338‚Üí                      fontSize: '16px'
  1339‚Üí                    }}
  1340‚Üí                  >
  1341‚Üí                    {isSavingBatch ? 'Saving...' : 'save'}
  1342‚Üí                  </button>
  1343‚Üí                  
  1344‚Üí                  {/* Open Batch Button - Show if batch is selected or assigned */}
  1345‚Üí                  {(selectedBatchId || gconPiece?.asn_image_plan_batch_id) && (
  1346‚Üí                    <a
  1347‚Üí                      href={`https://snef.me/bin34/tebnar2?batchid=${selectedBatchId || gconPiece?.asn_image_plan_batch_id}`}
  1348‚Üí                      className="px-4 py-2 rounded inline-block text-center"
  1349‚Üí                      style={{
  1350‚Üí                        backgroundColor: '#009bff', // bestlinkcol
  1351‚Üí                        fontSize: '16px',
  1352‚Üí                        fontWeight: 'bold',
  1353‚Üí                        color: '#000',
  1354‚Üí                        border: '2px solid #000',
  1355‚Üí                        textDecoration: 'none'
  1356‚Üí                      }}
  1357‚Üí                    >
  1358‚Üí                      open batch in /tebnar2
  1359‚Üí                    </a>
  1360‚Üí                  )}
  1361‚Üí                </div>
  1362‚Üí
  1363‚Üí                {/* Narpi Pushes Table */}
  1364‚Üí                {(selectedBatchId || gconPiece?.asn_image_plan_batch_id) && narpiPushes.length > 0 && (
  1365‚Üí                  <div className="mt-4">
  1366‚Üí                    <div className="overflow-x-auto rounded border border-gray-300" style={{ maxWidth: '440px' }}>
  1367‚Üí                      <table className="min-w-full" style={{ fontSize: '14px' }}>
  1368‚Üí                        <thead>
  1369‚Üí                          <tr className="bg-gray-100">
  1370‚Üí                            <th style={{ width: '30px', padding: '3px', minWidth: '30px' }} className="text-left font-bold">
  1371‚Üí                              <input
  1372‚Üí                                type="checkbox"
  1373‚Üí                                checked={selectedNarpiPushes.size === narpiPushes.length && narpiPushes.length > 0}
  1374‚Üí                                onChange={(e) => {
  1375‚Üí                                  if (e.target.checked) {
  1376‚Üí                                    setSelectedNarpiPushes(new Set(narpiPushes.map(p => p.id)));
  1377‚Üí                                  } else {
  1378‚Üí                                    setSelectedNarpiPushes(new Set());
  1379‚Üí                                  }
  1380‚Üí                                }}
  1381‚Üí                              />
  1382‚Üí                            </th>
  1383‚Üí                            <th style={{ width: '200px', padding: '3px', minWidth: '200px' }} className="text-left font-bold">kareench1</th>
  1384‚Üí                            <th style={{ width: '60px', padding: '3px', minWidth: '60px' }} className="text-left font-bold">id</th>
  1385‚Üí                            <th style={{ width: '120px', padding: '3px', minWidth: '120px' }} className="text-left font-bold">push_name</th>
  1386‚Üí                            <th style={{ width: '80px', padding: '3px', minWidth: '80px' }} className="text-left font-bold">push_status1</th>
  1387‚Üí                            <th style={{ width: '60px', padding: '3px', minWidth: '60px' }} className="text-left font-bold">created_at</th>
  1388‚Üí                          </tr>
  1389‚Üí                        </thead>
  1390‚Üí                        <tbody>
  1391‚Üí                          {narpiPushes.map((push) => (
  1392‚Üí                            <tr key={push.id} className="border-t border-gray-200 hover:bg-gray-50">
  1393‚Üí                              <td style={{ padding: '3px' }}>
  1394‚Üí                                <div style={{ height: '19px' }} className="flex items-center">
  1395‚Üí                                  <input
  1396‚Üí                                    type="checkbox"
  1397‚Üí                                    checked={selectedNarpiPushes.has(push.id)}
  1398‚Üí                                    onChange={(e) => {
  1399‚Üí                                      const newSelected = new Set(selectedNarpiPushes);
  1400‚Üí                                      if (e.target.checked) {
  1401‚Üí                                        newSelected.add(push.id);
  1402‚Üí                                      } else {
  1403‚Üí                                        newSelected.delete(push.id);
  1404‚Üí                                      }
  1405‚Üí                                      setSelectedNarpiPushes(newSelected);
  1406‚Üí                                    }}
  1407‚Üí                                  />
  1408‚Üí                                </div>
  1409‚Üí                              </td>
  1410‚Üí                              <td style={{ padding: '3px' }}>
  1411‚Üí                                <div style={{ height: '19px' }} className="flex items-center space-x-1">
  1412‚Üí                                  <div style={{ fontSize: '11px' }}>
  1413‚Üí                                    {push.kareench1 && Array.isArray(push.kareench1) ? (
  1414‚Üí                                      <div className="flex space-x-1">
  1415‚Üí                                        {(() => {
  1416‚Üí                                          const results = push.kareench1;
  1417‚Üí                                          const total = results.length;
  1418‚Üí                                          const success = results.filter((r: any) => r.nupload_status1 === 'success').length;
  1419‚Üí                                          const failed = results.filter((r: any) => r.nupload_status1 === 'failed').length;
  1420‚Üí                                          
  1421‚Üí                                          return (
  1422‚Üí                                            <>
  1423‚Üí                                              <span className="bg-blue-100 text-blue-800 px-1 rounded text-xs">T:{total}</span>
  1424‚Üí                                              <span className="bg-green-100 text-green-800 px-1 rounded text-xs">‚úì{success}</span>
  1425‚Üí                                              <span className="bg-red-100 text-red-800 px-1 rounded text-xs">‚úó{failed}</span>
  1426‚Üí                                            </>
  1427‚Üí                                          );
  1428‚Üí                                        })()}
  1429‚Üí                                      </div>
  1430‚Üí                                    ) : push.kareench1 ? (
  1431‚Üí                                      <div className="truncate text-xs" style={{ maxWidth: '120px' }}>
  1432‚Üí                                        {typeof push.kareench1 === 'string' 
  1433‚Üí                                          ? (push.kareench1.length > 20 ? `${push.kareench1.substring(0, 20)}...` : push.kareench1)
  1434‚Üí                                          : JSON.stringify(push.kareench1).length > 20 
  1435‚Üí                                            ? `${JSON.stringify(push.kareench1).substring(0, 20)}...`
  1436‚Üí                                            : JSON.stringify(push.kareench1)
  1437‚Üí                                        }
  1438‚Üí                                      </div>
  1439‚Üí                                    ) : (
  1440‚Üí                                      <span className="text-gray-400 italic text-xs">No data</span>
  1441‚Üí                                    )}
  1442‚Üí                                  </div>
  1443‚Üí                                  {push.kareench1 && (
  1444‚Üí                                    <button
  1445‚Üí                                      onClick={() => copyNarpiKareenchValue(push.id, push.kareench1)}
  1446‚Üí                                      className={`px-1 py-0.5 text-xs rounded ${
  1447‚Üí                                        copiedNarpiId === push.id
  1448‚Üí                                          ? 'text-green-800 bg-green-100'
  1449‚Üí                                          : 'text-gray-600 bg-gray-100 hover:bg-gray-200'
  1450‚Üí                                      }`}
  1451‚Üí                                      style={{ fontSize: '10px' }}
  1452‚Üí                                    >
  1453‚Üí                                      {copiedNarpiId === push.id ? '‚úì' : 'Copy'}
  1454‚Üí                                    </button>
  1455‚Üí                                  )}
  1456‚Üí                                </div>
  1457‚Üí                              </td>
  1458‚Üí                              <td style={{ padding: '3px' }}>
  1459‚Üí                                <div style={{ height: '19px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
  1460‚Üí                                  {push.id.substring(0, 8)}...
  1461‚Üí                                </div>
  1462‚Üí                              </td>
  1463‚Üí                              <td style={{ padding: '3px' }}>
  1464‚Üí                                <div style={{ height: '19px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
  1465‚Üí                                  {push.push_name || '-'}
  1466‚Üí                                </div>
  1467‚Üí                              </td>
  1468‚Üí                              <td style={{ padding: '3px' }}>
  1469‚Üí                                <div style={{ height: '19px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
  1470‚Üí                                  {push.push_status1 || '-'}
  1471‚Üí                                </div>
  1472‚Üí                              </td>
  1473‚Üí                              <td style={{ padding: '3px' }}>
  1474‚Üí                                <div style={{ height: '19px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
  1475‚Üí                                  {new Date(push.created_at).toLocaleDateString('en-US', { month: '2-digit', day: '2-digit' })}
  1476‚Üí                                </div>
  1477‚Üí                              </td>
  1478‚Üí                            </tr>
  1479‚Üí                          ))}
  1480‚Üí                        </tbody>
  1481‚Üí                      </table>
  1482‚Üí                    </div>
  1483‚Üí                  </div>
  1484‚Üí                )}
  1485‚Üí
  1486‚Üí                {/* Open Narpo1 Button - Show if batch is selected or assigned */}
  1487‚Üí                {(selectedBatchId || gconPiece?.asn_image_plan_batch_id) && (
  1488‚Üí                  <div className="mt-3">
  1489‚Üí                    <a
  1490‚Üí                      href={`https://snef.me/bin42/narpo1?fk_batch_id=${selectedBatchId || gconPiece?.asn_image_plan_batch_id}`}
  1491‚Üí                      className="px-4 py-2 rounded inline-block text-center"
  1492‚Üí                      style={{
  1493‚Üí                        backgroundColor: '#009bff', // bestlinkcol
  1494‚Üí                        fontSize: '16px',
  1495‚Üí                        fontWeight: 'bold',
  1496‚Üí                        color: '#000',
  1497‚Üí                        border: '2px solid #000',
  1498‚Üí                        textDecoration: 'none'
  1499‚Üí                      }}
  1500‚Üí                    >
  1501‚Üí                      open /narpo1
  1502‚Üí                    </a>
  1503‚Üí                  </div>
  1504‚Üí                )}
  1505‚Üí              </div>
  1506‚Üí
  1507‚Üí              {/* NEW AREA 3: Dublish Function Box */}
  1508‚Üí              <div className="bg-gray-50 border border-gray-300 rounded-lg p-4" style={{ width: '450px' }}>
  1509‚Üí                <div className="mb-3">
  1510‚Üí                  <strong className="text-sm font-bold text-gray-700">
  1511‚Üí                    Publish new elementor page using dublish function
  1512‚Üí                  </strong>
  1513‚Üí                </div>
  1514‚Üí                
  1515‚Üí                <hr className="my-3 border-gray-300" />
  1516‚Üí                
  1517‚Üí                <div className="mb-3">
  1518‚Üí                  <button
  1519‚Üí                    onClick={handleCompileTextContent}
  1520‚Üí                    disabled={isCompilingTextContent || !gconPiece?.pelementor_cached}
  1521‚Üí                    className={`w-full px-4 py-2 text-white rounded transition-colors ${
  1522‚Üí                      isCompilingTextContent || !gconPiece?.pelementor_cached
  1523‚Üí                        ? 'bg-gray-400 cursor-not-allowed'
  1524‚Üí                        : 'bg-black hover:bg-gray-800'
  1525‚Üí                    }`}
  1526‚Üí                    style={{
  1527‚Üí                      fontSize: '14px'
  1528‚Üí                    }}
  1529‚Üí                  >
  1530‚Üí                    {isCompilingTextContent ? 'Compiling...' : 'compile new_desired_text_content into pelementor_edits'}
  1531‚Üí                  </button>
  1532‚Üí                  <p className="text-xs text-gray-600 mt-2 italic">
  1533‚Üí                    (includes active checkboxes for man_img_url and man_img_id)
  1534‚Üí                  </p>
  1535‚Üí                </div>
  1536‚Üí                
  1537‚Üí                <hr className="my-3 border-gray-300" />
  1538‚Üí                
  1539‚Üí                <div className="mb-3">
  1540‚Üí                  <button
  1541‚Üí                    onClick={() => alert('compile new_desired_image_content into pelementor_edits - functionality coming soon')}
  1542‚Üí                    className="w-full px-4 py-2 text-white rounded"
  1543‚Üí                    style={{
  1544‚Üí                      backgroundColor: '#000000',
  1545‚Üí                      fontSize: '14px'
  1546‚Üí                    }}
  1547‚Üí                  >
  1548‚Üí                    compile new_desired_image_content into pelementor_edits
  1549‚Üí                  </button>
  1550‚Üí                </div>
  1551‚Üí                
  1552‚Üí                <hr className="my-3 border-gray-300" />
  1553‚Üí                
  1554‚Üí                <div className="mb-3">
  1555‚Üí                  <button
  1556‚Üí                    onClick={handleRunDublish}
  1557‚Üí                    disabled={isRunningDublish || !gconPiece?.pelementor_edits || !gconPiece?.asn_sitespren_base}
  1558‚Üí                    className={`w-full px-4 py-2 text-white rounded transition-colors ${
  1559‚Üí                      isRunningDublish || !gconPiece?.pelementor_edits || !gconPiece?.asn_sitespren_base
  1560‚Üí                        ? 'bg-gray-400 cursor-not-allowed'
  1561‚Üí                        : 'bg-black hover:bg-gray-800'
  1562‚Üí                    }`}
  1563‚Üí                    style={{
  1564‚Üí                      fontSize: '14px'
  1565‚Üí                    }}
  1566‚Üí                  >
  1567‚Üí                    {isRunningDublish ? (
  1568‚Üí                      <div className="flex items-center justify-center gap-2">
  1569‚Üí                        <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
  1570‚Üí                        Publishing...
  1571‚Üí                      </div>
  1572‚Üí                    ) : (
  1573‚Üí                      'run dublish function'
  1574‚Üí                    )}
  1575‚Üí                  </button>
  1576‚Üí                </div>
  1577‚Üí
  1578‚Üí                {/* Connection Type Selector */}
  1579‚Üí                <div className="mb-3">
  1580‚Üí                  <label className="block text-xs font-bold text-gray-700 mb-2">
  1581‚Üí                    Connection Type:
  1582‚Üí                  </label>
  1583‚Üí                  <select
  1584‚Üí                    value={dublishConnectionType}
  1585‚Üí                    onChange={(e) => setDublishConnectionType(e.target.value as 'snefuruplin' | 'rest_api' | 'api_other')}
  1586‚Üí                    disabled={isRunningDublish}
  1587‚Üí                    className="w-full px-3 py-2 border border-gray-300 rounded text-sm bg-white disabled:bg-gray-100"
  1588‚Üí                  >
  1589‚Üí                    <option value="snefuruplin">Snefuruplin WP Plugin</option>
  1590‚Üí                    <option value="rest_api">REST API</option>
  1591‚Üí                    <option value="api_other">API (other)</option>
  1592‚Üí                  </select>
  1593‚Üí                </div>
  1594‚Üí
  1595‚Üí                {/* Progress Indicator */}
  1596‚Üí                {dublishProgress && (
  1597‚Üí                  <div className="mb-3 p-2 bg-blue-50 border border-blue-200 rounded">
  1598‚Üí                    <div className="text-xs text-blue-800">
  1599‚Üí                      <strong>Status:</strong> {dublishProgress}
  1600‚Üí                    </div>
  1601‚Üí                    {isRunningDublish && (
  1602‚Üí                      <div className="mt-2">
  1603‚Üí                        <div className="w-full bg-blue-200 rounded-full h-2">
  1604‚Üí                          <div className="bg-blue-600 h-2 rounded-full animate-pulse" style={{ width: '60%' }}></div>
  1605‚Üí                        </div>
  1606‚Üí                      </div>
  1607‚Üí                    )}
  1608‚Üí                  </div>
  1609‚Üí                )}
  1610‚Üí
  1611‚Üí                {/* Results Section */}
  1612‚Üí                {dublishResult && (
  1613‚Üí                  <div className={`mb-3 p-3 border rounded ${
  1614‚Üí                    dublishResult.success 
  1615‚Üí                      ? 'bg-green-50 border-green-200' 
  1616‚Üí                      : 'bg-red-50 border-red-200'
  1617‚Üí                  }`}>
  1618‚Üí                    <div className={`text-sm font-medium ${
  1619‚Üí                      dublishResult.success ? 'text-green-800' : 'text-red-800'
  1620‚Üí                    }`}>
  1621‚Üí                      {dublishResult.message}
  1622‚Üí                    </div>
  1623‚Üí                    
  1624‚Üí                    {dublishResult.success && dublishResult.wpEditorUrl && dublishResult.liveUrl && (
  1625‚Üí                      <div className="mt-3 space-y-2">
  1626‚Üí                        <a
  1627‚Üí                          href={dublishResult.wpEditorUrl}
  1628‚Üí                          target="_blank"
  1629‚Üí                          rel="noopener noreferrer"
  1630‚Üí                          className="block w-full px-3 py-2 bg-blue-600 text-white text-center rounded text-sm hover:bg-blue-700 transition-colors"
  1631‚Üí                        >
  1632‚Üí                          üîß Edit in Elementor (Post ID: {dublishResult.postId})
  1633‚Üí                        </a>
  1634‚Üí                        <a
  1635‚Üí                          href={dublishResult.liveUrl}
  1636‚Üí                          target="_blank"
  1637‚Üí                          rel="noopener noreferrer"
  1638‚Üí                          className="block w-full px-3 py-2 bg-green-600 text-white text-center rounded text-sm hover:bg-green-700 transition-colors"
  1639‚Üí                        >
  1640‚Üí                          üåê View Live Page
  1641‚Üí                        </a>
  1642‚Üí                      </div>
  1643‚Üí                    )}
  1644‚Üí                  </div>
  1645‚Üí                )}
  1646‚Üí                
  1647‚Üí                <div className="text-xs text-gray-600 mt-2">
  1648‚Üí                  create new page on asn_sitespren_base from defined data (such as pelementor_edits field in some cases, etc.)
  1649‚Üí                </div>
  1650‚Üí              </div>
  1651‚Üí
  1652‚Üí              {/* NEW AREA 4: Snoverride Function Box */}
  1653‚Üí              <div className="bg-gray-50 border border-gray-300 rounded-lg p-4" style={{ width: '450px' }}>
  1654‚Üí                <div className="mb-3">
  1655‚Üí                  <strong className="text-sm font-bold text-gray-700">
  1656‚Üí                    Update existing elementor page using snoverride function
  1657‚Üí                  </strong>
  1658‚Üí                </div>
  1659‚Üí                
  1660‚Üí                <hr className="my-3 border-gray-300" />
  1661‚Üí                
  1662‚Üí                <div className="mb-3">
  1663‚Üí                  <button
  1664‚Üí                    onClick={handleRunSnoverride}
  1665‚Üí                    disabled={isRunningSnoverride || !gconPiece?.pelementor_edits || !gconPiece?.asn_sitespren_base || !gconPiece?.g_post_id}
  1666‚Üí                    className={`w-full px-4 py-2 text-white rounded transition-colors ${
  1667‚Üí                      isRunningSnoverride || !gconPiece?.pelementor_edits || !gconPiece?.asn_sitespren_base || !gconPiece?.g_post_id
  1668‚Üí                        ? 'bg-gray-400 cursor-not-allowed'
  1669‚Üí                        : 'bg-black hover:bg-gray-800'
  1670‚Üí                    }`}
  1671‚Üí                    style={{
  1672‚Üí                      fontSize: '14px'
  1673‚Üí                    }}
  1674‚Üí                  >
  1675‚Üí                    {isRunningSnoverride ? (
  1676‚Üí                      <div className="flex items-center justify-center gap-2">
  1677‚Üí                        <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
  1678‚Üí                        Updating...
  1679‚Üí                      </div>
  1680‚Üí                    ) : (
  1681‚Üí                      'run snoverride'
  1682‚Üí                    )}
  1683‚Üí                  </button>
  1684‚Üí                </div>
  1685‚Üí
  1686‚Üí                {/* Connection Type Selector */}
  1687‚Üí                <div className="mb-3">
  1688‚Üí                  <label className="block text-xs font-bold text-gray-700 mb-2">
  1689‚Üí                    Connection Type:
  1690‚Üí                  </label>
  1691‚Üí                  <select
  1692‚Üí                    value={snoverrideConnectionType}
  1693‚Üí                    onChange={(e) => setSnoverrideConnectionType(e.target.value as 'snefuruplin' | 'rest_api' | 'api_other')}
  1694‚Üí                    disabled={isRunningSnoverride}
  1695‚Üí                    className="w-full px-3 py-2 border border-gray-300 rounded text-sm bg-white disabled:bg-gray-100"
  1696‚Üí                  >
  1697‚Üí                    <option value="snefuruplin">Snefuruplin WP Plugin</option>
  1698‚Üí                    <option value="rest_api">REST API</option>
  1699‚Üí                    <option value="api_other">API (other)</option>
  1700‚Üí                  </select>
  1701‚Üí                </div>
  1702‚Üí
  1703‚Üí                {/* Progress Indicator */}
  1704‚Üí                {snoverrideProgress && (
  1705‚Üí                  <div className="mb-3 p-2 bg-blue-50 border border-blue-200 rounded">
  1706‚Üí                    <div className="text-xs text-blue-800">
  1707‚Üí                      <strong>Status:</strong> {snoverrideProgress}
  1708‚Üí                    </div>
  1709‚Üí                    {isRunningSnoverride && (
  1710‚Üí                      <div className="mt-2">
  1711‚Üí                        <div className="w-full bg-blue-200 rounded-full h-2">
  1712‚Üí                          <div className="bg-blue-600 h-2 rounded-full animate-pulse" style={{ width: '60%' }}></div>
  1713‚Üí                        </div>
  1714‚Üí                      </div>
  1715‚Üí                    )}
  1716‚Üí                  </div>
  1717‚Üí                )}
  1718‚Üí
  1719‚Üí                {/* Results Section */}
  1720‚Üí                {snoverrideResult && (
  1721‚Üí                  <div className={`mb-3 p-3 border rounded ${
  1722‚Üí                    snoverrideResult.success 
  1723‚Üí                      ? 'bg-green-50 border-green-200' 
  1724‚Üí                      : 'bg-red-50 border-red-200'
  1725‚Üí                  }`}>
  1726‚Üí                    <div className={`text-sm font-medium ${
  1727‚Üí                      snoverrideResult.success ? 'text-green-800' : 'text-red-800'
  1728‚Üí                    }`}>
  1729‚Üí                      {snoverrideResult.message}
  1730‚Üí                    </div>
  1731‚Üí                    
  1732‚Üí                    {snoverrideResult.success && snoverrideResult.wpEditorUrl && snoverrideResult.liveUrl && (
  1733‚Üí                      <div className="mt-3 space-y-2">
  1734‚Üí                        <a
  1735‚Üí                          href={snoverrideResult.wpEditorUrl}
  1736‚Üí                          target="_blank"
  1737‚Üí                          rel="noopener noreferrer"
  1738‚Üí                          className="block w-full px-3 py-2 bg-blue-600 text-white text-center rounded text-sm hover:bg-blue-700 transition-colors"
  1739‚Üí                        >
  1740‚Üí                          üîß Edit in Elementor (Post ID: {snoverrideResult.postId})
  1741‚Üí                        </a>
  1742‚Üí                        <a
  1743‚Üí                          href={snoverrideResult.liveUrl}
  1744‚Üí                          target="_blank"
  1745‚Üí                          rel="noopener noreferrer"
  1746‚Üí                          className="block w-full px-3 py-2 bg-green-600 text-white text-center rounded text-sm hover:bg-green-700 transition-colors"
  1747‚Üí                        >
  1748‚Üí                          üåê View Updated Page
  1749‚Üí                        </a>
  1750‚Üí                      </div>
  1751‚Üí                    )}
  1752‚Üí                  </div>
  1753‚Üí                )}
  1754‚Üí                
  1755‚Üí                <div className="text-xs text-gray-600 mt-2">
  1756‚Üí                  {gconPiece?.g_post_id ? (
  1757‚Üí                    <span>
  1758‚Üí                      Update existing post ID: <strong>{gconPiece.g_post_id}</strong> on {gconPiece.asn_sitespren_base}
  1759‚Üí                    </span>
  1760‚Üí                  ) : (
  1761‚Üí                    <span className="text-red-600">
  1762‚Üí                      No g_post_id found - cannot update without target post ID
  1763‚Üí                    </span>
  1764‚Üí                  )}
  1765‚Üí                </div>
  1766‚Üí              </div>
  1767‚Üí            </div>
  1768‚Üí          </div>
  1769‚Üí        )}
  1770‚Üí        
  1771‚Üí        <h1 className="text-2xl font-bold mb-6">Torya</h1>
  1772‚Üí        {gconPieceId && (
  1773‚Üí          <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
  1774‚Üí            <p className="text-sm text-blue-800">
  1775‚Üí              <strong>gcon_piece_id:</strong> {gconPieceId}
  1776‚Üí              {gconPiece?.asn_sitespren_base && (
  1777‚Üí                <span className="ml-4">
  1778‚Üí                  <strong>Site:</strong> {gconPiece.asn_sitespren_base}
  1779‚Üí                </span>
  1780‚Üí              )}
  1781‚Üí            </p>
  1782‚Üí          </div>
  1783‚Üí        )}
  1784‚Üí        <WaterTable 
  1785‚Üí          gconPieceId={gconPieceId} 
  1786‚Üí          isTopAreaOpen={isTopAreaOpen}
  1787‚Üí          handleAccordionToggle={handleAccordionToggle}
  1788‚Üí          gconPiece={gconPiece}
  1789‚Üí          isRunningF22={isRunningF22}
  1790‚Üí          f22Report={f22Report}
  1791‚Üí          handleRunF22={handleRunF22}
  1792‚Üí          handleCopyPelementorCached={handleCopyPelementorCached}
  1793‚Üí          handleCopyPelementorEdits={handleCopyPelementorEdits}
  1794‚Üí          handleCopyF22Report={handleCopyF22Report}
  1795‚Üí          onGetManualImageData={manualImageDataRef}
  1796‚Üí        />
  1797‚Üí      </div>
  1798‚Üí    </div>
  1799‚Üí  );
  1800‚Üí}
```

_**Agent (claude-sonnet-4-20250514)**_

I found another complex page that needs conversion! `/torya` has similar complexity to `/tornado` but sets the `document.title` on lines 230-236. Let me convert it by creating the client component and then updating the server component:

_**Agent (claude-sonnet-4-20250514)**_

Tool use: **Write**

```tsx
'use client';

import { useState, useEffect, useRef } from 'react';
import { useAuth } from '@/app/context/AuthContext';
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
import { useSearchParams } from 'next/navigation';
import Link from 'next/link';
import WaterTable from './components/WaterTable';
import MarzdiStickyMenu from './components/marzdi_sticky_menu';

export default function ToryaClient() {
  const { user } = useAuth();
  const searchParams = useSearchParams();
  const supabase = createClientComponentClient();
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [gconPieceId, setGconPieceId] = useState<string | null>(null);
  const [gconPiece, setGconPiece] = useState<any>(null);
  const [isTopAreaOpen, setIsTopAreaOpen] = useState<boolean>(true);
  const [isPopulatingUnits, setIsPopulatingUnits] = useState(false);
  const [populateMessage, setPopulateMessage] = useState<string | null>(null);
  const [isRunningF22, setIsRunningF22] = useState(false);
  const [f22Report, setF22Report] = useState<string>('');
  
  // Image Plans Batch state
  const [imagePlansBatches, setImagePlansBatches] = useState<any[]>([]);
  const [selectedBatchId, setSelectedBatchId] = useState<string>('');
  const [isSavingBatch, setIsSavingBatch] = useState(false);

  // Compile text content state
  const [isCompilingTextContent, setIsCompilingTextContent] = useState(false);

  // Narpi pushes state
  const [narpiPushes, setNarpiPushes] = useState<any[]>([]);
  const [selectedNarpiPushes, setSelectedNarpiPushes] = useState<Set<string>>(new Set());
  const [copiedNarpiId, setCopiedNarpiId] = useState<string | null>(null);

  // Dublish function state
  const [isRunningDublish, setIsRunningDublish] = useState(false);
  const [dublishConnectionType, setDublishConnectionType] = useState<'snefuruplin' | 'rest_api' | 'api_other'>('snefuruplin');
  const [dublishProgress, setDublishProgress] = useState<string>('');
  const [dublishResult, setDublishResult] = useState<{
    success: boolean;
    wpEditorUrl?: string;
    liveUrl?: string;
    postId?: number;
    message?: string;
  } | null>(null);

  // Snoverride function state
  const [isRunningSnoverride, setIsRunningSnoverride] = useState(false);
  const [snoverrideConnectionType, setSnoverrideConnectionType] = useState<'snefuruplin' | 'rest_api' | 'api_other'>('snefuruplin');
  const [snoverrideProgress, setSnoverrideProgress] = useState<string>('');
  const [snoverrideResult, setSnoverrideResult] = useState<{
    success: boolean;
    wpEditorUrl?: string;
    liveUrl?: string;
    postId?: number;
    message?: string;
  } | null>(null);

  // Ref to access manual image data from WaterTable
  const manualImageDataRef = useRef<{ 
    urls: Map<string, string>; 
    ids: Map<string, string>; 
    checkboxes: Map<string, boolean> 
  } | null>(null);

  useEffect(() => {
    // Get gcon_piece_id from URL parameters
    const gconPieceIdParam = searchParams?.get('gcon_piece_id');
    if (gconPieceIdParam) {
      setGconPieceId(gconPieceIdParam);
      console.log('Torya: Loaded with gcon_piece_id:', gconPieceIdParam);
    }
    
    // Handle zarno1 state from URL and localStorage
    const urlParams = new URLSearchParams(window.location.search);
    const zarno1Param = urlParams.get('zarno1');
    
    // Try to get saved state from localStorage
    const savedState = localStorage.getItem('torya_zarno1_state');
    
    if (zarno1Param === 'closed') {
      setIsTopAreaOpen(false);
    } else if (zarno1Param === 'open') {
      setIsTopAreaOpen(true);
    } else if (savedState) {
      // Use saved state if no URL param
      setIsTopAreaOpen(savedState === 'open');
    }
    
    setLoading(false);
  }, [searchParams]);

  // Fetch narpi pushes when batch changes
  useEffect(() => {
    const fetchNarpiPushes = async () => {
      if (!selectedBatchId && !gconPiece?.asn_image_plan_batch_id) {
        setNarpiPushes([]);
        return;
      }

      const batchId = selectedBatchId || gconPiece?.asn_image_plan_batch_id;
      
      try {
        const { data, error } = await supabase
          .from('narpi_pushes')
          .select('id, push_name, push_status1, created_at, kareench1')
          .eq('fk_batch_id', batchId)
          .order('created_at', { ascending: false });

        if (error) {
          console.error('Error fetching narpi_pushes:', error);
        } else {
          setNarpiPushes(data || []);
        }
      } catch (error) {
        console.error('Error fetching narpi_pushes:', error);
      }
    };

    fetchNarpiPushes();
  }, [selectedBatchId, gconPiece?.asn_image_plan_batch_id]);

  // Copy kareench1 value function
  const copyNarpiKareenchValue = async (pushId: string, kareenchValue: any) => {
    try {
      const valueToString = typeof kareenchValue === 'string' 
        ? kareenchValue 
        : JSON.stringify(kareenchValue, null, 2);
      
      await navigator.clipboard.writeText(valueToString);
      setCopiedNarpiId(pushId);
      
      // Clear the copied indicator after 2 seconds
      setTimeout(() => setCopiedNarpiId(null), 2000);
    } catch (err) {
      console.error('Failed to copy kareench1 value:', err);
    }
  };

  // Fetch gcon_piece data when gconPieceId is available
  useEffect(() => {
    const fetchGconPiece = async () => {
      if (!user?.id || !gconPieceId) {
        return;
      }

      try {
        // Get user's internal ID first
        const { data: userData } = await supabase
          .from('users')
          .select('id')
          .eq('auth_id', user.id)
          .single();

        if (!userData) {
          setError('User not found');
          return;
        }

        // Fetch the gcon_piece
        const { data: gconData, error: gconError } = await supabase
          .from('gcon_pieces')
          .select('id, asn_sitespren_base, mud_title, h1title, pelementor_cached, pelementor_edits, g_post_id, asn_image_plan_batch_id')
          .eq('id', gconPieceId)
          .eq('fk_users_id', userData.id)
          .single();

        if (gconError) {
          setError('Content piece not found');
          return;
        }

        setGconPiece(gconData);
      } catch (err) {
        console.error('Error fetching gcon_piece:', err);
        setError('Failed to load content');
      }
    };

    fetchGconPiece();
  }, [user?.id, gconPieceId, supabase]);

  // Fetch images_plans_batches for current user
  useEffect(() => {
    const fetchImagePlansBatches = async () => {
      if (!user?.id) return;

      try {
        // Get user's internal ID first
        const { data: userData } = await supabase
          .from('users')
          .select('id')
          .eq('auth_id', user.id)
          .single();

        if (!userData) return;

        // Fetch images_plans_batches for this user
        const { data: batchesData, error } = await supabase
          .from('images_plans_batches')
          .select('*')
          .eq('rel_users_id', userData.id)
          .order('created_at', { ascending: false });

        if (error) {
          console.error('Error fetching images_plans_batches:', error);
          return;
        }

        setImagePlansBatches(batchesData || []);

        // Set current selected batch if gconPiece has one
        if (gconPiece?.asn_image_plan_batch_id) {
          setSelectedBatchId(gconPiece.asn_image_plan_batch_id);
        }
      } catch (err) {
        console.error('Error in fetchImagePlansBatches:', err);
      }
    };

    fetchImagePlansBatches();
  }, [user?.id, supabase, gconPiece?.asn_image_plan_batch_id]);

  // Handle accordion state change
  const handleAccordionToggle = (open: boolean) => {
    setIsTopAreaOpen(open);
    
    // Save to localStorage
    localStorage.setItem('torya_zarno1_state', open ? 'open' : 'closed');
    
    // Update URL parameter
    const url = new URL(window.location.href);
    url.searchParams.set('zarno1', open ? 'open' : 'closed');
    window.history.replaceState({}, '', url.toString());
  };

  // Handle populate nemtor_units
  const handlePopulateNemtorUnits = async () => {
    if (!gconPieceId) {
      setPopulateMessage('Error: No gcon_piece_id available');
      return;
    }

    setIsPopulatingUnits(true);
    setPopulateMessage(null);

    try {
      const response = await fetch('/api/populate-nemtor-units', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          gcon_piece_id: gconPieceId
        }),
      });

      const result = await response.json();

      if (response.ok) {
        setPopulateMessage(`‚úÖ ${result.message}`);
      } else {
        setPopulateMessage(`‚ùå Error: ${result.error}`);
      }
    } catch (error) {
      console.error('Error populating nemtor_units:', error);
      setPopulateMessage('‚ùå Error: Failed to populate nemtor_units');
    } finally {
      setIsPopulatingUnits(false);
      // Clear message after 5 seconds
      setTimeout(() => setPopulateMessage(null), 5000);
    }
  };

  // Handle f22 function
  const handleRunF22 = async () => {
    if (!gconPieceId) {
      setF22Report('Error: No gcon_piece_id available');
      return;
    }

    setIsRunningF22(true);
    setF22Report('Starting F22 processing...');

    try {
      const response = await fetch('/api/f22-nwpi-to-gcon-pusher', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          gcon_piece_id: gconPieceId
        }),
      });

      const result = await response.json();

      if (response.ok) {
        setF22Report(result.message || 'F22 function completed successfully');
        
        // Refresh the gcon_piece data to get updated values
        if (user?.id) {
          const { data: userData } = await supabase
            .from('users')
            .select('id')
            .eq('auth_id', user.id)
            .single();

          if (userData) {
            const { data: refreshedData } = await supabase
              .from('gcon_pieces')
              .select('id, asn_sitespren_base, mud_title, h1title, pelementor_cached, pelementor_edits, asn_image_plan_batch_id')
              .eq('id', gconPieceId)
              .eq('fk_users_id', userData.id)
              .single();

            if (refreshedData) {
              setGconPiece(refreshedData);
            }
          }
        }
      } else {
        setF22Report(`Error: ${result.error || 'F22 function failed'}`);
      }
    } catch (error) {
      console.error('Error running F22:', error);
      setF22Report('Error: Failed to run F22 function');
    } finally {
      setIsRunningF22(false);
    }
  };

  // Copy functions
  const handleCopyPelementorCached = () => {
    if (gconPiece?.pelementor_cached) {
      const content = typeof gconPiece.pelementor_cached === 'string' 
        ? gconPiece.pelementor_cached 
        : JSON.stringify(gconPiece.pelementor_cached, null, 2);
      navigator.clipboard.writeText(content);
    }
  };

  const handleCopyPelementorEdits = () => {
    if (gconPiece?.pelementor_edits) {
      const content = typeof gconPiece.pelementor_edits === 'string' 
        ? gconPiece.pelementor_edits 
        : JSON.stringify(gconPiece.pelementor_edits, null, 2);
      navigator.clipboard.writeText(content);
    }
  };

  const handleCopyF22Report = () => {
    if (f22Report) {
      navigator.clipboard.writeText(f22Report);
    }
  };

  // Handle saving image plan batch
  const handleSaveImagePlanBatch = async () => {
    if (!gconPieceId || !selectedBatchId) {
      alert('Please select an image plan batch first');
      return;
    }

    setIsSavingBatch(true);

    try {
      const { error } = await supabase
        .from('gcon_pieces')
        .update({ asn_image_plan_batch_id: selectedBatchId })
        .eq('id', gconPieceId);

      if (error) {
        throw error;
      }

      // Update local state
      setGconPiece((prev: any) => prev ? { ...prev, asn_image_plan_batch_id: selectedBatchId } : prev);
      
      alert('Image plan batch saved successfully!');
    } catch (error) {
      console.error('Error saving image plan batch:', error);
      alert('Failed to save image plan batch');
    } finally {
      setIsSavingBatch(false);
    }
  };

  // Helper function to recursively find and update Elementor element by ID
  const updateElementorImageById = (elementorData: any, targetElId: string, imageUrl: string, imageId: string): boolean => {
    let updated = false;
    
    // Recursive function to traverse the Elementor structure
    const traverseElements = (elements: any[]): boolean => {
      if (!Array.isArray(elements)) return false;
      
      for (const element of elements) {
        // Check if this is the target element
        if (element.id === targetElId) {
          console.log(`üéØ Found target element ${targetElId}, checking for image settings...`);
          // Update image data in this element's settings
          if (element.settings) {
            // Handle different image property patterns
            if (element.settings.image) {
              if (typeof element.settings.image === 'object') {
                element.settings.image.url = imageUrl;
                element.settings.image.id = parseInt(imageId);
              } else {
                element.settings.image = {
                  url: imageUrl,
                  id: parseInt(imageId)
                };
              }
              updated = true;
            }
            
            // Handle background image
            if (element.settings.background_image) {
              if (typeof element.settings.background_image === 'object') {
                element.settings.background_image.url = imageUrl;
                element.settings.background_image.id = parseInt(imageId);
              } else {
                element.settings.background_image = {
                  url: imageUrl,
                  id: parseInt(imageId)
                };
              }
              updated = true;
            }
            
            // Handle other common image properties
            ['background_background', '_background_background'].forEach(prop => {
              if (element.settings[prop] === 'classic' && element.settings[prop + '_image']) {
                if (typeof element.settings[prop + '_image'] === 'object') {
                  element.settings[prop + '_image'].url = imageUrl;
                  element.settings[prop + '_image'].id = parseInt(imageId);
                } else {
                  element.settings[prop + '_image'] = {
                    url: imageUrl,
                    id: parseInt(imageId)
                  };
                }
                updated = true;
              }
            });
          }
          
          return true; // Found and processed the target element
        }
        
        // Recursively check child elements
        if (element.elements && Array.isArray(element.elements)) {
          if (traverseElements(element.elements)) {
            updated = true;
          }
        }
      }
      
      return updated;
    };
    
    // Start traversal from root
    if (Array.isArray(elementorData)) {
      return traverseElements(elementorData);
    }
    
    return false;
  };

  // Handle compile new_desired_text_content into pelementor_edits
  const handleCompileTextContent = async () => {
    if (!gconPieceId || !gconPiece) {
      alert('No gcon_piece found to process');
      return;
    }

    if (!gconPiece.pelementor_cached) {
      alert('No pelementor_cached data found to use as starting point');
      return;
    }

    setIsCompilingTextContent(true);

    try {
      // Step 1: Start with pelementor_cached as our base for pelementor_edits
      // Ensure we're working with a string, not an object
      let pelementorEditsContent = typeof gconPiece.pelementor_cached === 'string' 
        ? gconPiece.pelementor_cached 
        : JSON.stringify(gconPiece.pelementor_cached);

      // Step 2: Fetch all nemtor_units for this gcon_piece
      const { data: nemtorUnits, error: nemtorError } = await supabase
        .from('nemtor_units')
        .select('unit_id, full_text_cached, full_text_edits, has_img_slot, el_id')
        .eq('fk_gcon_piece_id', gconPieceId);

      if (nemtorError) {
        console.error('Error fetching nemtor_units:', nemtorError);
        throw nemtorError;
      }

      if (!nemtorUnits || nemtorUnits.length === 0) {
        alert('No nemtor_units found for this gcon_piece');
        return;
      }

      // Step 3: Process units that have full_text_edits values
      let replacementsCount = 0;
      const replacements: { original: string; replacement: string; unitId: string }[] = [];

      nemtorUnits.forEach(unit => {
        // Only process if full_text_edits has a real value (not null, empty, or whitespace)
        if (unit.full_text_edits && unit.full_text_edits.trim() !== '') {
          // Only process if we also have original full_text_cached to replace
          if (unit.full_text_cached && unit.full_text_cached.trim() !== '') {
            // Replace full_text_cached with full_text_edits in pelementorEditsContent
            const originalText = unit.full_text_cached;
            const newText = unit.full_text_edits;
            
            // Check if the original text exists in pelementorEditsContent
            if (pelementorEditsContent.includes(originalText)) {
              pelementorEditsContent = pelementorEditsContent.replace(originalText, newText);
              replacementsCount++;
              replacements.push({
                original: originalText.substring(0, 100) + (originalText.length > 100 ? '...' : ''),
                replacement: newText.substring(0, 100) + (newText.length > 100 ? '...' : ''),
                unitId: unit.unit_id
              });
            }
          }
        }
      });

      // Step 4: Process manual image inputs (includes active checkboxes for man_img_url and man_img_id)
      let imageReplacementsCount = 0;
      if (manualImageDataRef.current) {
        const { urls, ids, checkboxes } = manualImageDataRef.current;
        
        try {
          // Parse the Elementor JSON to work with structured data
          const elementorData = JSON.parse(pelementorEditsContent);
          
          nemtorUnits.forEach(unit => {
            // Only process units that have has_img_slot = true AND checkbox is checked
            if (unit.has_img_slot === true && checkboxes.get(unit.unit_id)) {
              const manualUrl = urls.get(unit.unit_id);
              const manualId = ids.get(unit.unit_id);
              
              // Only proceed if we have both URL and ID and el_id
              if (manualUrl && manualUrl.trim() !== '' && manualId && manualId.trim() !== '' && unit.el_id) {
                console.log(`üñºÔ∏è Processing image for unit ${unit.unit_id}, el_id: ${unit.el_id}, URL: ${manualUrl}, ID: ${manualId}`);
                
                // Find and update the specific element by el_id
                const updated = updateElementorImageById(elementorData, unit.el_id, manualUrl, manualId);
                
                if (updated) {
                  console.log(`‚úÖ Successfully updated image for element ${unit.el_id}`);
                  imageReplacementsCount++;
                  replacements.push({
                    original: `Image in element ${unit.el_id}`,
                    replacement: `URL: ${manualUrl.substring(0, 50)}${manualUrl.length > 50 ? '...' : ''}, ID: ${manualId}`,
                    unitId: unit.unit_id
                  });
                } else {
                  console.log(`‚ùå Could not find/update element with ID: ${unit.el_id}`);
                }
              } else {
                console.log(`‚ö†Ô∏è Skipping unit ${unit.unit_id}: missing data - URL: ${!!manualUrl}, ID: ${!!manualId}, el_id: ${!!unit.el_id}`);
              }
            }
          });
          
          // Convert back to string
          pelementorEditsContent = JSON.stringify(elementorData);
          
        } catch (jsonError) {
          console.error('Error parsing Elementor JSON:', jsonError);
          // Fall back to string-based approach if JSON parsing fails
          console.log('Falling back to string-based image replacement...');
        }
      }

      // Step 5: Update pelementor_edits in database
      // Convert back to object if original was an object, or keep as string
      const pelementorEditsForDb = typeof gconPiece.pelementor_cached === 'object' 
        ? JSON.parse(pelementorEditsContent)
        : pelementorEditsContent;

      const { error: updateError } = await supabase
        .from('gcon_pieces')
        .update({ pelementor_edits: pelementorEditsForDb })
        .eq('id', gconPieceId);

      if (updateError) {
        console.error('Error updating pelementor_edits:', updateError);
        throw updateError;
      }

      // Step 6: Update local state
      setGconPiece((prev: any) => prev ? { ...prev, pelementor_edits: pelementorEditsForDb } : prev);

      // Step 7: Show success message with details
      const totalReplacements = replacementsCount + imageReplacementsCount;
      const successMessage = `Successfully compiled content!\n\nText replacements: ${replacementsCount}\nImage replacements: ${imageReplacementsCount}\nTotal replacements: ${totalReplacements}\n\n` +
        replacements.map(r => `‚Ä¢ Unit ${r.unitId.substring(0, 8)}...\n  FROM: ${r.original}\n  TO: ${r.replacement}`).join('\n\n');
      
      alert(successMessage);

    } catch (error) {
      console.error('Error compiling text content:', error);
      alert('Failed to compile text content. Please try again.');
    } finally {
      setIsCompilingTextContent(false);
    }
  };

  // Handle run dublish function
  const handleRunDublish = async () => {
    if (!gconPieceId || !gconPiece) {
      alert('No gcon_piece found to process');
      return;
    }

    if (!gconPiece.pelementor_edits) {
      alert('No pelementor_edits data found. Please compile text content first.');
      return;
    }

    if (!gconPiece.asn_sitespren_base) {
      alert('No asn_sitespren_base found. Cannot determine target WordPress site.');
      return;
    }

    setIsRunningDublish(true);
    setDublishProgress('Initializing...');
    setDublishResult(null);

    try {
      // Step 1: Prepare Elementor page data
      setDublishProgress('Preparing Elementor page data...');
      
      const pageTitle = gconPiece.h1title || gconPiece.mud_title || 'New Elementor Page';
      const pageSlug = gconPiece.pageslug || gconPiece.post_name || 'new-elementor-page';
      const elementorData = gconPiece.pelementor_edits;

      // Step 2: Create WordPress post
      setDublishProgress('Creating WordPress post...');
      
      let apiResponse;
      
      switch (dublishConnectionType) {
        case 'snefuruplin':
          // Use Snefuruplin WP Plugin
          setDublishProgress('Connecting via Snefuruplin WP Plugin...');
          apiResponse = await createElementorPageViaSnefuruplin({
            siteUrl: gconPiece.asn_sitespren_base,
            title: pageTitle,
            slug: pageSlug,
            elementorData: elementorData,
            gconPieceId: gconPieceId
          });
          break;
          
        case 'rest_api':
          // Use WordPress REST API
          setDublishProgress('Connecting via WordPress REST API...');
          apiResponse = await createElementorPageViaRestAPI({
            siteUrl: gconPiece.asn_sitespren_base,
            title: pageTitle,
            slug: pageSlug,
            elementorData: elementorData,
            gconPieceId: gconPieceId
          });
          break;
          
        case 'api_other':
          // Use other API method
          setDublishProgress('Connecting via alternative API...');
          apiResponse = await createElementorPageViaOtherAPI({
            siteUrl: gconPiece.asn_sitespren_base,
            title: pageTitle,
            slug: pageSlug,
            elementorData: elementorData,
            gconPieceId: gconPieceId
          });
          break;
          
        default:
          throw new Error('Invalid connection type selected');
      }

      // Step 3: Process response
      setDublishProgress('Processing response...');
      
      if (apiResponse.success) {
        const wpEditorUrl = `https://${gconPiece.asn_sitespren_base}/wp-admin/post.php?post=${apiResponse.postId}&action=elementor`;
        const liveUrl = `https://${gconPiece.asn_sitespren_base}/${pageSlug}`;
        
        setDublishResult({
          success: true,
          wpEditorUrl,
          liveUrl,
          postId: apiResponse.postId,
          message: `Successfully created Elementor page "${pageTitle}"`
        });
        
        setDublishProgress('‚úÖ Page created successfully!');
      } else {
        throw new Error(apiResponse.message || 'Failed to create page');
      }

    } catch (error) {
      console.error('Error running dublish function:', error);
      setDublishResult({
        success: false,
        message: error instanceof Error ? error.message : 'Unknown error occurred'
      });
      setDublishProgress('‚ùå Failed to create page');
    } finally {
      setIsRunningDublish(false);
    }
  };

  // Snefuruplin WP Plugin implementation
  const createElementorPageViaSnefuruplin = async (params: {
    siteUrl: string;
    title: string;
    slug: string;
    elementorData: string;
    gconPieceId: string;
  }) => {
    // This would connect to your custom WordPress plugin
    const response = await fetch('/api/dublish-create-elementor-page', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        site_url: params.siteUrl,
        post_title: params.title,
        post_name: params.slug,
        post_status: 'publish',
        post_type: 'page',
        elementor_data: params.elementorData,
        gcon_piece_id: params.gconPieceId,
        // Elementor-specific meta fields
        meta_input: {
          '_elementor_edit_mode': 'builder',
          '_elementor_template_type': 'wp-page',
          '_elementor_version': '3.17.0',
          '_elementor_pro_version': '3.17.0',
          '_elementor_data': params.elementorData,
          '_elementor_page_settings': JSON.stringify({
            "custom_css": "",
            "page_title": "hide",
            "page_description": "hide"
          }),
          '_wp_page_template': 'default'
        }
      })
    });

    return await response.json();
  };

  // WordPress REST API implementation
  const createElementorPageViaRestAPI = async (params: {
    siteUrl: string;
    title: string;
    slug: string;
    elementorData: string;
    gconPieceId: string;
  }) => {
    // Step 1: Create the post via REST API
    const createPostResponse = await fetch(`https://${params.siteUrl}/wp-json/wp/v2/pages`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer YOUR_WP_TOKEN', // You'll need to implement auth
      },
      body: JSON.stringify({
        title: params.title,
        slug: params.slug,
        status: 'publish',
        template: 'elementor_header_footer'
      })
    });

    const post = await createPostResponse.json();
    
    if (!createPostResponse.ok) {
      throw new Error(post.message || 'Failed to create post');
    }

    // Step 2: Add Elementor meta data
    const metaUpdates = [
      { key: '_elementor_edit_mode', value: 'builder' },
      { key: '_elementor_template_type', value: 'wp-page' },
      { key: '_elementor_version', value: '3.17.0' },
      { key: '_elementor_data', value: params.elementorData },
      { key: '_elementor_page_settings', value: JSON.stringify({
        "custom_css": "",
        "page_title": "hide", 
        "page_description": "hide"
      }) }
    ];

    for (const meta of metaUpdates) {
      await fetch(`https://${params.siteUrl}/wp-json/wp/v2/pages/${post.id}/meta`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer YOUR_WP_TOKEN',
        },
        body: JSON.stringify(meta)
      });
    }

    return {
      success: true,
      postId: post.id,
      message: 'Page created successfully via REST API'
    };
  };

  // Alternative API implementation
  const createElementorPageViaOtherAPI = async (params: {
    siteUrl: string;
    title: string;
    slug: string;
    elementorData: string;
    gconPieceId: string;
  }) => {
    // This could be a custom API endpoint you create
    const response = await fetch('/api/wordpress/create-elementor-page', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        target_site: params.siteUrl,
        page_data: {
          post_title: params.title,
          post_name: params.slug,
          post_status: 'publish',
          post_type: 'page',
          post_content: '', // Elementor uses meta, not content
          meta_input: {
            '_elementor_edit_mode': 'builder',
            '_elementor_template_type': 'wp-page',
            '_elementor_version': '3.17.0',
            '_elementor_data': params.elementorData,
            '_wp_page_template': 'default'
          }
        },
        gcon_piece_id: params.gconPieceId
      })
    });

    return await response.json();
  };

  // Handle run snoverride function
  const handleRunSnoverride = async () => {
    if (!gconPieceId || !gconPiece) {
      alert('No gcon_piece found to process');
      return;
    }

    if (!gconPiece.pelementor_edits) {
      alert('No pelementor_edits data found. Please compile text content first.');
      return;
    }

    if (!gconPiece.asn_sitespren_base) {
      alert('No asn_sitespren_base found. Cannot determine target WordPress site.');
      return;
    }

    if (!gconPiece.g_post_id) {
      alert('No g_post_id found. Cannot identify which WordPress post to update.');
      return;
    }

    setIsRunningSnoverride(true);
    setSnoverrideProgress('Initializing...');
    setSnoverrideResult(null);

    try {
      // Step 1: Prepare update data
      setSnoverrideProgress('Preparing Elementor page update...');
      
      const pageTitle = gconPiece.h1title || gconPiece.mud_title || 'Updated Elementor Page';
      const elementorData = gconPiece.pelementor_edits;
      const postId = gconPiece.g_post_id;

      // Step 2: Update WordPress post
      setSnoverrideProgress('Updating WordPress post...');
      
      let apiResponse;
      
      switch (snoverrideConnectionType) {
        case 'snefuruplin':
          // Use Snefuruplin WP Plugin
          setSnoverrideProgress('Connecting via Snefuruplin WP Plugin...');
          apiResponse = await updateElementorPageViaSnefuruplin({
            siteUrl: gconPiece.asn_sitespren_base,
            postId: postId,
            title: pageTitle,
            elementorData: elementorData,
            gconPieceId: gconPieceId
          });
          break;
          
        case 'rest_api':
          // Use WordPress REST API
          setSnoverrideProgress('Connecting via WordPress REST API...');
          apiResponse = await updateElementorPageViaRestAPI({
            siteUrl: gconPiece.asn_sitespren_base,
            postId: postId,
            title: pageTitle,
            elementorData: elementorData,
            gconPieceId: gconPieceId
          });
          break;
          
        case 'api_other':
          // Use other API method
          setSnoverrideProgress('Connecting via alternative API...');
          apiResponse = await updateElementorPageViaOtherAPI({
            siteUrl: gconPiece.asn_sitespren_base,
            postId: postId,
            title: pageTitle,
            elementorData: elementorData,
            gconPieceId: gconPieceId
          });
          break;
          
        default:
          throw new Error('Invalid connection type selected');
      }

      // Step 3: Process response
      setSnoverrideProgress('Processing response...');
      
      if (apiResponse.success) {
        const wpEditorUrl = `https://${gconPiece.asn_sitespren_base}/wp-admin/post.php?post=${postId}&action=elementor`;
        const liveUrl = `https://${gconPiece.asn_sitespren_base}/?p=${postId}`;
        
        setSnoverrideResult({
          success: true,
          wpEditorUrl,
          liveUrl,
          postId: postId,
          message: `Successfully updated Elementor page "${pageTitle}"`
        });
        
        setSnoverrideProgress('‚úÖ Page updated successfully!');
      } else {
        throw new Error(apiResponse.message || 'Failed to update page');
      }

    } catch (error) {
      console.error('Error running snoverride function:', error);
      setSnoverrideResult({
        success: false,
        message: error instanceof Error ? error.message : 'Unknown error occurred'
      });
      setSnoverrideProgress('‚ùå Failed to update page');
    } finally {
      setIsRunningSnoverride(false);
    }
  };

  // Snefuruplin WP Plugin update implementation
  const updateElementorPageViaSnefuruplin = async (params: {
    siteUrl: string;
    postId: number;
    title: string;
    elementorData: string;
    gconPieceId: string;
  }) => {
    const response = await fetch('/api/snoverride-update-elementor-page', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        site_url: params.siteUrl,
        post_id: params.postId,
        post_title: params.title,
        elementor_data: params.elementorData,
        gcon_piece_id: params.gconPieceId,
        // Update only the elementor data and title
        update_fields: {
          post_title: params.title,
          meta_input: {
            '_elementor_data': params.elementorData,
            '_elementor_edit_mode': 'builder',
            '_elementor_version': '3.17.0'
          }
        }
      })
    });

    return await response.json();
  };

  // WordPress REST API update implementation
  const updateElementorPageViaRestAPI = async (params: {
    siteUrl: string;
    postId: number;
    title: string;
    elementorData: string;
    gconPieceId: string;
  }) => {
    // Step 1: Update the post via REST API
    const updatePostResponse = await fetch(`https://${params.siteUrl}/wp-json/wp/v2/pages/${params.postId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer YOUR_WP_TOKEN', // You'll need to implement auth
      },
      body: JSON.stringify({
        title: params.title
      })
    });

    const post = await updatePostResponse.json();
    
    if (!updatePostResponse.ok) {
      throw new Error(post.message || 'Failed to update post');
    }

    // Step 2: Update Elementor meta data
    const metaUpdates = [
      { key: '_elementor_data', value: params.elementorData },
      { key: '_elementor_edit_mode', value: 'builder' },
      { key: '_elementor_version', value: '3.17.0' }
    ];

    for (const meta of metaUpdates) {
      await fetch(`https://${params.siteUrl}/wp-json/wp/v2/pages/${params.postId}/meta`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer YOUR_WP_TOKEN',
        },
        body: JSON.stringify(meta)
      });
    }

    return {
      success: true,
      postId: params.postId,
      message: 'Page updated successfully via REST API'
    };
  };

  // Alternative API update implementation
  const updateElementorPageViaOtherAPI = async (params: {
    siteUrl: string;
    postId: number;
    title: string;
    elementorData: string;
    gconPieceId: string;
  }) => {
    const response = await fetch('/api/wordpress/update-elementor-page', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        target_site: params.siteUrl,
        post_id: params.postId,
        update_data: {
          post_title: params.title,
          meta_input: {
            '_elementor_data': params.elementorData,
            '_elementor_edit_mode': 'builder',
            '_elementor_version': '3.17.0'
          }
        },
        gcon_piece_id: params.gconPieceId
      })
    });

    return await response.json();
  };

  if (!user) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <p className="text-gray-500">Please log in to access this page.</p>
      </div>
    );
  }

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
          <p className="mt-2 text-gray-600">Loading...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <p className="text-red-600">Error: {error}</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Sticky Menu Component */}
      <MarzdiStickyMenu h1Title={gconPiece?.h1title} />
      
      <div className="p-4">
        <div className="mb-4 flex items-center gap-4">
          <Link href="/dashboard" className="text-blue-600 hover:text-blue-800">
            ‚Üê Back to Dashboard
          </Link>
          <button
            className={`px-4 py-2 font-medium rounded-md transition-colors ${
              isPopulatingUnits
                ? 'bg-gray-400 cursor-not-allowed text-white'
                : 'bg-purple-600 hover:bg-purple-700 text-white'
            }`}
            onClick={handlePopulateNemtorUnits}
            disabled={isPopulatingUnits || !gconPieceId}
          >
            {isPopulatingUnits ? 'Populating...' : 'handlePopulateNemtorUnit'}
          </button>
        </div>
        
        {/* Populate feedback message */}
        {populateMessage && (
          <div className={`mb-4 p-3 rounded-md ${
            populateMessage.startsWith('‚úÖ') 
              ? 'bg-green-100 border border-green-400 text-green-700'
              : 'bg-red-100 border border-red-400 text-red-700'
          }`}>
            {populateMessage}
          </div>
        )}
        
        {/* Cloned Areas from Mesagen Page */}
        {gconPieceId && (
          <div className="mb-4">
            <div className="flex items-start gap-4" style={{ marginTop: '10px' }}>
              {/* AREA 1: Info Box - Cloned from mesagen */}
              <div className="bg-gray-50 border border-gray-300 rounded-lg p-4" style={{ width: '450px' }}>
                <div className="mb-3">
                  <Link href="/gconjar1" className="text-blue-600 hover:text-blue-800">
                    ‚Üê Back to GconJar1
                  </Link>
                </div>
                
                <div className="mb-3">
                  <Link href={`/torya?gcon_piece_id=${gconPieceId}`} className="text-blue-600 hover:text-blue-800">
                    -- Visit /torya --
                  </Link>
                </div>
                
                <div className="mb-3 text-sm text-gray-600">
                  <strong>gcon_pieces.id:</strong> {gconPieceId}
                </div>

                {/* asn_sitespren_base */}
                <div className="mb-3">
                  <label className="block text-sm font-bold text-gray-700 mb-1">
                    asn_sitespren_base
                  </label>
                  <div className="w-full px-3 py-2 border border-gray-300 rounded bg-gray-50 text-sm">
                    {gconPiece?.asn_sitespren_base || 'Not set'}
                  </div>
                </div>

                {/* post_name */}
                <div className="mb-3">
                  <label className="block text-sm font-bold text-gray-700 mb-1">
                    post_name
                  </label>
                  <div className="flex items-center gap-1 p-2 bg-gray-900 text-green-400 rounded font-mono text-sm border">
                    <button
                      onClick={() => {
                        if (gconPiece?.asn_sitespren_base && gconPiece?.post_name) {
                          window.open(`https://${gconPiece.asn_sitespren_base}/${gconPiece.post_name}`, '_blank');
                        }
                      }}
                      disabled={!gconPiece?.post_name || !gconPiece?.asn_sitespren_base}
                      className="w-6 h-6 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white rounded flex items-center justify-center"
                      title="Open in new tab"
                    >
                      ‚Üó
                    </button>
                    <button
                      onClick={() => navigator.clipboard.writeText(gconPiece?.post_name || '')}
                      className="w-6 h-6 bg-gray-600 hover:bg-gray-700 text-white rounded flex items-center justify-center"
                      title="Copy to clipboard"
                    >
                      üìã
                    </button>
                    <span className="flex-1 px-2">
                      {gconPiece?.post_name || ''}
                    </span>
                  </div>
                </div>

                {/* pageslug */}
                <div className="mb-3">
                  <label className="block text-sm font-bold text-gray-700 mb-1">
                    pageslug
                  </label>
                  <div className="flex items-center gap-1 p-2 bg-gray-900 text-green-400 rounded font-mono text-sm border">
                    <button
                      onClick={() => {
                        if (gconPiece?.asn_sitespren_base && gconPiece?.pageslug) {
                          window.open(`https://${gconPiece.asn_sitespren_base}/${gconPiece.pageslug}`, '_blank');
                        }
                      }}
                      disabled={!gconPiece?.pageslug || !gconPiece?.asn_sitespren_base}
                      className="w-6 h-6 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white rounded flex items-center justify-center"
                      title="Open in new tab"
                    >
                      ‚Üó
                    </button>
                    <button
                      onClick={() => navigator.clipboard.writeText(gconPiece?.pageslug || '')}
                      className="w-6 h-6 bg-gray-600 hover:bg-gray-700 text-white rounded flex items-center justify-center"
                      title="Copy to clipboard"
                    >
                      üìã
                    </button>
                    <span className="flex-1 px-2">
                      {gconPiece?.pageslug || ''}
                    </span>
                  </div>
                </div>

                {/* pageurl */}
                <div className="mb-3">
                  <label className="block text-sm font-bold text-gray-700 mb-1">
                    pageurl
                  </label>
                  <div className="flex items-center gap-1 p-2 bg-gray-900 text-green-400 rounded font-mono text-sm border">
                    <button
                      onClick={() => {
                        if (gconPiece?.pageurl) {
                          window.open(gconPiece.pageurl, '_blank');
                        }
                      }}
                      disabled={!gconPiece?.pageurl}
                      className="w-6 h-6 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white rounded flex items-center justify-center"
                      title="Open in new tab"
                    >
                      ‚Üó
                    </button>
                    <button
                      onClick={() => navigator.clipboard.writeText(gconPiece?.pageurl || '')}
                      className="w-6 h-6 bg-gray-600 hover:bg-gray-700 text-white rounded flex items-center justify-center"
                      title="Copy to clipboard"
                    >
                      üìã
                    </button>
                    <span className="flex-1 px-2">
                      {gconPiece?.pageurl || ''}
                    </span>
                  </div>
                </div>
              </div>

              {/* AREA 2: Image Plans Batch Box - Cloned from mesagen */}
              <div className="bg-gray-50 border border-gray-300 rounded-lg p-4" style={{ width: '450px' }}>
                <div className="mb-3">
                  <div className="flex items-center justify-between mb-2">
                    <label className="text-sm font-bold text-gray-700">
                      asn_image_plan_batch_id
                    </label>
                    <button
                      onClick={() => {
                        // Placeholder - waiting for backend functionality instructions
                        console.log('Create new batch clicked');
                      }}
                      className="rounded"
                      style={{
                        backgroundColor: '#d3d3d3', // light gray
                        color: '#4a4a4a', // dark gray
                        fontSize: '13px',
                        padding: '3px 8px'
                      }}
                    >
                      create new batch
                    </button>
                  </div>
                  <select
                    className="w-full px-3 py-2 border border-gray-300 rounded bg-white text-sm"
                    value={selectedBatchId}
                    onChange={(e) => setSelectedBatchId(e.target.value)}
                  >
                    <option value="">Select image plan batch...</option>
                    {imagePlansBatches.map((batch) => (
                      <option key={batch.id} value={batch.id}>
                        {batch.batch_name || `Batch ${batch.id.substring(0, 8)}...`}
                      </option>
                    ))}
                  </select>
                </div>
                
                <div className="mt-4 flex gap-2">
                  <button
                    onClick={handleSaveImagePlanBatch}
                    disabled={isSavingBatch || !selectedBatchId}
                    className="px-4 py-2 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed"
                    style={{
                      backgroundColor: '#000000',
                      fontSize: '16px'
                    }}
                  >
                    {isSavingBatch ? 'Saving...' : 'save'}
                  </button>
                  
                  {/* Open Batch Button - Show if batch is selected or assigned */}
                  {(selectedBatchId || gconPiece?.asn_image_plan_batch_id) && (
                    <a
                      href={`https://snef.me/bin34/tebnar2?batchid=${selectedBatchId || gconPiece?.asn_image_plan_batch_id}`}
                      className="px-4 py-2 rounded inline-block text-center"
                      style={{
                        backgroundColor: '#009bff', // bestlinkcol
                        fontSize: '16px',
                        fontWeight: 'bold',
                        color: '#000',
                        border: '2px solid #000',
                        textDecoration: 'none'
                      }}
                    >
                      open batch in /tebnar2
                    </a>
                  )}
                </div>

                {/* Narpi Pushes Table */}
                {(selectedBatchId || gconPiece?.asn_image_plan_batch_id) && narpiPushes.length > 0 && (
                  <div className="mt-4">
                    <div className="overflow-x-auto rounded border border-gray-300" style={{ maxWidth: '440px' }}>
                      <table className="min-w-full" style={{ fontSize: '14px' }}>
                        <thead>
                          <tr className="bg-gray-100">
                            <th style={{ width: '30px', padding: '3px', minWidth: '30px' }} className="text-left font-bold">
                              <input
                                type="checkbox"
                                checked={selectedNarpiPushes.size === narpiPushes.length && narpiPushes.length > 0}
                                onChange={(e) => {
                                  if (e.target.checked) {
                                    setSelectedNarpiPushes(new Set(narpiPushes.map(p => p.id)));
                                  } else {
                                    setSelectedNarpiPushes(new Set());
                                  }
                                }}
                              />
                            </th>
                            <th style={{ width: '200px', padding: '3px', minWidth: '200px' }} className="text-left font-bold">kareench1</th>
                            <th style={{ width: '60px', padding: '3px', minWidth: '60px' }} className="text-left font-bold">id</th>
                            <th style={{ width: '120px', padding: '3px', minWidth: '120px' }} className="text-left font-bold">push_name</th>
                            <th style={{ width: '80px', padding: '3px', minWidth: '80px' }} className="text-left font-bold">push_status1</th>
                            <th style={{ width: '60px', padding: '3px', minWidth: '60px' }} className="text-left font-bold">created_at</th>
                          </tr>
                        </thead>
                        <tbody>
                          {narpiPushes.map((push) => (
                            <tr key={push.id} className="border-t border-gray-200 hover:bg-gray-50">
                              <td style={{ padding: '3px' }}>
                                <div style={{ height: '19px' }} className="flex items-center">
                                  <input
                                    type="checkbox"
                                    checked={selectedNarpiPushes.has(push.id)}
                                    onChange={(e) => {
                                      const newSelected = new Set(selectedNarpiPushes);
                                      if (e.target.checked) {
                                        newSelected.add(push.id);
                                      } else {
                                        newSelected.delete(push.id);
                                      }
                                      setSelectedNarpiPushes(newSelected);
                                    }}
                                  />
                                </div>
                              </td>
                              <td style={{ padding: '3px' }}>
                                <div style={{ height: '19px' }} className="flex items-center space-x-1">
                                  <div style={{ fontSize: '11px' }}>
                                    {push.kareench1 && Array.isArray(push.kareench1) ? (
                                      <div className="flex space-x-1">
                                        {(() => {
                                          const results = push.kareench1;
                                          const total = results.length;
                                          const success = results.filter((r: any) => r.nupload_status1 === 'success').length;
                                          const failed = results.filter((r: any) => r.nupload_status1 === 'failed').length;
                                          
                                          return (
                                            <>
                                              <span className="bg-blue-100 text-blue-800 px-1 rounded text-xs">T:{total}</span>
                                              <span className="bg-green-100 text-green-800 px-1 rounded text-xs">‚úì{success}</span>
                                              <span className="bg-red-100 text-red-800 px-1 rounded text-xs">‚úó{failed}</span>
                                            </>
                                          );
                                        })()}
                                      </div>
                                    ) : push.kareench1 ? (
                                      <div className="truncate text-xs" style={{ maxWidth: '120px' }}>
                                        {typeof push.kareench1 === 'string' 
                                          ? (push.kareench1.length > 20 ? `${push.kareench1.substring(0, 20)}...` : push.kareench1)
                                          : JSON.stringify(push.kareench1).length > 20 
                                            ? `${JSON.stringify(push.kareench1).substring(0, 20)}...`
                                            : JSON.stringify(push.kareench1)
                                        }
                                      </div>
                                    ) : (
                                      <span className="text-gray-400 italic text-xs">No data</span>
                                    )}
                                  </div>
                                  {push.kareench1 && (
                                    <button
                                      onClick={() => copyNarpiKareenchValue(push.id, push.kareench1)}
                                      className={`px-1 py-0.5 text-xs rounded ${
                                        copiedNarpiId === push.id
                                          ? 'text-green-800 bg-green-100'
                                          : 'text-gray-600 bg-gray-100 hover:bg-gray-200'
                                      }`}
                                      style={{ fontSize: '10px' }}
                                    >
                                      {copiedNarpiId === push.id ? '‚úì' : 'Copy'}
                                    </button>
                                  )}
                                </div>
                              </td>
                              <td style={{ padding: '3px' }}>
                                <div style={{ height: '19px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                  {push.id.substring(0, 8)}...
                                </div>
                              </td>
                              <td style={{ padding: '3px' }}>
                                <div style={{ height: '19px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                  {push.push_name || '-'}
                                </div>
                              </td>
                              <td style={{ padding: '3px' }}>
                                <div style={{ height: '19px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                  {push.push_status1 || '-'}
                                </div>
                              </td>
                              <td style={{ padding: '3px' }}>
                                <div style={{ height: '19px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                  {new Date(push.created_at).toLocaleDateString('en-US', { month: '2-digit', day: '2-digit' })}
                                </div>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}

                {/* Open Narpo1 Button - Show if batch is selected or assigned */}
                {(selectedBatchId || gconPiece?.asn_image_plan_batch_id) && (
                  <div className="mt-3">
                    <a
                      href={`https://snef.me/bin42/narpo1?fk_batch_id=${selectedBatchId || gconPiece?.asn_image_plan_batch_id}`}
                      className="px-4 py-2 rounded inline-block text-center"
                      style={{
                        backgroundColor: '#009bff', // bestlinkcol
                        fontSize: '16px',
                        fontWeight: 'bold',
                        color: '#000',
                        border: '2px solid #000',
                        textDecoration: 'none'
                      }}
                    >
                      open /narpo1
                    </a>
                  </div>
                )}
              </div>

              {/* NEW AREA 3: Dublish Function Box */}
              <div className="bg-gray-50 border border-gray-300 rounded-lg p-4" style={{ width: '450px' }}>
                <div className="mb-3">
                  <strong className="text-sm font-bold text-gray-700">
                    Publish new elementor page using dublish function
                  </strong>
                </div>
                
                <hr className="my-3 border-gray-300" />
                
                <div className="mb-3">
                  <button
                    onClick={handleCompileTextContent}
                    disabled={isCompilingTextContent || !gconPiece?.pelementor_cached}
                    className={`w-full px-4 py-2 text-white rounded transition-colors ${
                      isCompilingTextContent || !gconPiece?.pelementor_cached
                        ? 'bg-gray-400 cursor-not-allowed'
                        : 'bg-black hover:bg-gray-800'
                    }`}
                    style={{
                      fontSize: '14px'
                    }}
                  >
                    {isCompilingTextContent ? 'Compiling...' : 'compile new_desired_text_content into pelementor_edits'}
                  </button>
                  <p className="text-xs text-gray-600 mt-2 italic">
                    (includes active checkboxes for man_img_url and man_img_id)
                  </p>
                </div>
                
                <hr className="my-3 border-gray-300" />
                
                <div className="mb-3">
                  <button
                    onClick={() => alert('compile new_desired_image_content into pelementor_edits - functionality coming soon')}
                    className="w-full px-4 py-2 text-white rounded"
                    style={{
                      backgroundColor: '#000000',
                      fontSize: '14px'
                    }}
                  >
                    compile new_desired_image_content into pelementor_edits
                  </button>
                </div>
                
                <hr className="my-3 border-gray-300" />
                
                <div className="mb-3">
                  <button
                    onClick={handleRunDublish}
                    disabled={isRunningDublish || !gconPiece?.pelementor_edits || !gconPiece?.asn_sitespren_base}
                    className={`w-full px-4 py-2 text-white rounded transition-colors ${
                      isRunningDublish || !gconPiece?.pelementor_edits || !gconPiece?.asn_sitespren_base
                        ? 'bg-gray-400 cursor-not-allowed'
                        : 'bg-black hover:bg-gray-800'
                    }`}
                    style={{
                      fontSize: '14px'
                    }}
                  >
                    {isRunningDublish ? (
                      <div className="flex items-center justify-center gap-2">
                        <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                        Publishing...
                      </div>
                    ) : (
                      'run dublish function'
                    )}
                  </button>
                </div>

                {/* Connection Type Selector */}
                <div className="mb-3">
                  <label className="block text-xs font-bold text-gray-700 mb-2">
                    Connection Type:
                  </label>
                  <select
                    value={dublishConnectionType}
                    onChange={(e) => setDublishConnectionType(e.target.value as 'snefuruplin' | 'rest_api' | 'api_other')}
                    disabled={isRunningDublish}
                    className="w-full px-3 py-2 border border-gray-300 rounded text-sm bg-white disabled:bg-gray-100"
                  >
                    <option value="snefuruplin">Snefuruplin WP Plugin</option>
                    <option value="rest_api">REST API</option>
                    <option value="api_other">API (other)</option>
                  </select>
                </div>

                {/* Progress Indicator */}
                {dublishProgress && (
                  <div className="mb-3 p-2 bg-blue-50 border border-blue-200 rounded">
                    <div className="text-xs text-blue-800">
                      <strong>Status:</strong> {dublishProgress}
                    </div>
                    {isRunningDublish && (
                      <div className="mt-2">
                        <div className="w-full bg-blue-200 rounded-full h-2">
                          <div className="bg-blue-600 h-2 rounded-full animate-pulse" style={{ width: '60%' }}></div>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Results Section */}
                {dublishResult && (
                  <div className={`mb-3 p-3 border rounded ${
                    dublishResult.success 
                      ? 'bg-green-50 border-green-200' 
                      : 'bg-red-50 border-red-200'
                  }`}>
                    <div className={`text-sm font-medium ${
                      dublishResult.success ? 'text-green-800' : 'text-red-800'
                    }`}>
                      {dublishResult.message}
                    </div>
                    
                    {dublishResult.success && dublishResult.wpEditorUrl && dublishResult.liveUrl && (
                      <div className="mt-3 space-y-2">
                        <a
                          href={dublishResult.wpEditorUrl}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="block w-full px-3 py-2 bg-blue-600 text-white text-center rounded text-sm hover:bg-blue-700 transition-colors"
                        >
                          üîß Edit in Elementor (Post ID: {dublishResult.postId})
                        </a>
                        <a
                          href={dublishResult.liveUrl}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="block w-full px-3 py-2 bg-green-600 text-white text-center rounded text-sm hover:bg-green-700 transition-colors"
                        >
                          üåê View Live Page
                        </a>
                      </div>
                    )}
                  </div>
                )}
                
                <div className="text-xs text-gray-600 mt-2">
                  create new page on asn_sitespren_base from defined data (such as pelementor_edits field in some cases, etc.)
                </div>
              </div>

              {/* NEW AREA 4: Snoverride Function Box */}
              <div className="bg-gray-50 border border-gray-300 rounded-lg p-4" style={{ width: '450px' }}>
                <div className="mb-3">
                  <strong className="text-sm font-bold text-gray-700">
                    Update existing elementor page using snoverride function
                  </strong>
                </div>
                
                <hr className="my-3 border-gray-300" />
                
                <div className="mb-3">
                  <button
                    onClick={handleRunSnoverride}
                    disabled={isRunningSnoverride || !gconPiece?.pelementor_edits || !gconPiece?.asn_sitespren_base || !gconPiece?.g_post_id}
                    className={`w-full px-4 py-2 text-white rounded transition-colors ${
                      isRunningSnoverride || !gconPiece?.pelementor_edits || !gconPiece?.asn_sitespren_base || !gconPiece?.g_post_id
                        ? 'bg-gray-400 cursor-not-allowed'
                        : 'bg-black hover:bg-gray-800'
                    }`}
                    style={{
                      fontSize: '14px'
                    }}
                  >
                    {isRunningSnoverride ? (
                      <div className="flex items-center justify-center gap-2">
                        <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                        Updating...
                      </div>
                    ) : (
                      'run snoverride'
                    )}
                  </button>
                </div>

                {/* Connection Type Selector */}
                <div className="mb-3">
                  <label className="block text-xs font-bold text-gray-700 mb-2">
                    Connection Type:
                  </label>
                  <select
                    value={snoverrideConnectionType}
                    onChange={(e) => setSnoverrideConnectionType(e.target.value as 'snefuruplin' | 'rest_api' | 'api_other')}
                    disabled={isRunningSnoverride}
                    className="w-full px-3 py-2 border border-gray-300 rounded text-sm bg-white disabled:bg-gray-100"
                  >
                    <option value="snefuruplin">Snefuruplin WP Plugin</option>
                    <option value="rest_api">REST API</option>
                    <option value="api_other">API (other)</option>
                  </select>
                </div>

                {/* Progress Indicator */}
                {snoverrideProgress && (
                  <div className="mb-3 p-2 bg-blue-50 border border-blue-200 rounded">
                    <div className="text-xs text-blue-800">
                      <strong>Status:</strong> {snoverrideProgress}
                    </div>
                    {isRunningSnoverride && (
                      <div className="mt-2">
                        <div className="w-full bg-blue-200 rounded-full h-2">
                          <div className="bg-blue-600 h-2 rounded-full animate-pulse" style={{ width: '60%' }}></div>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Results Section */}
                {snoverrideResult && (
                  <div className={`mb-3 p-3 border rounded ${
                    snoverrideResult.success 
                      ? 'bg-green-50 border-green-200' 
                      : 'bg-red-50 border-red-200'
                  }`}>
                    <div className={`text-sm font-medium ${
                      snoverrideResult.success ? 'text-green-800' : 'text-red-800'
                    }`}>
                      {snoverrideResult.message}
                    </div>
                    
                    {snoverrideResult.success && snoverrideResult.wpEditorUrl && snoverrideResult.liveUrl && (
                      <div className="mt-3 space-y-2">
                        <a
                          href={snoverrideResult.wpEditorUrl}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="block w-full px-3 py-2 bg-blue-600 text-white text-center rounded text-sm hover:bg-blue-700 transition-colors"
                        >
                          üîß Edit in Elementor (Post ID: {snoverrideResult.postId})
                        </a>
                        <a
                          href={snoverrideResult.liveUrl}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="block w-full px-3 py-2 bg-green-600 text-white text-center rounded text-sm hover:bg-green-700 transition-colors"
                        >
                          üåê View Updated Page
                        </a>
                      </div>
                    )}
                  </div>
                )}
                
                <div className="text-xs text-gray-600 mt-2">
                  {gconPiece?.g_post_id ? (
                    <span>
                      Update existing post ID: <strong>{gconPiece.g_post_id}</strong> on {gconPiece.asn_sitespren_base}
                    </span>
                  ) : (
                    <span className="text-red-600">
                      No g_post_id found - cannot update without target post ID
                    </span>
                  )}
                </div>
              </div>
            </div>
          </div>
        )}
        
        <h1 className="text-2xl font-bold mb-6">Torya</h1>
        {gconPieceId && (
          <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
            <p className="text-sm text-blue-800">
              <strong>gcon_piece_id:</strong> {gconPieceId}
              {gconPiece?.asn_sitespren_base && (
                <span className="ml-4">
                  <strong>Site:</strong> {gconPiece.asn_sitespren_base}
                </span>
              )}
            </p>
          </div>
        )}
        <WaterTable 
          gconPieceId={gconPieceId} 
          isTopAreaOpen={isTopAreaOpen}
          handleAccordionToggle={handleAccordionToggle}
          gconPiece={gconPiece}
          isRunningF22={isRunningF22}
          f22Report={f22Report}
          handleRunF22={handleRunF22}
          handleCopyPelementorCached={handleCopyPelementorCached}
          handleCopyPelementorEdits={handleCopyPelementorEdits}
          handleCopyF22Report={handleCopyF22Report}
          onGetManualImageData={manualImageDataRef}
        />
      </div>
    </div>
  );
}
```

Result:

```
File created successfully at: /Users/kylecampbell/Documents/repos/localrepo-snefuru4/app/(protected)/torya/pclient.tsx
```

